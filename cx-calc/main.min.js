// @ts-nocheck
const rows=5,cols=4,container=document.querySelector(".calculator-container"),displaylv=document.querySelector("#levInput"),display=document.querySelector("#eurInput");var calculator=null,calcBottom=0,screenWidth=window.innerWidth,imageWidth,imageHeight,aspectRatioW,aspectRatioH,imageWidthO,imageHeightO,userInput="",ovFlag=!1,fullscrFlag=!1,keys=displayCoords=[],Mem=[0,0,0,0],levMode=!0,isStandalone=!1,MainPoints={};let modalIsActive=!1;var showWarning=!1;let audioContext,clickBuffer=null;const MAX_HISTORY_ITEMS=30,historyButton=document.getElementById("historyButton"),recallButton=document.getElementById("recallButton"),settingsModal=document.getElementById("settingsModal"),historyList=document.getElementById("historyList"),closeHistoryModalButton=document.getElementById("closeHistoryModalButton"),closeHelpModalButton=document.getElementById("closeHelpModalButton");var MainPointsO={Keys:{x:43,y:235},KeySize:{x:84,y:70},KbdGaps:{x:13,y:13},Display:{x:102,y:33},Displaylv:{x:102,y:110},DisplaySize:{x:312,y:57},Status:{x:-10,y:185},StatusSize:{x:45,y:15},CurrencyOffset:{x:-40,y:15},CurrencyLevOffset:{x:-40,y:15}};const defaultSettings={exchangeRate:1.95583,currencySymbol:"€",currencyLevSymbol:"лв.",soundEffectsEnabled:!1,showRateWarningEnabled:!0,calcBottomOffset:0,initialDisplay:"lev",pwaInstallDeclined:!1,calculatorSkin:"Calculator0.png"};var EXCHANGE_RATE=defaultSettings.exchangeRate,CURRENCY_SYMBOL=defaultSettings.currencySymbol,CURRENCY_LEV_SYMBOL=defaultSettings.currencyLevSymbol,showRateWarningEnabled=defaultSettings.showRateWarningEnabled,soundEffectsEnabled=defaultSettings.soundEffectsEnabled;function saveSettings(){for(const e in MainPointsO)if(MainPointsO.hasOwnProperty(e)){const t=MainPointsO[e];if("object"==typeof t&&null!==t)for(const n in t)if(t.hasOwnProperty(n)){const l=e.toLowerCase()+n.toUpperCase(),o=document.getElementById(l);if(o){const e=parseFloat(o.value);isNaN(e)||(t[n]=e)}}}localStorage.setItem("MainPointsO",JSON.stringify(MainPointsO));const e=JSON.parse(localStorage.getItem("appSettings"))||defaultSettings,t={exchangeRate:parseFloat(document.getElementById("exchangeRateInput").value)||defaultSettings.exchangeRate,currencySymbol:document.getElementById("currencySymbolInput").value.trim()||defaultSettings.currencySymbol,currencyLevSymbol:document.getElementById("currencyLevSymbolInput").value.trim()||defaultSettings.currencyLevSymbol,showRateWarningEnabled:document.getElementById("rateWarningCheckbox").checked,soundEffectsEnabled:document.getElementById("soundEffectsCheckbox").checked,calcBottomOffset:parseInt(document.getElementById("calcBottomOffset").value,10)||0,initialDisplay:document.getElementById("initialDisplayLev").checked?"lev":"eur",pwaInstallDeclined:e.pwaInstallDeclined||defaultSettings.pwaInstallDeclined,calculatorSkin:e.calculatorSkin||defaultSettings.calculatorSkin};localStorage.setItem("appSettings",JSON.stringify(t)),console.log("Настройките са запазени. Страницата ще бъде презаредена."),location.reload()}function populateLayoutSettings(){for(const e in MainPointsO)if(MainPointsO.hasOwnProperty(e)){const t=MainPointsO[e];if("object"==typeof t&&null!==t)for(const n in t)if(t.hasOwnProperty(n)){const l=e.toLowerCase()+n.toUpperCase(),o=document.getElementById(l);o?o.value=t[n]:console.warn(`Input element with ID '${l}' not found for MainPointsO.${e}.${n}`)}}const e=document.getElementById("exchangeRateInput");e&&(e.value=EXCHANGE_RATE);const t=document.getElementById("calcBottomOffset");if(t){const e=getComputedStyle(document.documentElement).getPropertyValue("--calc-bottom-offset").trim()||"0px";t.value=parseInt(e,10)}const n=document.getElementById("currencySymbolInput");n&&(n.value=CURRENCY_SYMBOL);const l=document.getElementById("currencyLevSymbolInput");l&&(l.value=CURRENCY_LEV_SYMBOL);const o=document.getElementById("rateWarningCheckbox");o&&(o.checked=showRateWarningEnabled);const a=document.getElementById("soundEffectsCheckbox");a&&(a.checked=soundEffectsEnabled)}function loadSettings(){const e=JSON.parse(localStorage.getItem("appSettings")),t={...defaultSettings,...e};EXCHANGE_RATE=t.exchangeRate,CURRENCY_SYMBOL=t.currencySymbol,CURRENCY_LEV_SYMBOL=t.currencyLevSymbol,showRateWarningEnabled=t.showRateWarningEnabled,soundEffectsEnabled=t.soundEffectsEnabled,calcBottom=t.calcBottomOffset,levMode="lev"===t.initialDisplay;const n=JSON.parse(localStorage.getItem("CalcMem"));n&&Array.isArray(n)&&(Mem=n),calculator&&t.calculatorSkin&&(calculator.src=t.calculatorSkin),document.documentElement.style.setProperty("--calc-bottom-offset",`${calcBottom}px`),EXCHANGE_RATE!==defaultSettings.exchangeRate&&(showWarning=!0);const l=localStorage.getItem("MainPointsO");if(l){const e=JSON.parse(l);for(const t in MainPointsO)e[t]&&Object.assign(MainPointsO[t],e[t]);console.log("Заредени и допълнени MainPointsO от loadSettings():")}}function getImageSize(){calculator?(imageWidthO=calculator.naturalWidth,imageHeightO=calculator.naturalHeight):console.log("Изображението не е намерено!")}function getImageVisualSize(){let e=document.body.clientWidth,t=document.body.clientHeight;if(!calculator)return void console.error("Грешка: Не е намерено изображението.");let n=calculator.naturalWidth/calculator.naturalHeight;"cover"===calculator.style.objectFit?(imageWidth=e,imageHeight=t):"contain"===calculator.style.objectFit?e/t>n?(imageHeight=t,imageWidth=Math.round(t*n),console.log("(contain) - Изображението е по-широко от контейнера, използваме височината на контейнера.")):(imageWidth=e,imageHeight=Math.round(e/n),console.log("(contain) - Изображението е по-високо от контейнера, използваме ширината на контейнера.")):(imageWidth=calculator.width,imageHeight=calculator.height),aspectRatioW=imageWidth/imageWidthO,aspectRatioH=imageHeight/imageHeightO,console.log("aspectRatioW = ",aspectRatioW,"   aspectRatioH = ",aspectRatioH)}function getKeyValue(e,t){return[["L","€","C","B"],["7","8","9","/"],["4","5","6","*"],["1","2","3","-"],["0",",","=","+"]][e][t]}function formatNumber(e){return isNaN(e)?"":e.toFixed(2).replace(".",",")}function parseNumber(e){return e?(e=e.replace(/\s+/g,""),parseFloat(e.replace(",","."))):NaN}function convertFromLevToEur(e){let t=parseNumber(e);if(isNaN(t))return"";return formatNumber(t/EXCHANGE_RATE)}function convertFromEurToLev(e){let t=parseNumber(e);if(isNaN(t))return"";return formatNumber(t*EXCHANGE_RATE)}function groupByThree(e,t){if(null==e||""==e)return"";let n=e.replace(/\s+/g,"").split(","),l=n[0];""==l&&(l="0");let o=n.length>1?","+n[1]:"",a=[];for(let e=l.length;e>0;e-=3){let t=Math.max(e-3,0);a.unshift(l.slice(t,e))}return t&&(""===o||","===o?o=",00":2===o.length&&(o+="0")),a=a.join(" ")+o,a=a.replace(/^-\s(?=\d)/,"-"),a}function canAddCharacter(e,t){return!/(\d+,\d{2})(?![+\-*/])/.test(e)||!/\d/.test(t)}function updateDisplays(e,t,n){const l=/[+\-*/]/.test(e.slice(1))||e.includes("(")||e.includes(")"),[o,a]=levMode?[displaylv,display]:[display,displaylv],s=levMode?convertFromLevToEur:convertFromEurToLev;let r;if(o.classList.add("active-display"),a.classList.remove("active-display"),""===e)r="";else if(l)r=t;else{const t=e.includes(","),l=t?e.split(",")[1]:"",o=!t;r="B"===n?groupByThree(e,!!o):o||0===l.length||1===l.length?groupByThree(e,!0):groupByThree(e,!1)}if(o.textContent=r,l)a.textContent="";else{const t=s(e);a.textContent=groupByThree(t,!0)}adjustFontSize(o,a)}function toggleDisplayMode(){const e=(levMode=!levMode)?displaylv.textContent:display.textContent;(userInput=e.replace(/\s/g,"")).endsWith(",00")&&(userInput=userInput.slice(0,-3)),console.log("Променен режим - userInput:",userInput),updateDisplays(userInput,userInput.replace(/\*/g,"×").replace(/\//g,"÷"),"L")}function balanceBrackets(e){let t=0;for(const n of e)"("===n?t++:")"===n&&t--;return e+")".repeat(Math.max(0,t))}function addImplicitMultiplication(e){return e.replace(/(\d)(?=\()/g,"$1*").replace(/(?<=\))(\d)/g,"*$1").replace(/\)\(/g,")*(")}function appendNumber(value){var oldUserInput="";const display=document.getElementById("eurInput"),displaylv=document.getElementById("levInput");if("€"===value)return void historyOpen();if("L"===value)return void toggleDisplayMode();if("C"===value)display.textContent="",displaylv.textContent="",userInput="";else if("B"===value)userInput=userInput.slice(0,-1);else if("="===value){if(!/[+\-*/]$/.test(userInput)&&userInput.length>0)try{let formattedInput=userInput.replace(/,/g,".");oldUserInput=userInput.replace(/\*/g,"×").replace(/\//g,"÷").replace(/,/g,"."),formattedInput=addImplicitMultiplication(balanceBrackets(formattedInput));let result=eval(formattedInput);result=parseFloat(result).toFixed(2),userInput=result.toString().replace(/\./g,","),navigator.clipboard.writeText(userInput).then((()=>{console.log("Резултатът е копиран в клипборда! ✅")})).catch((e=>{console.error("Грешка при копиране в клипборда:",e)}))}catch(e){console.error("Грешка в изчисленията",e)}}else{const lastOperatorIndex=Math.max(userInput.lastIndexOf("+"),userInput.lastIndexOf("-"),userInput.lastIndexOf("*"),userInput.lastIndexOf("/")),currentNumber=-1===lastOperatorIndex?userInput:userInput.slice(lastOperatorIndex+1);if(","===value&&currentNumber.includes(","))return;if((/\d/.test(value)||","===value)&&currentNumber.includes(",")){const e=currentNumber.split(",")[1]||"";if(e.length>=2)return}if(/[+\-*/]/.test(value)&&(0===userInput.length||/[+\-*/]$/.test(userInput)))return;let match=userInput.match(/([\d,]+[+\-*/])([\d,]+)/);if(match&&/[+\-*/]/.test(value))try{let formattedInput=userInput.replace(/,/g,".");oldUserInput=userInput.replace(/\*/g,"×").replace(/\//g,"÷").replace(/,/g,"."),formattedInput=addImplicitMultiplication(balanceBrackets(formattedInput)),console.log("2-Изчисляване на:",formattedInput);let result=eval(formattedInput);userInput=parseFloat(result).toFixed(2).replace(/\./g,",")+value;let levValue=parseNumber(displaylv.textContent),eurValue=parseNumber(display.textContent);addHistoryEntry(oldUserInput,result,"no")}catch(e){console.error("Грешка в изчисленията",e)}else canAddCharacter(userInput,value)&&(userInput+=value)}const formattedUserInput=userInput.replace(/\*/g,"×").replace(/\//g,"÷");if(updateDisplays(userInput,formattedUserInput,value),"="===value){let e=parseNumber(displaylv.textContent),t=parseNumber(display.textContent);""!==e&&""!==t&&addHistoryEntry(oldUserInput,e,t)}userInput.endsWith(",00")&&(userInput=userInput.slice(0,-3)),console.log("userInput = ",userInput)}function getKeyColumnIndex(e){const t=calculator.getBoundingClientRect(),n=MainPoints.KeySize.x+MainPoints.KbdGaps.x,l=(e.x-t.left-MainPoints.Keys.x)/n;return Math.round(l+1)}function controlActions(key){if("+"===key.value)fullscrFlag?exitFullscreen():goFullscreen(),fullscrFlag=!fullscrFlag;else if("*"===key.value)console.log("Before %: ",userInput),userInput=userInput.replace(",","."),userInput=eval(userInput),userInput=(parseFloat(userInput)/100).toFixed(2).replace(".",","),appendNumber("=");else if("-"===key.value){if(/[+\-*/]$/.test(userInput))return;if(userInput=userInput.startsWith("-")?userInput.slice(1):"-"+userInput,userInput=userInput.replace(",","."),/[+\-*/]$/.test(userInput))return;userInput=eval(userInput),userInput=parseFloat(userInput).toFixed(2).replace(".",","),appendNumber("=")}}async function initAudio(){if(soundEffectsEnabled)try{audioContext=new(window.AudioContext||window.webkitAudioContext);const e=await fetch("click.wav"),t=await e.arrayBuffer();clickBuffer=await audioContext.decodeAudioData(t),console.log("Аудио файлът е кеширан и готов за възпроизвеждане.")}catch(e){console.error("Web Audio API не се поддържа или възникна грешка при инициализация.",e),soundEffectsEnabled=!1}}function playClickSound(){if(!soundEffectsEnabled||!clickBuffer||!audioContext)return;"suspended"===audioContext.state&&audioContext.resume();const e=audioContext.createBufferSource();e.buffer=clickBuffer,e.connect(audioContext.destination),e.start(0)}function getKeyDimensions(){const e=calculator.getBoundingClientRect(),t=e.width/imageWidthO,n=e.height/imageHeightO;return{keyWidth:MainPointsO.KeySize.x*t,keyHeight:MainPointsO.KeySize.y*n}}function isWithinKeyBounds(e,t,n,l){return e.clientX>=t.x&&e.clientX<=t.x+n&&e.clientY>=t.y&&e.clientY<=t.y+l}function handleStatusZones(e,t){for(let n=1;n<=4;n++){const l=document.getElementById(`statusArea${n}`);if(l&&getComputedStyle(l).opacity>0){const o=l.getBoundingClientRect(),a=e.clientX>=o.left&&e.clientX<=o.right&&e.clientY>=o.top&&e.clientY<=o.bottom;if(a&&4==n)return t?memoryShow(4):(helpModal.style.display="flex",modalIsActive=!0),!0;if(a)return t?memoryShow(n):memoryRecall(n),!0}}return!1}function sanitizeAndEvaluateInput(input,operationType){if(/[+\-*/]$/.test(input))return null;input=input.replace(",",".");let result=eval(input);return"percent"===operationType?result/=100:"negate"===operationType&&(result=input.startsWith("-")?input.slice(1):"-"+input,result=eval(result)),parseFloat(result).toFixed(2).replace(".",",")}function goFullscreen(){const e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}function exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}function toggleFullscreen(){fullscrFlag?exitFullscreen():goFullscreen(),fullscrFlag=!fullscrFlag}function clearAllMemory(){for(let e=1;e<4;e++)Mem[e]=0,clearStatus(e);localStorage.setItem("CalcMem",JSON.stringify(Mem))}async function pasteNumber(){try{const e=await navigator.clipboard.readText(),t=e.replace(/(?<=\d)\s+(?=\d)/g,"").match(/-?\d+[.,]?\d*/);if(t){let e=t[0].replace(",","."),n=parseFloat(e).toFixed(2).replace(".",",");const l=n.slice(-1),o=n.slice(0,-1);userInput=o,appendNumber(l)}else console.warn("Не е намерено валидно число в клипборда.")}catch(e){console.error("Грешка при достъп до клипборда:",e)}}function switchNumber(){appendNumber("="),appendNumber("C"),appendNumber("L"),pasteNumber()}function allClear(){appendNumber("C"),userInput="",Mem=[0,0,0,0],localStorage.setItem("CalcMem",JSON.stringify(Mem)),document.getElementById("clearHistoryButton").click()}function handleCalculatorInteraction(e,t={}){if(modalIsActive)return;let n=!1;const{keyWidth:l,keyHeight:o}=getKeyDimensions();if(keys.forEach((a=>{if(isWithinKeyBounds(e,a,l,o)){n=!0;const l=a.value;if((e.ctrlKey||t.allowWithoutCtrl)&&"€"===l)ovFlag&&(noOverlay(),ovFlag=!1),settingsModal.style.display="flex",modalIsActive=!0,populateLayoutSettings();else if((e.ctrlKey||t.allowWithoutCtrl)&&"B"===l)clearAllMemory();else if((e.ctrlKey||t.allowWithoutCtrl)&&"0"===l)appendNumber("(");else if((e.ctrlKey||t.allowWithoutCtrl)&&","===l)appendNumber(")");else if((e.ctrlKey||t.allowWithoutCtrl)&&"+"===l)toggleFullscreen();else if((e.ctrlKey||t.allowWithoutCtrl)&&"/"===l)pasteNumber();else if((e.ctrlKey||t.allowWithoutCtrl)&&"L"===l)switchNumber();else if((e.ctrlKey||t.allowWithoutCtrl)&&"C"===l)allClear();else if((e.ctrlKey||t.allowWithoutCtrl)&&"*"===l){const e=sanitizeAndEvaluateInput(userInput,"percent");null!==e&&(userInput=e,appendNumber("="))}else if((e.ctrlKey||t.allowWithoutCtrl)&&"-"===l){const e=sanitizeAndEvaluateInput(userInput,"negate");null!==e&&(userInput=e,appendNumber("="))}else if((e.ctrlKey||t.allowWithoutCtrl)&&isMemoryKey(l)){const e=getKeyColumnIndex(a);executeMemoryAction(l,e)}else appendNumber(l)}})),handleStatusZones(e,e.ctrlKey||t.allowWithoutCtrl)&&(n=!0),!n){const t=document.getElementById("levInput"),l=document.getElementById("eurInput"),o=t.getBoundingClientRect(),a=l.getBoundingClientRect(),s=e.clientX>=o.left&&e.clientX<=o.right&&e.clientY>=o.top&&e.clientY<=o.bottom,r=e.clientX>=a.left&&e.clientX<=a.right&&e.clientY>=a.top&&e.clientY<=a.bottom;(s||r)&&(toggleDisplayMode(),n=!0)}if(!n&&(e.ctrlKey||t.allowWithoutCtrl)){const t=document.getElementById("calculatorContainer").getBoundingClientRect();(e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom)&&confirm("Сигурни ли сте, че искате да върнете първоначалните настройки?")&&("function"==typeof clearHistory&&(clearHistory(),console.log("Историята е изтрита.")),localStorage.removeItem("MainPointsO"),localStorage.removeItem("appSettings"),console.log("Всички запазени настройки (MainPointsO, appSettings) са изтрити."),location.reload())}n&&playClickSound()}function showOv(){if(ovFlag)noOverlay(),ovFlag=!1;else{const e=calcNewCoordinates();displayCoords=e.displayCoords,placeKeys(keys,displayCoords),ovFlag=!0}settingsModal.style.display="none",setTimeout((()=>{modalIsActive=!1}),0)}function closeHelpModal(e){helpModal.style.display="none",setTimeout((()=>{modalIsActive=!1}),0),e.stopPropagation(),e.preventDefault()}document.addEventListener("click",(function(e){handleCalculatorInteraction(e)})),document.addEventListener("contextmenu",(function(e){e.preventDefault(),handleCalculatorInteraction(e,{allowWithoutCtrl:!0})})),document.getElementById("saveSettings").addEventListener("click",(function(e){saveSettings(),settingsModal.style.display="none",setTimeout((()=>{modalIsActive=!1}),0),e.stopPropagation(),e.preventDefault()})),document.getElementById("closeSettingsModalButton").addEventListener("click",(function(e){settingsModal.style.display="none",setTimeout((()=>{modalIsActive=!1}),0),e.stopPropagation(),e.preventDefault()})),window.addEventListener("load",(function(){try{calculator=document.querySelector(".calculator-img"),getImageSize(),getImageVisualSize(),scaleMainPoints(aspectRatioW,aspectRatioH);const e=calcNewCoordinates();if(keys=e.keys,displayCoords=e.displayCoords,resizeFont(),loadSettings(),initAudio(),document.getElementById("currency").textContent=CURRENCY_SYMBOL,document.getElementById("currencyLev").textContent=CURRENCY_LEV_SYMBOL,showWarning&&showRateWarningEnabled){const e=document.getElementById("exchangeRateWarning");e.style.display="flex",modalIsActive=!0,document.getElementById("exchangeRateChangeBtn").onclick=function(){const e=JSON.parse(localStorage.getItem("appSettings"))||defaultSettings;e.exchangeRate=defaultSettings.exchangeRate,localStorage.setItem("appSettings",JSON.stringify(e)),modalIsActive=!1,location.reload()},document.getElementById("exchangeRateConfirmBtn").onclick=function(){e.style.display="none",modalIsActive=!1}}for(let e=1;e<=3;e++)void 0!==Mem[e]&&null!==Mem[e]&&0!==Mem[e]&&memoryAdd(e,"+")}catch(e){console.warn("⚠️ Грешка при инициализация:",e)}document.body.classList.add("ready"),appendNumber("C")})),document.addEventListener("DOMContentLoaded",(()=>{document.addEventListener("keydown",(e=>{const key=e.key;if("Escape"===key||"Esc"===key)return historyModal.style.display="none",helpModal.style.display="none",settingsModal.style.display="none",void(modalIsActive=!1);if(modalIsActive)return;if(["Enter","/","*","(",")"].includes(key)&&e.preventDefault(),"%"===key){if(/[+\-*/]$/.test(userInput))return;return userInput=userInput.replace(",","."),userInput=eval(userInput),userInput=(parseFloat(userInput)/100).toFixed(2).replace(".",","),void appendNumber("=")}const keyMap={Enter:"=","=":"=",Backspace:"B",Delete:"B",",":",",".":",",c:"C",C:"C","(":"(",")":")"};keyMap[key]?appendNumber(keyMap[key]):"0123456789+-*/".includes(key)&&appendNumber(key)})),loadHistory(),adjustFontSize(levInput,eurInput),isStandalone=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone,appendNumber("C")})),window.addEventListener("resize",(function(e){getImageVisualSize(),scaleMainPoints(aspectRatioW,aspectRatioH);const t=calcNewCoordinates();keys=t.keys,displayCoords=t.displayCoords,adjustFontSize(levInput,eurInput)})),closeHelpModalButton&&closeHelpModalButton.addEventListener("click",closeHelpModal),closeHelpModalButtonTop&&closeHelpModalButtonTop.addEventListener("click",closeHelpModal);