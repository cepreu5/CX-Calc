<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8"/>
  <title>EUR ↔ BGN Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#1e293b"/>
  <link rel="shortcut icon" type="image/png" href="KimiFav.png" />
  <link rel="manifest" href="kimimanif.json"/>

  <style>
    html {
      /* Задаваме базов размер, за да са консистентни rem единиците. 12px е по-малко от стандартното 16px, но отговаря на вашето желание. */
      font-size: 14px;
    }

    :root{
      /*--bg:#4e0404;*/
      /*--text:#111827;*/

      --page:#4e0404;
      --calc:#BBB5B1;
      --btn:#3a3938;
      --btn-text:#ffffff;
      --btn-op:#e77023;

      --btn-c:#787878;
      --btn-del:#c80000;

      --display-bg:#58584a;
      --display-text:#f0fc03;
      --expr-bg:#b0b0b0;        /* цвят на фона на горния дисплей */
      --expr-text:#000000;      /* цвят на шрифта на горния дисплей */

      --accent:#3b82f6;
      --font:2rem;
      --dec:2;
      --rate:1.95583;
    }

    *{
      box-sizing:border-box;
      /* Използваме по-прост набор от шрифтове за по-голяма консистентност между платформите */
      font-family:Arial,Helvetica,sans-serif;
      user-select:none
    }

    body{
      margin:0;
      background:var(--page);
      display:flex;
      justify-content:center;
      align-items:center;   /* вертикално центриране */
      min-height:100vh;
      padding:.5rem;
    }

    #calcWrap{
      background:var(--calc);
      border:3px solid #9ca3af;
      border-radius:12px;
      padding:.5rem;
      box-shadow:0 0 20px rgba(0,0,0,.15);
      width:100%;
      max-width:400px;
    }

    #calc{
      width:100%}

    #expr, #result {
      height:3rem;
      font-size:var(--font);
      text-align:right;
      padding:.5rem;
      border-radius:.5rem;
      background:var(--display-bg);
      color:var(--display-text);
      margin-bottom:.25rem;
      overflow:hidden;
      word-break:break-all
    }

    #expr {
      height:auto;
      min-height:3rem;
      font-size:calc(var(--font)*.9);
      white-space:pre-wrap
    }

    #result {
      font-weight: bold;
      font-size: calc(var(--font)*1.2);
      text-align: right;
      padding-right: .5rem;
      padding-top: 0rem;
      border-radius: .5rem;
      background: var(--display-bg);
      color: var(--display-text);
      margin-bottom: .25rem;
      min-height: 3rem; /* Минималната височина */
    }

    button {
      padding: .75rem;
      border: none;
      border-radius: .5rem;
      font-size: calc(var(--font) * .9);
      background: var(--btn);
      color: var(--btn-text);
      cursor: pointer;
      box-shadow: 0 4px #0003;
      transform: translateY(-2px);
      transition: .1s;
      font-weight: bold; /* Добавете bold */
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px #0002;
    }

    button.op {
      background:var(--btn-op)}
    
    button.c {
      background:var(--btn-c)}
    
    button.del {
      background:var(--btn-del);}

    .grid {
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:.5rem;
      margin-top:.5rem
    }

    .fullBtn {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:.5rem;
      margin:.5rem 0
    }

    #settings, #history {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:var(--calc);
      padding:1rem;
      z-index:9;
      display:none;
      flex-direction:column;
      gap:.5rem;
      overflow-y:auto
    }

    #settings h2, #history h2 {
      margin:.2rem 0 .5rem}

    #historyList button {
      display:block;
      width:100%;
      text-align:left;
      margin-bottom:.25rem;
      padding:.4rem
    }

    label {
      display:flex;
      justify-content:space-between;
      align-items:center
    }

    input[type=range] {width:50%}

    input[type=color] {
      width:30px;
      height:30px;
      border:none;
      border-radius:4px
    }

    #memoryInd {
      display:flex;
      justify-content:space-around;
      font-size:.8rem;
      margin-bottom:.25rem
    }

    #expr {
      background:var(--expr-bg);
      color:var(--expr-text);
    }

    .icon-btn {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.6rem; /* Леко намален padding за икони */
    }

    .icon-btn svg {
      width: 1.2em; /* Размер на иконата спрямо шрифта на бутона */
      height: 1.2em;
    }
  </style>
</head>

<body>
<div id="install-bar" style="display: none; position: fixed; bottom: 0; width: 100%; background: #333; color: white; padding: 1em; text-align: center; z-index: 1000; font-size: 1rem; box-shadow: 0 -2px 5px rgba(0,0,0,0.2);">
  <span style="margin-right: 1em;">Инсталиране на приложението за офлайн достъп?</span>
  <button id="install-button" style="margin-left: 1em; padding: 0.5em 1em; cursor: pointer; border-radius: 5px; border: none; background: #4CAF50; color: white;">Инсталиране</button>
  <button id="dismiss-button" style="margin-left: 0.5em; padding: 0.5em 1em; cursor: pointer; border-radius: 5px; border: none; background: #555; color: white;">Отказ</button>
</div>
<div id="calcWrap">
  <div id="calc">
    <div id="expr" contenteditable="false" spellcheck="false"></div>
    <div id="result">0&nbsp;<span id="unit"></span></div>
    <div id="memoryInd">
      <span id="m1"></span><span id="m2"></span><span id="m3"></span>
    </div>
    <div class="fullBtn">
      <button onclick="convert('EUR')" class="op">€ → лв</button>
      <button onclick="convert('BGN')">лв → €</button>
    </div>
    <div class="grid">
    <button class="icon-btn c" onclick="toggleSettings()" title="Настройки">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM19.43 12.98c.04-.32.07-.65.07-.98s-.03-.66-.07-.98l2.11-1.65a.5.5 0 0 0 .12-.65l-2-3.46a.5.5 0 0 0-.6-.22l-2.49 1a7.031 7.031 0 0 0-1.7-.98l-.38-2.65a.5.5 0 0 0-.5-.42h-4a.5.5 0 0 0-.5.42l-.38 2.65a7.031 7.031 0 0 0-1.7.98l-2.49-1a.5.5 0 0 0-.6.22l-2 3.46a.5.5 0 0 0 .12.65l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65a.5.5 0 0 0-.12.65l2 3.46c.14.24.44.34.7.22l2.49-1c.53.38 1.12.7 1.7.98l.38 2.65c.04.26.26.42.5.42h4c.26 0 .46-.16.5-.42l.38-2.65c.58-.28 1.17-.6 1.7-.98l2.49 1c.26.12.56.02.7-.22l2-3.46a.5.5 0 0 0-.12-.65l-2.11-1.65z"/>
        <!-- Централна "дупка" за оста -->
        <circle cx="12" cy="12" r="2.5" fill="var(--btn-c)" />
      </svg>
    </button>
    <button class="icon-btn" onclick="toggleHistory()" title="История">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <!-- Контур на листа -->
        <rect x="4" y="3" width="16" height="18" rx="2" ry="2" stroke="#000" stroke-width="1.5"/>
        <!-- Горна гънка >
        <path d="M20 6h-5V3" fill="#eee"/-->
        <!-- Редове -->
        <line x1="6" y1="7" x2="18" y2="7" stroke="#888" stroke-width="1"/>
        <line x1="6" y1="10" x2="18" y2="10" stroke="#888" stroke-width="1"/>
        <line x1="6" y1="13" x2="18" y2="13" stroke="#888" stroke-width="1"/>
        <line x1="6" y1="16" x2="18" y2="16" stroke="#888" stroke-width="1"/>
      </svg>
    </button>
    <button onclick="act('⌫')" class="del">⌫</button>
    <button onclick="numClick(event,'C')" onpointerdown="long(event,'C')" onpointerup="clearLong()" oncontextmenu="return false" class="c">C</button>

    <button onclick="numClick(event,'7')" onpointerdown="long(event,'7')" onpointerup="clearLong()" oncontextmenu="return false">7</button>
    <button onclick="numClick(event,'8')" onpointerdown="long(event,'8')" onpointerup="clearLong()" oncontextmenu="return false">8</button>
    <button onclick="numClick(event,'9')" onpointerdown="long(event,'9')" onpointerup="clearLong()" oncontextmenu="return false">9</button>
    <button onclick="act('/')" class="op">÷</button>

    <button onclick="numClick(event,'4')" onpointerdown="long(event,'4')" onpointerup="clearLong()" oncontextmenu="return false">4</button>
    <button onclick="numClick(event,'5')" onpointerdown="long(event,'5')" onpointerup="clearLong()" oncontextmenu="return false">5</button>
    <button onclick="numClick(event,'6')" onpointerdown="long(event,'6')" onpointerup="clearLong()" oncontextmenu="return false">6</button>
    <button onclick="act('*')" class="op">×</button>

    <button onclick="numClick(event,'1')" onpointerdown="long(event,'1')" onpointerup="clearLong()" oncontextmenu="return false">1</button>
    <button onclick="numClick(event,'2')" onpointerdown="long(event,'2')" onpointerup="clearLong()" oncontextmenu="return false">2</button>
    <button onclick="numClick(event,'3')" onpointerdown="long(event,'3')" onpointerup="clearLong()" oncontextmenu="return false">3</button>
    <button onclick="act('-')" class="op">-</button>

    <button onclick="act('0')">0</button>
    <button onclick="act(',')">,</button>
    <button onclick="act('±')" class="op">±</button>
    <button onclick="act('+')" class="op">+</button>

    <button onclick="act('(')" class="op">(</button>
    <button onclick="act(')')" class="op">)</button>
    <button onclick="act('%')" class="op">%</button>
    <button onclick="act('=')" class="del">=</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settings">
  <h2>Настройки</h2>

  <label>Курс €→лв
    <input type="number" step="0.00001" id="rateInput">
  </label>
  <label>Десетични знаци (основен)
    <input type="number" min="0" max="10" id="decField">
  </label>
  <label>Десетични знаци (история/горен ред)
    <input type="number" min="0" max="10" id="decHUField">
  </label>

  <label>Фон на страницата
    <input type="color" id="bgColor">
  </label>
  <label>Калкулатор
    <input type="color" id="calcColor">
  </label>
  <label><b>Дисплей </b>
    <input type="color" id="displayColor">
  </label>
  <label>Горен дисплей
    <input type="color" id="exprBgColor">
  </label>
  <label>Шрифт на дисплея
    <input type="color" id="displayTextColor">
  </label>
  <label>Шрифт на горен дисплей
    <input type="color" id="exprTextColor">
  </label>
  <label><b>Бутони</b>
    <input type="color" id="btnColor">
  </label>
  <label>Операционни бутони
    <input type="color" id="opColor">
  </label>
  <label>Бутон C (Clear)
    <input type="color" id="cColor">
  </label>
  <label>Бутон ⌫ (Delete)
    <input type="color" id="delColor">
  </label>
  <label>Шрифт на бутоните
    <input type="color" id="btnTextColor">
  </label>
  <button onclick="toggleSettings()">Затвори</button>
</div>

<!-- History Modal -->
<div id="history">
  <h2>История (последни 30)</h2>
  <div id="historyList"></div>
    <div style="display:flex;gap:.5rem;margin-top:.5rem">
    <button onclick="clearHistory()" style="flex:1">Изтрий</button>
    <button onclick="toggleHistory()" style="flex:1">Затвори</button>
    </div>
</div>

<script>
/* ---------- CONFIG ---------- */
let RATE = 1.95583; 
const MAX_HIST = 30;
let expr = '', dec = 2, memory = [0,0,0], unit='', longTimer;
let decHU = 5;   // история + горен ред

const settingsToSave = [
    { id: 'rateInput', key: 'rate', type: 'number' },
    { id: 'decField', key: 'dec', type: 'number' },
    { id: 'decHUField', key: 'decHU', type: 'number' },
    { id: 'bgColor', key: 'bgColor', type: 'color' },
    { id: 'calcColor', key: 'calcColor', type: 'color' },
    { id: 'displayColor', key: 'displayColor', type: 'color' },
    { id: 'btnColor', key: 'btnColor', type: 'color' },
    { id: 'btnTextColor', key: 'btnTextColor', type: 'color' },
    { id: 'opColor', key: 'opColor', type: 'color' },
    { id: 'cColor', key: 'cColor', type: 'color' },
    { id: 'delColor', key: 'delColor', type: 'color' },
    { id: 'displayTextColor', key: 'displayTextColor', type: 'color' },
    { id: 'exprBgColor', key: 'exprBgColor', type: 'color' },
    { id: 'exprTextColor', key: 'exprTextColor', type: 'color' }
];
// {"rate":1.95583,"dec":2,"decHU":5,"bgColor":"#8d918e","calcColor":"#b9b1b1","displayColor":"#639d0c","btnColor":"#45484a","btnTextColor":"#f1e904","opColor":"#e77b23","cColor":"#ee1b1b","delColor":"#e10e0e","displayTextColor":"#f0fc03","exprBgColor":"#336e02","exprTextColor":"#f5f0f0"}

/* ---------- UTILS ---------- */
function toNum(str) {
    if(typeof str==='number') return str;
    // Премахваме интервалите, ако има такива
    str = str.replace(/\s/g, '');
    return parseFloat(str.replace(',', '.'));
}

function toStr(num, digits = decHU){
    const validNum = Number(num);
    if (isNaN(validNum)) {
        // Връщаме форматирана нула, за да сме консистентни
        if (digits === 0) return '0';
        return '0,' + '0'.repeat(digits);
    }
    // 1. Форматираме до фиксиран брой знаци. Резултатът е низ с десетична точка.
    const fixedString = validNum.toFixed(digits);
    // 2. Разделяме на цяла и дробна част
    const parts = fixedString.split('.');
    let integerPart = parts[0];
    const fractionalPart = parts[1];
    // 3. Добавяме разделители за хилядите (интервал) в цялата част.
    integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    // 4. Сглобяваме резултата с десетична запетая, ако има дробна част
    return fractionalPart !== undefined ? integerPart + ',' + fractionalPart : integerPart;
}

function fitFont(){
  const el=result;
  el.style.fontSize='calc(var(--font)*1.2)';
  while(el.scrollWidth>el.clientWidth && parseFloat(getComputedStyle(el).fontSize)>10){
    el.style.fontSize=(parseFloat(getComputedStyle(el).fontSize)-1)+'px';
  }
}

async function clearHistory(){
  const db = await openDB();
  const tx = db.transaction(store,'readwrite');
  tx.objectStore(store).clear();
  historyList.innerHTML='';
}

/* ---------- LONG PRESS ---------- */
function long(e,k){
  e.preventDefault();
  if(['1','2','3'].includes(k)){
    const idx=['1','2','3'].indexOf(k);
    longTimer=setTimeout(()=>{
      memory[idx]+=toNum(result.textContent.replace(unit, ''));
      updateMem();
    },500);
  }else if(['4','5','6'].includes(k)){
    const idx=['4','5','6'].indexOf(k);
    longTimer=setTimeout(()=>{
      memory[idx]-=toNum(result.textContent.replace(unit, ''));
      updateMem();
    },500);
  }else if(['7','8','9'].includes(k)){
    const idx=['7','8','9'].indexOf(k);
    longTimer=setTimeout(()=>{
      expr=toStr(memory[idx], decHU);
      upd();
    },500);
  }else if(k==='C'){
    longTimer=setTimeout(()=>{memory=[0,0,0];updateMem();},500);
  }
}

function clearLong(){clearTimeout(longTimer);}
/* ---------- DB ---------- */
const dbName='calcDB',store='history';
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(dbName,1);
    req.onupgradeneeded=()=>req.result.createObjectStore(store,{keyPath:'id',autoIncrement:true});
    req.onerror=()=>reject(req.error);
    req.onsuccess=()=>resolve(req.result);
  });
}

async function addHist(item){
  const db=await openDB();
  const tx=db.transaction(store,'readwrite');
  tx.objectStore(store).add(item);
  tx.objectStore(store).openCursor(null,'prev').onsuccess=e=>{
    let c=e.target.result,advance=c.value.id-MAX_HIST;
    if(advance>0) tx.objectStore(store).delete(advance);
  };
}

async function getHistory(){
  const db=await openDB();
  return new Promise(res=>{
    const arr=[];
    db.transaction(store).objectStore(store).openCursor(null,'prev').onsuccess=e=>{
      const c=e.target.result;
      if(c){arr.push(c.value);c.continue();}else res(arr);
    };
  });
}

/* ---------- ACTIONS ---------- */
function act(k){
  if(k==='C'){expr=''; unit=''; upd(); return;}
  if(k==='⌫'){expr=expr.slice(0,-1);upd();return;}
  if(k==='±'){expr=expr.startsWith('-')?expr.slice(1):'-'+expr;upd();return;}
  if(k===','){
    if(!expr.includes(',')){expr+=',';upd();}
    return;
  }
  if(k==='=') {unit=''; upd(); calc(); return; }
  if(k==='%'){
    expr=toStr(toNum(expr)/100);upd();return;
  }
  expr+=k;upd();
}

function round(num, digits = dec){
  return Number(num.toFixed(digits));
}

function balanceBrackets(str){
  let open = 0;
  for (const c of str) if (c === '(') open++; else if (c === ')') open--;
  return str + ')'.repeat(Math.max(0, open));
}

function calc(){
  try {
    let balanced = balanceBrackets(expr.replace(/×/g, '*').replace(/÷/g, '/'));
    // Добавяне на имплицитно умножение за случаи като 3(2-1) или (2-1)5
    let processed = balanced
        .replace(/(\d)(?=\()/g, '$1*')   // 3( -> 3*(
        .replace(/(?<=\))(\d)/g, '*$1')   // )3 -> )*3
        .replace(/\)\(/g, ')*(');         // )( -> )*(
    const res = round(Function('"use strict";return ('+processed.replace(/,/g,'.')+')')(), decHU);
    const txt = balanced + ' = ' + toStr(res, decHU);
    addHist({expr:txt,res});
    expr = toStr(res, decHU);
    upd();
  }
  catch {result.textContent='Грешка!';}
}

function upd(){
  expr = String(expr);
  exprDisp.textContent = expr || '0';
  const val = toNum(expr.split(' ')[0] || 0); // Вземаме само числото, без единицата
  const display = isNaN(val) ? '0' : toStr(val, dec);
  result.textContent = `${display} ${unit}`;
  fitFont();
}

/* ---------- CONVERT ---------- */
function convert(dir){
  if(!expr) return;
  const val = toNum(expr);
  if(isNaN(val)) return;
  let res, unitTop;
  if(dir === 'EUR'){
    res = val * RATE;
    unit = 'лв';
    unitTop = '€';
  } else {
    res = val / RATE;
    unit = '€';
    unitTop = 'лв';
  }
  const rounded = round(res, dec); 
  // Добавяне на запис в историята
  const histExpr = `${toStr(val, decHU)} ${unitTop} → ${toStr(rounded, decHU)} ${unit}`;
  addHist({expr: histExpr, res: res}); // Запазваме пълната стойност в историята
  // горен ред:  "10 € →"
  exprDisp.textContent = `${expr} ${unitTop} ↓`;
  // долен ред: "19.56 лв"
  result.textContent   = `${toStr(rounded, dec)} ${unit}`;
  fitFont();
}

/* ---------- UI ---------- */
const exprDisp=document.getElementById('expr');
const result=document.getElementById('result');

function toggleSettings() {//return; // отделни стойности в паметта
    const el = document.getElementById('settings');
    const visible = el.style.display === 'flex';
    if (!visible) {
        loadSettings();  // зареждаме настройките при отваряне
    } else {                                 // затваряме → записваме
        const settingsData = {};
        settingsToSave.forEach(setting => {
            const value = document.getElementById(setting.id).value;
            if (setting.type === 'number') {
                settingsData[setting.key] = parseFloat(value);
            } else if (setting.type === 'color') {
                settingsData[setting.key] = value;
            }
        });
        localStorage.setItem('settings', JSON.stringify(settingsData));
        location.reload();
    }
    el.style.display = visible ? 'none' : 'flex';
}

function toggleHistory(){toggle('history');loadHistory();}

function toggle(id){
  const el=document.getElementById(id);
  el.style.display=el.style.display==='flex'?'none':'flex';
}

function updateMem(){
  ['m1','m2','m3'].forEach((id,i)=>document.getElementById(id).textContent=`M${String.fromCharCode(65+i)}: ${toStr(memory[i], dec)}`);
}

function loadSettings() {
    const savedSettings = JSON.parse(localStorage.getItem('settings')) || {};
    // Зареждаме и прилагаме числените стойности
    RATE = savedSettings.rate !== undefined ? savedSettings.rate : 1.95583;
    dec = savedSettings.dec !== undefined ? savedSettings.dec : 2;
    decHU = savedSettings.decHU !== undefined ? savedSettings.decHU : 5;
    document.getElementById('rateInput').value = RATE;
    document.getElementById('decField').value = dec;
    document.getElementById('decHUField').value = decHU;
    // Зареждаме цветовете
    const colorMap = {
        bgColor: '--page',
        calcColor: '--calc',
        displayColor: '--display-bg',
        exprBgColor: '--expr-bg',
        displayTextColor: '--display-text',
        exprTextColor: '--expr-text',
        btnColor: '--btn',
        opColor: '--btn-op',
        cColor: '--btn-c',
        delColor: '--btn-del',
        btnTextColor: '--btn-text'
    };
    Object.keys(colorMap).forEach(id => {
        const cssVar = colorMap[id];
        const color = savedSettings[id] || getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
        document.getElementById(id).value = color;
        document.documentElement.style.setProperty(cssVar, color);
    });
}

function loadHistory(){
  getHistory().then(list=>{
    historyList.innerHTML='';
    list.forEach(h=>{
      const btn=document.createElement('button');
      btn.textContent=h.expr;
      btn.onclick=()=>{expr=toStr(h.res, decHU);upd();toggleHistory();};
      historyList.appendChild(btn);
    });
  });
}

/* ---------- INIT ---------- */
window.addEventListener('load',()=>{
  loadSettings();
  upd();
  updateMem();
});

// ---- Клавиш в комбинация ----
function numClick(ev,k){
  if(ev.ctrlKey){
    // Ctrl-комбинация
    if(['1','2','3'].includes(k)){
      const idx=['1','2','3'].indexOf(k);
      memory[idx]+=toNum(result.textContent.replace(unit, ''));
    }else if(['4','5','6'].includes(k)){
      const idx=['4','5','6'].indexOf(k);
      memory[idx]-=toNum(result.textContent.replace(unit, ''));
    }else if(['7','8','9'].includes(k)){
      const idx=['7','8','9'].indexOf(k);
      expr=toStr(memory[idx]); upd();
    }else if(k==='C'){
      memory=[0,0,0];
    }
    updateMem();
    ev.preventDefault();
  }else{
    act(k);                       // обикновено въвеждане
  }
}

// Добавяме обработчик за клавишни сабития - Lumo made
document.addEventListener('keydown', (event) => {
    const key = event.key;
    const settingsVisible = document.getElementById('settings').style.display === 'flex';
    const historyVisible = document.getElementById('history').style.display === 'flex';
    // Escape винаги работи за затваряне на модални прозорци
    if (key === 'Escape') {
        if (settingsVisible) toggleSettings();
        if (historyVisible) toggleHistory();
        return;
    }
    // Блокираме другите клавиши, ако има отворен модален прозорец
    if (settingsVisible || historyVisible) {
        return;
    }
    // Предотвратяваме стандартното поведение, ако е нужно
    if (['Enter', '/', '*', '(', ')'].includes(key)) {
        event.preventDefault();
    }
    const keyMap = {
        'Enter': '=',
        'Backspace': '⌫',
        'Delete': '⌫',
        ',': ',', '.': ',',
        'c': 'C', 'C': 'C',
        '(': '(', ')': ')',
        '%': '%'
    };
    if (keyMap[key]) {
        act(keyMap[key]);
    } else if ("0123456789+-*/".includes(key)) {
        act(key);
    }
});

// PWA Service Worker & Install Logic
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw-2.js')
        .then((reg) => console.log('SW-2: Service worker registered.', reg))
        .catch((err) => console.error('SW-2: Service worker registration failed:', err));
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('kimisw.js');
}

let deferredPrompt;
// Проверяваме дали потребителят вече е отказал инсталацията
if (localStorage.getItem('kimiPwaInstallDeclined') !== 'true') {
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBar = document.getElementById('install-bar');
        if (installBar) {
            installBar.style.display = 'block';
        }
    });
}

const installButton = document.getElementById('install-button');
if (installButton) {
    installButton.addEventListener('click', async () => {
        const installBar = document.getElementById('install-bar');
        if (installBar) installBar.style.display = 'none';
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);
        deferredPrompt = null;
    });
}

const dismissButton = document.getElementById('dismiss-button');
if (dismissButton) {
    dismissButton.addEventListener('click', () => {
        document.getElementById('install-bar').style.display = 'none';
        localStorage.setItem('kimiPwaInstallDeclined', 'true');
        deferredPrompt = null;
    });
}

window.addEventListener('appinstalled', () => {
    if (document.getElementById('install-bar')) document.getElementById('install-bar').style.display = 'none';
    deferredPrompt = null;
    console.log('PWA was installed');
});
</script>
</body>
</html>