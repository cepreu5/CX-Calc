const rows=5,cols=4,container=document.querySelector(".calculator-container"),displaylv=document.querySelector("#levInput"),display=document.querySelector("#eurInput");var calculator=null,calcBottom=0,screenWidth=window.innerWidth,imageWidth,imageHeight,aspectRatioW,aspectRatioH,imageWidthO,imageHeightO,userInput="",ovFlag=!1,fullscrFlag=!1,keys=displayCoords=[],Mem=[0,0,0,0],levMode=!0,isStandalone=!1,MainPoints={};let modalIsActive=!1,layoutSettingsVisible=!1;var showWarning=!1,tipsEnabled=!0;let audioContext,clickBuffer=null;const MAX_HISTORY_ITEMS=30,historyButton=document.getElementById("historyButton"),recallButton=document.getElementById("recallButton"),settingsModal=document.getElementById("settingsModal"),historyList=document.getElementById("historyList"),closeHistoryModalButton=document.getElementById("closeHistoryModalButton"),closeHelpModalButton=document.getElementById("closeHelpModalButton"),clearHistoryButton=document.getElementById("clearHistoryButton"),closeHelpModalButtonTop=document.getElementById("closeHelpModalButtonTop");var MainPointsO={Keys:{x:43,y:235},KeySize:{x:84,y:70},KbdGaps:{x:13,y:13},Display:{x:102,y:33},Displaylv:{x:102,y:110},DisplaySize:{x:312,y:57},Status:{x:-10,y:185},StatusSize:{x:45,y:15},CurrencyOffset:{x:-40,y:15},CurrencyLevOffset:{x:-40,y:15}};const defaultSettings={exchangeRate:1.95583,currencySymbol:"€",currencyLevSymbol:"лв.",soundEffectsEnabled:!1,showRateWarningEnabled:!0,calcBottomOffset:0,initialDisplay:"lev",tipsEnabled:!0,pwaInstallDeclined:!1,calculatorSkin:"Calculator0.png"};var EXCHANGE_RATE=defaultSettings.exchangeRate,CURRENCY_SYMBOL=defaultSettings.currencySymbol,CURRENCY_LEV_SYMBOL=defaultSettings.currencyLevSymbol,showRateWarningEnabled=defaultSettings.showRateWarningEnabled,soundEffectsEnabled=defaultSettings.soundEffectsEnabled,tutorialSkinSwitch=!1,originalOnloadHandler=null;function saveSettings(){for(const e in MainPointsO)if(MainPointsO.hasOwnProperty(e)){const t=MainPointsO[e];if("object"==typeof t&&null!==t)for(const n in t)if(t.hasOwnProperty(n)){const o=e.toLowerCase()+n.toUpperCase(),l=document.getElementById(o);if(l){const e=parseFloat(l.value);isNaN(e)||(t[n]=e)}}}localStorage.setItem("CXCalc_MainPointsO",JSON.stringify(MainPointsO));const e=JSON.parse(localStorage.getItem("CXCalc_appSettings"))||defaultSettings,t={exchangeRate:parseFloat(document.getElementById("exchangeRateInput").value)||defaultSettings.exchangeRate,currencySymbol:document.getElementById("currencySymbolInput").value.trim()||defaultSettings.currencySymbol,currencyLevSymbol:document.getElementById("currencyLevSymbolInput").value.trim()||defaultSettings.currencyLevSymbol,showRateWarningEnabled:document.getElementById("rateWarningCheckbox").checked,soundEffectsEnabled:document.getElementById("soundEffectsCheckbox").checked,calcBottomOffset:parseInt(document.getElementById("calcBottomOffset").value,10)||0,initialDisplay:document.getElementById("initialDisplayLev").checked?"lev":"eur",tipsEnabled:document.getElementById("tipsEnabledCheckbox").checked,pwaInstallDeclined:e.pwaInstallDeclined||defaultSettings.pwaInstallDeclined,calculatorSkin:e.calculatorSkin||defaultSettings.calculatorSkin};localStorage.setItem("CXCalc_appSettings",JSON.stringify(t)),console.log("Настройките са запазени. Страницата ще бъде презаредена."),location.reload()}function populateLayoutSettings(){for(const e in MainPointsO)if(MainPointsO.hasOwnProperty(e)){const t=MainPointsO[e];if("object"==typeof t&&null!==t)for(const n in t)if(t.hasOwnProperty(n)){const o=e.toLowerCase()+n.toUpperCase(),l=document.getElementById(o);l?l.value=t[n]:console.warn(`Input element with ID '${o}' not found for MainPointsO.${e}.${n}`)}}const e=document.getElementById("exchangeRateInput");e&&(e.value=EXCHANGE_RATE);const t=document.getElementById("calcBottomOffset");if(t){const e=getComputedStyle(document.documentElement).getPropertyValue("--calc-bottom-offset").trim()||"0px";t.value=parseInt(e,10)}const n=document.getElementById("currencySymbolInput");n&&(n.value=CURRENCY_SYMBOL);const o=document.getElementById("currencyLevSymbolInput");o&&(o.value=CURRENCY_LEV_SYMBOL);const l=document.getElementById("rateWarningCheckbox");l&&(l.checked=showRateWarningEnabled);const i=document.getElementById("soundEffectsCheckbox");i&&(i.checked=soundEffectsEnabled);const a=document.getElementById("initialDisplayEur"),s=document.getElementById("initialDisplayLev");a&&s&&(levMode?s.checked=!0:a.checked=!0);const r=document.getElementById("tipsEnabledCheckbox");r&&(r.checked=tipsEnabled)}function loadSettings(){const e=JSON.parse(localStorage.getItem("CXCalc_appSettings")),t={...defaultSettings,...e};EXCHANGE_RATE=t.exchangeRate,CURRENCY_SYMBOL=t.currencySymbol,CURRENCY_LEV_SYMBOL=t.currencyLevSymbol,showRateWarningEnabled=t.showRateWarningEnabled,tipsEnabled=t.tipsEnabled,soundEffectsEnabled=t.soundEffectsEnabled,calcBottom=t.calcBottomOffset,levMode="lev"===t.initialDisplay;const n=JSON.parse(localStorage.getItem("CXCalc_CalcMem"));n&&Array.isArray(n)&&(Mem=n),calculator&&t.calculatorSkin&&(calculator.src=t.calculatorSkin),document.documentElement.style.setProperty("--calc-bottom-offset",`${calcBottom}px`),EXCHANGE_RATE!==defaultSettings.exchangeRate&&(showWarning=!0);const o=localStorage.getItem("CXCalc_MainPointsO");if(o){const e=JSON.parse(o);for(const t in MainPointsO)e[t]&&Object.assign(MainPointsO[t],e[t]);console.log("Заредени и допълнени MainPointsO от loadSettings():")}}function getImageSize(){calculator?(imageWidthO=calculator.naturalWidth,imageHeightO=calculator.naturalHeight):console.log("Изображението не е намерено!")}function getImageVisualSize(){let e=document.body.clientWidth,t=document.body.clientHeight;if(!calculator)return void console.error("Грешка: Не е намерено изображението.");let n=calculator.naturalWidth/calculator.naturalHeight;"cover"===calculator.style.objectFit?(imageWidth=e,imageHeight=t):"contain"===calculator.style.objectFit?e/t>n?(imageHeight=t,imageWidth=Math.round(t*n),console.log("(contain) - Изображението е по-широко от контейнера, използваме височината на контейнера.")):(imageWidth=e,imageHeight=Math.round(e/n),console.log("(contain) - Изображението е по-високо от контейнера, използваме ширината на контейнера.")):(imageWidth=calculator.width,imageHeight=calculator.height),aspectRatioW=imageWidth/imageWidthO,aspectRatioH=imageHeight/imageHeightO,console.log("aspectRatioW = ",aspectRatioW,"   aspectRatioH = ",aspectRatioH)}function getKeyValue(e,t){return[["L","€","C","B"],["7","8","9","/"],["4","5","6","*"],["1","2","3","-"],["0",",","=","+"]][e][t]}function formatNumber(e){return isNaN(e)?"":e.toFixed(2).replace(".",",")}function parseNumber(e){return e?(e=e.replace(/\s+/g,""),parseFloat(e.replace(",","."))):NaN}function convertFromLevToEur(e){let t=parseNumber(e);if(isNaN(t))return"";return formatNumber(t/EXCHANGE_RATE)}function convertFromEurToLev(e){let t=parseNumber(e);if(isNaN(t))return"";return formatNumber(t*EXCHANGE_RATE)}function groupByThree(e,t){if(null==e||""==e)return"";let n=e.replace(/\s+/g,"").split(","),o=n[0];""==o&&(o="0");let l=n.length>1?","+n[1]:"",i=[];for(let e=o.length;e>0;e-=3){let t=Math.max(e-3,0);i.unshift(o.slice(t,e))}return t&&(""===l||","===l?l=",00":2===l.length&&(l+="0")),i=i.join(" ")+l,i=i.replace(/^-\s(?=\d)/,"-"),i}function canAddCharacter(e,t){return!/(\d+,\d{2})(?![+\-*/])/.test(e)||!/\d/.test(t)}function updateDisplays(e,t,n){const o=/[+\-*/]/.test(e.slice(1))||e.includes("(")||e.includes(")"),[l,i]=levMode?[displaylv,display]:[display,displaylv],a=levMode?convertFromLevToEur:convertFromEurToLev;let s;if(l.classList.add("active-display"),i.classList.remove("active-display"),""===e)s="";else if(o)s=t;else{const t=e.includes(","),o=t?e.split(",")[1]:"",l=!t;s="B"===n?groupByThree(e,!!l):l||0===o.length||1===o.length?groupByThree(e,!0):groupByThree(e,!1)}if(l.textContent=s,o)i.textContent="";else{const t=a(e);i.textContent=groupByThree(t,!0)}adjustFontSize(l,i)}function toggleDisplayMode(){const e=(levMode=!levMode)?displaylv.textContent:display.textContent;(userInput=e.replace(/\s/g,"")).endsWith(",00")&&(userInput=userInput.slice(0,-3)),console.log("Променен режим - userInput:",userInput),updateDisplays(userInput,userInput.replace(/\*/g,"×").replace(/\//g,"÷"),"L")}function balanceBrackets(e){let t=0;for(const n of e)"("===n?t++:")"===n&&t--;return e+")".repeat(Math.max(0,t))}function addImplicitMultiplication(e){return e.replace(/(\d)(?=\()/g,"$1*").replace(/(?<=\))(\d)/g,"*$1").replace(/\)\(/g,")*(")}function appendNumber(value){var oldUserInput="";const display=document.getElementById("eurInput"),displaylv=document.getElementById("levInput");if("€"===value)return void historyOpen();if("L"===value)return void toggleDisplayMode();if("C"===value)display.textContent="",displaylv.textContent="",userInput="";else if("B"===value)userInput=userInput.slice(0,-1);else if("="===value){if(!/[+\-*/]$/.test(userInput)&&userInput.length>0)try{let formattedInput=userInput.replace(/,/g,".");oldUserInput=userInput.replace(/\*/g,"×").replace(/\//g,"÷").replace(/,/g,"."),formattedInput=addImplicitMultiplication(balanceBrackets(formattedInput));let result=eval(formattedInput);result=parseFloat(result).toFixed(2),userInput=result.toString().replace(/\./g,","),navigator.clipboard.writeText(userInput).then(()=>{console.log("Резултатът е копиран в клипборда! ✅")}).catch(e=>{console.error("Грешка при копиране в клипборда:",e)})}catch(e){console.error("Грешка в изчисленията",e)}}else{const lastOperatorIndex=Math.max(userInput.lastIndexOf("+"),userInput.lastIndexOf("-"),userInput.lastIndexOf("*"),userInput.lastIndexOf("/")),currentNumber=-1===lastOperatorIndex?userInput:userInput.slice(lastOperatorIndex+1);if(","===value&&currentNumber.includes(","))return;if((/\d/.test(value)||","===value)&&currentNumber.includes(",")){const e=currentNumber.split(",")[1]||"";if(e.length>=2)return}if(/[+\-*/]/.test(value)&&(0===userInput.length||/[+\-*/]$/.test(userInput)))return;let match=userInput.match(/([\d,]+[+\-*/])([\d,]+)/);if(match&&/[+\-*/]/.test(value))try{let formattedInput=userInput.replace(/,/g,".");oldUserInput=userInput.replace(/\*/g,"×").replace(/\//g,"÷").replace(/,/g,"."),formattedInput=addImplicitMultiplication(balanceBrackets(formattedInput)),console.log("2-Изчисляване на:",formattedInput);let result=eval(formattedInput);userInput=parseFloat(result).toFixed(2).replace(/\./g,",")+value;let levValue=parseNumber(displaylv.textContent),eurValue=parseNumber(display.textContent);addHistoryEntry(oldUserInput,result,"no")}catch(e){console.error("Грешка в изчисленията",e)}else"0"!==currentNumber||","===value||/[+\-*/]/.test(value)?canAddCharacter(userInput,value)&&(userInput+=value):userInput=userInput.slice(0,-1)+value}const formattedUserInput=userInput.replace(/\*/g,"×").replace(/\//g,"÷");if(updateDisplays(userInput,formattedUserInput,value),"="===value){let e=parseNumber(displaylv.textContent),t=parseNumber(display.textContent);""!==e&&""!==t&&addHistoryEntry(oldUserInput,e,t)}userInput.endsWith(",00")&&(userInput=userInput.slice(0,-3)),console.log("userInput = ",userInput)}function getKeyColumnIndex(e){const t=calculator.getBoundingClientRect(),n=MainPoints.KeySize.x+MainPoints.KbdGaps.x,o=(e.x-t.left-MainPoints.Keys.x)/n;return Math.round(o+1)}function controlActions(key){if("+"===key.value)fullscrFlag?exitFullscreen():goFullscreen(),fullscrFlag=!fullscrFlag;else if("*"===key.value)console.log("Before %: ",userInput),userInput=userInput.replace(",","."),userInput=eval(userInput),userInput=(parseFloat(userInput)/100).toFixed(2).replace(".",","),appendNumber("=");else if("-"===key.value){if(/[+\-*/]$/.test(userInput))return;if(userInput=userInput.startsWith("-")?userInput.slice(1):"-"+userInput,userInput=userInput.replace(",","."),/[+\-*/]$/.test(userInput))return;userInput=eval(userInput),userInput=parseFloat(userInput).toFixed(2).replace(".",","),appendNumber("=")}}async function initAudio(){if(soundEffectsEnabled)try{audioContext=new(window.AudioContext||window.webkitAudioContext);const e=await fetch("click.wav"),t=await e.arrayBuffer();clickBuffer=await audioContext.decodeAudioData(t),console.log("Аудио файлът е кеширан и готов за възпроизвеждане.")}catch(e){console.error("Web Audio API не се поддържа или възникна грешка при инициализация.",e),soundEffectsEnabled=!1}}function playClickSound(){if(!soundEffectsEnabled||!clickBuffer||!audioContext)return;"suspended"===audioContext.state&&audioContext.resume();const e=audioContext.createBufferSource();e.buffer=clickBuffer,e.connect(audioContext.destination),e.start(0)}function getKeyDimensions(){const e=calculator.getBoundingClientRect(),t=e.width/imageWidthO,n=e.height/imageHeightO;return{keyWidth:MainPointsO.KeySize.x*t,keyHeight:MainPointsO.KeySize.y*n}}function isWithinKeyBounds(e,t,n,o){return e.clientX>=t.x&&e.clientX<=t.x+n&&e.clientY>=t.y&&e.clientY<=t.y+o}function handleStatusZones(e,t){for(let n=1;n<=4;n++){const o=document.getElementById(`statusArea${n}`);if(!o)continue;if(getComputedStyle(o).opacity>0||4===n){const l=o.getBoundingClientRect();if(e.clientX>=l.left&&e.clientX<=l.right&&e.clientY>=l.top&&e.clientY<=l.bottom)return 4===n?(t?memoryShow(4):(helpModal.style.display="flex",modalIsActive=!0),!0):(t?memoryShow(n):memoryRecall(n),!0)}}return!1}function sanitizeAndEvaluateInput(input,operationType){if(/[+\-*/]$/.test(input))return null;input=input.replace(",",".");let result=eval(input);return"percent"===operationType?result/=100:"negate"===operationType&&(result=input.startsWith("-")?input.slice(1):"-"+input,result=eval(result)),parseFloat(result).toFixed(2).replace(".",",")}function goFullscreen(){const e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}function exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}function toggleFullscreen(){fullscrFlag?exitFullscreen():goFullscreen(),fullscrFlag=!fullscrFlag}function clearAllMemory(){for(let e=1;e<4;e++)Mem[e]=0,clearStatus(e);localStorage.setItem("CalcMem",JSON.stringify(Mem))}async function pasteNumber(){try{const e=await navigator.clipboard.readText(),t=e.replace(/(?<=\d)\s+(?=\d)/g,"").match(/-?\d+[.,]?\d*/);if(t){let e=t[0].replace(",","."),n=parseFloat(e).toFixed(2).replace(".",",");const o=n.slice(-1),l=n.slice(0,-1);userInput=l,appendNumber(o)}else console.warn("Не е намерено валидно число в клипборда.")}catch(e){console.error("Грешка при достъп до клипборда:",e)}}function switchNumber(){appendNumber("="),appendNumber("C"),appendNumber("L"),pasteNumber()}function allClear(){appendNumber("C"),userInput="",Mem=[0,0,0,0],localStorage.setItem("CalcMem",JSON.stringify(Mem)),document.getElementById("clearHistoryButton").click()}function handleCalculatorInteraction(e,t={}){if(modalIsActive)return;let n=!1;const{keyWidth:o,keyHeight:l}=getKeyDimensions();if(keys.forEach(i=>{if(isWithinKeyBounds(e,i,o,l)){n=!0;const o=i.value;if((e.ctrlKey||t.allowWithoutCtrl)&&"€"===o)ovFlag&&(noOverlay(),ovFlag=!1),settingsModal.style.display="flex",modalIsActive=!0,populateLayoutSettings();else if((e.ctrlKey||t.allowWithoutCtrl)&&"B"===o)clearAllMemory();else if((e.ctrlKey||t.allowWithoutCtrl)&&"0"===o)appendNumber("(");else if((e.ctrlKey||t.allowWithoutCtrl)&&","===o)appendNumber(")");else if((e.ctrlKey||t.allowWithoutCtrl)&&"+"===o)toggleFullscreen();else if((e.ctrlKey||t.allowWithoutCtrl)&&"/"===o)pasteNumber();else if((e.ctrlKey||t.allowWithoutCtrl)&&"L"===o)switchNumber();else if((e.ctrlKey||t.allowWithoutCtrl)&&"C"===o)allClear();else if((e.ctrlKey||t.allowWithoutCtrl)&&"*"===o){const e=sanitizeAndEvaluateInput(userInput,"percent");null!==e&&(userInput=e,appendNumber("="))}else if((e.ctrlKey||t.allowWithoutCtrl)&&"-"===o){const e=sanitizeAndEvaluateInput(userInput,"negate");null!==e&&(userInput=e,appendNumber("="))}else if((e.ctrlKey||t.allowWithoutCtrl)&&isMemoryKey(o)){executeMemoryAction(o,getKeyColumnIndex(i))}else appendNumber(o)}}),handleStatusZones(e,e.ctrlKey||t.allowWithoutCtrl)&&(n=!0),!n){const t=document.getElementById("levInput"),o=document.getElementById("eurInput"),l=t.getBoundingClientRect(),i=o.getBoundingClientRect(),a=e.clientX>=l.left&&e.clientX<=l.right&&e.clientY>=l.top&&e.clientY<=l.bottom,s=e.clientX>=i.left&&e.clientX<=i.right&&e.clientY>=i.top&&e.clientY<=i.bottom;(a||s)&&(toggleDisplayMode(),n=!0)}if(!n&&(e.ctrlKey||t.allowWithoutCtrl)){const t=document.getElementById("calculatorContainer").getBoundingClientRect();(e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom)&&confirm("Сигурни ли сте, че искате да върнете първоначалните настройки?")&&("function"==typeof clearHistory&&(clearHistory(),console.log("Историята е изтрита.")),localStorage.removeItem("CXCalc_MainPointsO"),localStorage.removeItem("CXCalc_appSettings"),console.log("Всички запазени настройки (CXCalc_MainPointsO, CXCalc_appSettings) са изтрити."),location.reload())}n&&playClickSound()}function resetLayoutSettingsView(){document.getElementById("Settings1").style.display="grid",document.getElementById("Settings2").style.display="none",layoutSettingsVisible=!1}function toggleLayoutSettingsView(){layoutSettingsVisible?(showOv(),resetLayoutSettingsView()):(document.getElementById("Settings1").style.display="none",document.getElementById("Settings2").style.display="grid",layoutSettingsVisible=!0)}function showOv(){if(ovFlag)noOverlay(),ovFlag=!1;else{const e=calcNewCoordinates();displayCoords=e.displayCoords,placeKeys(keys,displayCoords),ovFlag=!0}settingsModal.style.display="none",setTimeout(()=>{modalIsActive=!1},0)}function closeHelpModal(e){helpModal.style.display="none",setTimeout(()=>{modalIsActive=!1},0),e.stopPropagation(),e.preventDefault()}let deferredPrompt;function showNotification(e,t="info",n=3e3,o=!1){const l=document.querySelector(".custom-notification");l&&document.body.removeChild(l);const i=document.createElement("div");i.className="custom-notification",i.textContent=e;const a={info:"#0078d4",success:"#107c10",error:"#d13438"};i.style.background=a[t]||a.info,Object.assign(i.style,{position:"fixed",top:"10px",left:"50%",transform:"translateX(-50%)",color:"#fff",padding:"12px 20px",borderRadius:"6px",boxShadow:"0 2px 6px rgba(0,0,0,0.2)",zIndex:"9999",fontFamily:"sans-serif",opacity:"0",transition:"opacity 0.5s ease-in-out",width:"80%",maxWidth:"300px",textAlign:"center"}),document.body.appendChild(i),setTimeout(()=>{i.style.opacity="1"},10),setTimeout(()=>{i.style.opacity="0",setTimeout(()=>{o?window.location.reload():document.body.contains(i)&&document.body.removeChild(i)},500)},n)}function checkForUpdates(){const e=document.getElementById("checkVersionBtn");navigator.onLine?"serviceWorker"in navigator?navigator.serviceWorker.getRegistration().then(t=>{if(!t)return void showNotification("Service Worker не е регистриран.","error");const n=e.querySelector("span");if(!n)return void console.error("Не е намерен текстов елемент (span) в бутона за проверка на версия.");const o=n.textContent;n.textContent="Проверява се...",e.disabled=!0,t.update().then(()=>{t.installing?(console.log("SW: Намерен е нов service worker, инсталира се..."),showNotification("Инсталира се нова версия...","info")):t.waiting?(console.log("SW: Намерен е чакащ service worker. Изпраща се команда за активиране..."),showNotification("Активира се нова версия...","info"),t.waiting.postMessage({type:"SKIP_WAITING"})):showNotification("Вие използвате последната версия.","success")}).catch(e=>{console.error("Грешка при проверка за нова версия:",e),showNotification("Грешка при проверката за нова версия.","error")}).finally(()=>{t.installing||t.waiting||setTimeout(()=>{n&&(n.textContent=o),e.disabled=!1},3e3)})}):showNotification("Service Worker не се поддържа.","error"):showNotification("Няма връзка с интернет. Проверката е невъзможна.","error")}function updateMemoryStatusDisplay(e,t){const n=document.getElementById(`statusArea${e}`);n&&(n.style.backgroundColor=t?"rgb(225, 250, 4)":"#565749")}function isMemoryKey(e){return/^[1-9]$/.test(e)||["*","/","-"].includes(e)}function memoryAdd(e,t="+"){const n=(levMode?displaylv:display).textContent.trim().replace(/\s/g,"").replace(",",".");let o=parseFloat(n);switch(isNaN(o)&&(o=0),void 0===Mem[e]&&(Mem[e]=0),t){case"+":Mem[e]+=o,console.log(`M+ в Mem[${e}] → +${o} = [${Mem}]`),updateMemoryStatusDisplay(e,!0),setTimeout(()=>{updateMemoryStatusDisplay(e,!1)},300);break;case"-":Mem[e]-=o,console.log(`M− в Mem[${e}] → −${o} = [${Mem}]`),updateMemoryStatusDisplay(e,!0),setTimeout(()=>{updateMemoryStatusDisplay(e,!1)},300);break;case"0":Mem[e]=0,console.log(`0 в Mem[${e}] → +${o} = [${Mem}]`);break;default:console.warn("❗ Непозната операция:",t)}localStorage.setItem("CXCalc_CalcMem",JSON.stringify(Mem));const l="number"==typeof e?`statusArea${e}`:e,i=document.getElementById(l);i&&(i.textContent="M"+e,i.style.opacity="1")}function executeMemoryAction(e,t){switch(t){case 1:switch(e){case"1":memoryAdd(1,"+");break;case"4":memoryAdd(1,"-");break;case"7":memoryAdd(1,"0"),clearStatus(t)}break;case 2:switch(e){case"2":memoryAdd(2,"+");break;case"5":memoryAdd(2,"-");break;case"8":memoryAdd(2,"0"),clearStatus(t)}break;case 3:switch(e){case"3":memoryAdd(3,"+");break;case"6":memoryAdd(3,"-");break;case"9":memoryAdd(3,"0"),clearStatus(t)}}}function memoryShow(e,t){if(4==e){const e=document.getElementById("calculator"),n=e.src.includes("CalculatorA.png")?"Calculator0.png":"CalculatorA.png";originalOnloadHandler||(originalOnloadHandler=e.onload);const o=tipsEnabled;tipsEnabled=!1,e.onload=()=>{"function"==typeof originalOnloadHandler&&originalOnloadHandler(),tipsEnabled=o,"function"==typeof t&&t(),e.onload=originalOnloadHandler},e.src=n;const l=JSON.parse(localStorage.getItem("CXCalc_appSettings"))||{};return l.calculatorSkin=n,void localStorage.setItem("CXCalc_appSettings",JSON.stringify(l))}if(void 0===Mem[e])return void console.warn(`Памет Mem[${e}] е недефинирана.`);displaylv.textContent;const n=display.textContent,o=(displaylv.style.backgroundColor,display.style.backgroundColor),l=groupByThree(formatNumber(Mem[e]));display.textContent=l,adjustFontSize(displaylv,display),display.style.backgroundColor="rgba(255, 223, 186, 0.5)",setTimeout(()=>{display.textContent=n,display.style.backgroundColor=o},1e3)}function memoryRecall(e){if(void 0===Mem[e]||0===Mem[e]||""!==userInput&&!/[+\-*/×÷]$/.test(userInput))return;const t=Mem[e].toString().replace(".",","),n=/[+\-*/×÷(]/.test(userInput+=t),o=levMode?displaylv:display,l=levMode?display:displaylv,i=levMode?convertFromLevToEur:convertFromEurToLev;n?(o.textContent=userInput.replace(/\*/g,"×").replace(/\//g,"÷"),l.textContent=""):(o.textContent=groupByThree(userInput,!0),l.textContent=groupByThree(i(userInput,!0))),console.log(`📟 MR от Mem[${e}] → "${t}" → нов userInput: "${userInput}"`),adjustFontSize(displaylv,display),updateMemoryStatusDisplay(e,!1)}function clearStatus(e){const t="number"==typeof e?`statusArea${e}`:e,n=document.getElementById(t);n&&(n.style.opacity="0")}function scaleMainPoints(e,t){if(MainPointsO)for(const n in MainPointsO){const o=MainPointsO[n];o&&"number"==typeof o.x&&"number"==typeof o.y&&(MainPoints[n]={x:o.x*e,y:o.y*t})}}function positionStatusArea(e,t=!1){const n=e-1,o=calculator.getBoundingClientRect(),l=MainPoints.Keys.x+n*(MainPoints.KeySize.x+MainPoints.KbdGaps.x)+MainPoints.KeySize.x/2,i=document.getElementById(`statusArea${e}`);if(i&&!t&&(i.style.left=o.left+MainPoints.Status.x+l-MainPoints.StatusSize.x/2+"px",i.style.top=`${o.top+MainPoints.Status.y}px`,i.style.width=`${MainPoints.StatusSize.x}px`,i.style.height=`${MainPoints.StatusSize.y}px`),t){const e=document.body,t=document.createElement("div");t.className="overlay-marker",t.style.position="fixed",t.style.left=o.left+MainPoints.Status.x+l-MainPoints.StatusSize.x/2+"px",t.style.top=`${o.top+MainPoints.Status.y}px`,t.style.width=`${2+MainPoints.StatusSize.x}px`,t.style.height=`${2+MainPoints.StatusSize.y}px`,t.style.pointerEvents="none",t.style.backgroundColor="transparent",t.style.border="5px solid yellow",t.style.pointerEvents="none",t.style.zIndex="9999",e.appendChild(t)}}function noOverlay(){document.querySelectorAll(".overlay-marker").forEach(e=>e.remove())}function placeKeys(e,t){const n=document.body;noOverlay(),e.forEach(e=>{const t=document.createElement("div");t.className="overlay-marker",t.style.position="fixed",t.style.left=`${e.x}px`,t.style.top=`${e.y}px`,t.style.width=`${MainPoints.KeySize.x}px`,t.style.height=`${MainPoints.KeySize.y}px`,t.style.backgroundColor="transparent",t.style.border="1px solid yellow",t.style.pointerEvents="none",t.style.zIndex="9999",n.appendChild(t)});for(let e=1;e<5;e++)positionStatusArea(e,!0)}function calcNewCoordinates(){if(!calculator)return console.error("Липсва изображението на калкулатора."),{keys:[],displayCoords:{}};const e=calculator.getBoundingClientRect(),t=document.getElementById("calculatorContainer").getBoundingClientRect(),n={lv:{x:e.left+MainPoints.Displaylv.x,y:e.top+MainPoints.Displaylv.y},eur:{x:e.left+MainPoints.Display.x,y:e.top+MainPoints.Display.y}},o=[];for(let t=0;t<rows;t++)for(let n=0;n<cols;n++)o.push({x:e.left+MainPoints.Keys.x+n*(MainPoints.KeySize.x+MainPoints.KbdGaps.x),y:e.top+MainPoints.Keys.y+t*(MainPoints.KeySize.y+MainPoints.KbdGaps.y),value:getKeyValue(t,n)});[{label:"Долен дисплей",id:"levInput",coords:n.lv},{label:"Горен дисплей",id:"eurInput",coords:n.eur},{label:"Валута",id:"currency",coords:{x:n.eur.x+MainPoints.CurrencyOffset.x,y:n.eur.y+MainPoints.CurrencyOffset.y}},{label:"Валута Лев",id:"currencyLev",coords:{x:n.lv.x+MainPoints.CurrencyLevOffset.x,y:n.lv.y+MainPoints.CurrencyLevOffset.y}}].forEach(({label:e,id:n,coords:o})=>{const l=parseFloat(o?.x),i=parseFloat(o?.y);if(isNaN(l)||isNaN(i))return void console.warn(`⚠️ ${e} получи невалидни координати:`,o);const a=document.getElementById(n);if(a){if(a.title=e,a.style.position="absolute",a.style.left=l-t.left+"px",a.style.top=i-t.top+"px","levInput"===n||"eurInput"===n){const e=a.classList.contains("active-display");a.className="calculator-display",e&&a.classList.add("active-display"),a.style.width=`${MainPoints.DisplaySize.x}px`,a.style.height=`${MainPoints.DisplaySize.y}px`}else if("currency"===n||"currencyLev"===n){const e=24;a.style.fontSize=e*aspectRatioH+"px"}}else console.warn(`⚠️ Елемент с id '${n}' не е намерен.`)});for(let e=1;e<5;e++)positionStatusArea(e);return{keys:o,displayCoords:n}}document.addEventListener("click",function(e){handleCalculatorInteraction(e)}),document.addEventListener("contextmenu",function(e){e.preventDefault(),handleCalculatorInteraction(e,{allowWithoutCtrl:!0})}),document.getElementById("saveSettings").addEventListener("click",function(e){saveSettings(),settingsModal.style.display="none",setTimeout(()=>{modalIsActive=!1},0),e.stopPropagation(),e.preventDefault()}),document.getElementById("closeSettingsModalButton").addEventListener("click",function(e){settingsModal.style.display="none",resetLayoutSettingsView(),setTimeout(()=>{modalIsActive=!1},0),e.stopPropagation(),e.preventDefault()}),window.addEventListener("load",function(){document.body.style.overflow="auto",clearTimeout(loadingTimeout);try{calculator=document.querySelector(".calculator-img");const e=()=>{getImageSize(),getImageVisualSize(),scaleMainPoints(aspectRatioW,aspectRatioH);const e=calcNewCoordinates();keys=e.keys,displayCoords=e.displayCoords,resizeFont()};if(calculator.onload=e,loadSettings(),calculator.complete&&e(),initAudio(),document.getElementById("currency").textContent=CURRENCY_SYMBOL,document.getElementById("currencyLev").textContent=CURRENCY_LEV_SYMBOL,showWarning&&showRateWarningEnabled){const e=document.getElementById("exchangeRateWarning"),t=t=>{t&&t.stopPropagation(),e.style.display="none",modalIsActive=!1};e.style.display="flex",modalIsActive=!0,document.getElementById("exchangeRateChangeBtn").onclick=function(e){e&&e.stopPropagation();const t=JSON.parse(localStorage.getItem("CXCalc_appSettings"))||defaultSettings;t.exchangeRate=defaultSettings.exchangeRate,localStorage.setItem("CXCalc_appSettings",JSON.stringify(t)),location.reload()},document.getElementById("exchangeRateConfirmBtn").onclick=function(e){t(e)}}"function"==typeof initTips&&"function"==typeof showTips&&(initTips(),tipsEnabled&&showTips("Single"));for(let e=1;e<=3;e++)void 0!==Mem[e]&&null!==Mem[e]&&0!==Mem[e]&&memoryAdd(e,"+")}catch(e){console.warn("⚠️ Грешка при инициализация:",e)}document.body.classList.add("ready"),appendNumber("C");const e=document.getElementById("loading-overlay");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500)),isStandalone=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone;const t=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,n="true"===localStorage.getItem("CXCalc_pwaInstallDeclined");if(t&&!isStandalone&&!n){const e=document.getElementById("ios-install-prompt"),t=document.getElementById("dismiss-ios-prompt"),n=document.getElementById("decline-ios-install");e&&t&&n&&(e.style.display="flex",n.addEventListener("click",()=>{e.style.display="none",localStorage.setItem("CXCalc_pwaInstallDeclined","true")},{once:!0}),t.addEventListener("click",()=>{e.style.display="none"},{once:!0}))}appendNumber("C")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{e.target.classList.contains("modal")&&(e.stopPropagation(),e.target.style.display="none","settingsModal"===e.target.id&&resetLayoutSettingsView(),modalIsActive=!1)}),document.addEventListener("keydown",e=>{const key=e.key;if("Escape"===key||"Esc"===key)return"none"!==settingsModal.style.display&&resetLayoutSettingsView(),historyModal.style.display="none",helpModal.style.display="none",settingsModal.style.display="none",void(modalIsActive=!1);if(modalIsActive)return;if(["Enter","/","*","(",")"].includes(key)&&e.preventDefault(),"%"===key){if(/[+\-*/]$/.test(userInput))return;return userInput=userInput.replace(",","."),userInput=eval(userInput),userInput=(parseFloat(userInput)/100).toFixed(2).replace(".",","),void appendNumber("=")}const keyMap={Enter:"=","=":"=",Backspace:"B",Delete:"B",",":",",".":",",c:"C",C:"C","(":"(",")":")"};keyMap[key]?appendNumber(keyMap[key]):"0123456789+-*/".includes(key)&&appendNumber(key)});const checkVersionBtn=document.getElementById("checkVersionBtn");checkVersionBtn&&checkVersionBtn.addEventListener("click",checkForUpdates);const resetTipsButton=document.getElementById("resetTipsButton");resetTipsButton&&resetTipsButton.addEventListener("click",e=>{e.stopPropagation(),"function"==typeof showTips&&showTips("Reset")});const startTutorialButton=document.getElementById("startTutorialButton");startTutorialButton&&startTutorialButton.addEventListener("click",e=>{e.stopPropagation(),settingsModal.style.display="none",modalIsActive=!1,resetLayoutSettingsView();"Calculator0.png"===((JSON.parse(localStorage.getItem("CXCalc_appSettings"))||defaultSettings).calculatorSkin||"Calculator0.png")?(tutorialSkinSwitch=!0,memoryShow(4,()=>{showTips("All")})):(tutorialSkinSwitch=!1,showTips("All"))});const helpFooterInfo=document.getElementById("help-footer-info"),emailLink='<a href="mailto:cx.sites.online@gmail.com" style="color: inherit; text-decoration: none;">cx.sites.online@gmail.com</a>',currentVersion=localStorage.getItem("CXCalc_appVersion");if(helpFooterInfo){const e=currentVersion||"N/A";helpFooterInfo.innerHTML=`Версия ${e} &bull; Контакт: ${emailLink}`}loadHistory(),adjustFontSize(levInput,eurInput)}),window.addEventListener("resize",function(e){getImageVisualSize(),scaleMainPoints(aspectRatioW,aspectRatioH);const t=calcNewCoordinates();keys=t.keys,displayCoords=t.displayCoords,adjustFontSize(levInput,eurInput)}),closeHelpModalButton&&closeHelpModalButton.addEventListener("click",closeHelpModal),closeHelpModalButtonTop&&closeHelpModalButtonTop.addEventListener("click",closeHelpModal),"serviceWorker"in navigator&&navigator.serviceWorker.register("sww.js").then(e=>{console.log("Service Worker регистриран:",e),navigator.serviceWorker.addEventListener("message",e=>{"NEW_VERSION_AVAILABLE"===e.data?.type&&(console.log("Налична е нова версия:",e.data.version),e.data.version&&localStorage.setItem("CXCalc_appVersion",e.data.version),showNotification("Налична е нова версия. Презареждане...","success",4e3,!0))})}).catch(e=>{console.error("Грешка при регистрация на Service Worker:",e)}),"true"===localStorage.getItem("CXCalc_pwaInstallDeclined")?console.log("Потребителят вече е отказал инсталацията."):window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e;const t=document.getElementById("install-bar"),n=document.getElementById("install"),o=document.getElementById("dismiss"),l=document.getElementById("install-countdown");t.style.display="flex";let i=20;l.textContent=` (${i})`;const a=setInterval(()=>{i--,l.textContent=` (${String(i).padStart(2,"0")})`,i<=0&&c()},1e3),s=()=>{deferredPrompt.prompt(),deferredPrompt=null,c()},r=()=>{localStorage.setItem("CXCalc_pwaInstallDeclined","true"),deferredPrompt=null,c()};function c(){clearInterval(a),t.style.display="none",n.removeEventListener("click",s),o.removeEventListener("click",r)}n.addEventListener("click",s),o.addEventListener("click",r)});let history=[];function loadHistory(){const e=JSON.parse(localStorage.getItem("CXCalc_history"));history=e?e.filter(e=>e.operation&&e.result):[]}function saveHistoryToStorage(){localStorage.setItem("CXCalc_history",JSON.stringify(history))}function addHistoryEntry(e,t,n){const o=groupByThree(formatNumber(t)),l=groupByThree(formatNumber(n));let i=`${o} лв. = ${l} €`;""!=`${groupByThree(formatNumber(t))}`&&""!=`${groupByThree(formatNumber(n))}`||(""===o?i=`${l}`:""===l&&(i=`${o}`)),history.unshift({operation:e,result:i}),history.length>MAX_HISTORY_ITEMS&&(history=history.slice(0,MAX_HISTORY_ITEMS)),saveHistoryToStorage()}function formatExpression(e){return(e=e.replace(/\s+/g,"")).replace(/(\d+(?:[.,]\d+)?)[\s]*([+\-*/×÷])[\s]*(\d+(?:[.,]\d+)?)/,(e,t,n,o)=>{const l=parseFloat(t.replace(",",".")),i=parseFloat(o.replace(",","."));return`${l.toFixed(2).replace(".",",")} ${n} ${i.toFixed(2).replace(".",",")}`})}function updateHistoryList(){if(historyList.innerHTML="",0===history.length){const e=document.createElement("li");return e.textContent="Няма запазена история.",void historyList.appendChild(e)}history.forEach(e=>{const t=document.createElement("li");t.textContent="",/[+\-*/×÷]/.test(e.operation)&&(t.textContent=`${formatExpression(e.operation)} -> `),t.textContent+=`${e.result}`,historyList.appendChild(t)})}function handleClearHistory(){history=[],saveHistoryToStorage(),updateHistoryList(),closeHistoryModalButton.click()}function historyOpen(){noOverlay(),updateHistoryList(),historyModal.style.display="flex",modalIsActive=!0}function getTextWidth(e,t){const n=document.createElement("span");n.style.visibility="hidden",n.style.position="absolute",n.style.whiteSpace="pre",n.style.fontSize=getComputedStyle(t).fontSize,n.style.fontFamily=getComputedStyle(t).fontFamily,n.style.fontWeight=getComputedStyle(t).fontWeight,n.textContent=e,document.body.appendChild(n);const o=n.offsetWidth;return document.body.removeChild(n),o}function adjustFontSize(e,t){const n=void 0!==e.innerText?e.innerText:e.textContent||"0",o=void 0!==t.innerText?t.innerText:t.textContent||"0";console.log("text1: "+n),console.log("text2: "+o);const l=e.getBoundingClientRect(),i=t.getBoundingClientRect(),a=Math.min(l.width,i.width),s=Math.min(l.height,i.height),r=document.createElement("div");r.style.position="absolute",r.style.visibility="hidden",r.style.height="auto",r.style.width="auto",r.style.whiteSpace="nowrap";const c=getComputedStyle(e);r.style.fontFamily=c.fontFamily,r.style.fontWeight=c.fontWeight,r.style.letterSpacing=c.letterSpacing,r.style.padding="0",r.style.border="none",r.style.boxSizing="border-box",document.body.appendChild(r),r.style.fontSize="48px",r.textContent=n;const u=r.scrollWidth;r.textContent=o;const d=u>=r.scrollWidth?n:o;let p=48;for(;p>=14&&(r.style.fontSize=p+"px",r.textContent=d,!(r.scrollWidth<=a&&r.scrollHeight<=s));)p--;p<14&&(p=14),p--,e.style.fontSize=p+"px",t.style.fontSize=p+"px",document.body.removeChild(r)}function resizeFont(){const e=display.clientHeight;display.style.fontSize=displaylv.style.fontSize=.99*e+"px"}clearHistoryButton&&clearHistoryButton.addEventListener("click",handleClearHistory),closeHistoryModalButton&&closeHistoryModalButton.addEventListener("click",e=>{historyModal.style.display="none",setTimeout(()=>{modalIsActive=!1},0),e.stopPropagation(),e.preventDefault()});const allTips=[{id:"tip-help",text:"Показва подробна помощна информация за разширените функции на калкулатора. Задръжте го, за да се покажат помощни обозначения върху бутоните (на компютър: Ctrl+Клик).",target:"statusArea4"},{id:"tip-history-and-settings",text:"История. Задръжте бутона за отваряне на Настройки (на компютър: Ctrl+Клик).",target:"€"},{id:"tip-display-switch",text:"Клик върху някой от дисплеите превключва активния дисплей (или натискане на бутона с две стрелки).",target:"display"},{id:"tip-copy",text:"Извлича от съдържанието на клипборда първото число (ако има такова).",target:"/"},{id:"tip-paste",text:"Резултатът от пресмятанията се запомня автоматично в клипборда, така че можете лесно да го поставите навсякъде.",target:"display"}];let tips=[];function getTargetCoordinates(e){const t=keys.find(t=>t.value===e);if(t){const e=getKeyDimensions();return{x:t.x,y:t.y,width:e.keyWidth,height:e.keyHeight}}let n=null;return n="display"===e?document.getElementById("levInput"):document.getElementById(e),n?n.getBoundingClientRect():(console.warn(`Could not find a valid target for tip: ${e}`),null)}function initTips(){const e=JSON.parse(localStorage.getItem("CXCalc_TipStates"))||{};tips=allTips.map(t=>({...t,show:!1!==e[t.id]})),console.log("Tips system initialized.")}function saveTipStates(){const e=tips.reduce((e,t)=>(e[t.id]=t.show,e),{});localStorage.setItem("CXCalc_TipStates",JSON.stringify(e))}function createTipElement(e,t){const n=getTargetCoordinates(e.target);if(!n)return void(t&&t());const o=document.body,l=document.createElement("div");l.className="tip-popup",l.id=`popup-${e.id}`,l.innerHTML=`\n            <div class="tip-content">${e.text}</div>\n            <div class="tip-actions">\n                <button class="tip-action-btn tip-dont-show-again-btn">Не показвай повече</button>\n                <button class="tip-action-btn tip-close-btn">&times;</button>\n            </div>\n            <div class="tip-tail"></div>\n        `,o.appendChild(l),l.addEventListener("click",e=>{e.stopPropagation()});const i=e=>{e&&e.stopPropagation(),document.removeEventListener("click",a,!0),o.contains(l)&&o.removeChild(l),t&&t()},a=e=>{l.contains(e.target)||i(e)};setTimeout(()=>{document.addEventListener("click",a,!0)},0);const s=n.x+n.width/2,r=l.getBoundingClientRect();let c=n.y-r.height-12,u=s-r.width/2;c<0&&(c=n.y+n.height+12,l.classList.add("tip-below")),u<0&&(u=5),u+r.width>window.innerWidth&&(u=window.innerWidth-r.width-5),l.style.top=`${c}px`,l.style.left=`${u}px`;const d=l.querySelector(".tip-tail");if(d){const e=s-u-20/2;d.style.left=`${e}px`}l.querySelector(".tip-dont-show-again-btn").addEventListener("click",t=>{const n=tips.find(t=>t.id===e.id);n&&(n.show=!1,saveTipStates()),i(t)}),l.querySelector(".tip-close-btn").addEventListener("click",e=>{i(e)})}function showTips(e="Single"){if(!modalIsActive)switch(document.querySelectorAll(".tip-popup").forEach(e=>e.remove()),e){case"Reset":tips.forEach(e=>e.show=!0),saveTipStates(),showNotification("Всички подсказки са нулирани.","success");break;case"All":let e=0;const t=()=>{if(document.querySelectorAll(".tip-popup").forEach(e=>e.remove()),e<tips.length){const n=tips[e];e++,createTipElement(n,t)}else showNotification("Приятна работа с CX-Calc!","success"),tutorialSkinSwitch&&(memoryShow(4),tutorialSkinSwitch=!1)};t();break;case"newOnly":tips.filter(e=>e.show).forEach(e=>createTipElement(e));break;default:const n=tips.find(e=>e.show);n&&createTipElement(n)}}