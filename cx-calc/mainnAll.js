const rows=5,cols=4,container=document.querySelector(".calculator-container"),displaylv=document.querySelector("#levInput"),display=document.querySelector("#eurInput");var calculator=null,calcBottom=0,calcLeft=0,calcRight=0,screenWidth=window.innerWidth,imageWidth,imageHeight,aspectRatioW,aspectRatioH,imageWidthO,imageHeightO,userInput="",ovFlag=!1,fullscrFlag=!1,keys=displayCoords=[],Mem=[0,0,0,0],levMode=!0,isStandalone=!1,MainPoints={};let modalIsActive=!1,layoutSettingsVisible=!1;var showWarning=!1,tipsEnabled=!0;let installPromptWasShown=!1,audioContext,clickBuffer=null;var handMode="right";const MAX_HISTORY_ITEMS=30,historyButton=document.getElementById("historyButton"),recallButton=document.getElementById("recallButton"),settingsModal=document.getElementById("settingsModal"),historyList=document.getElementById("historyList"),closeHistoryModalButton=document.getElementById("closeHistoryModalButton"),closeHelpModalButton=document.getElementById("closeHelpModalButton"),clearHistoryButton=document.getElementById("clearHistoryButton"),closeHelpModalButtonTop=document.getElementById("closeHelpModalButtonTop"),ctoverlay=document.getElementById("ctoverlay");ctoverlay.addEventListener("contextmenu",e=>e.preventDefault());var MainPointsO={Keys:{x:43,y:235},KeySize:{x:84,y:70},KbdGaps:{x:13,y:13},Display:{x:102,y:33},Displaylv:{x:102,y:110},DisplaySize:{x:312,y:57},Status:{x:-10,y:185},StatusSize:{x:45,y:15},CurrencyOffset:{x:-40,y:15},CurrencyLevOffset:{x:-40,y:15}};const keyMapR=[["L","€","C","B"],["7","8","9","="],["4","5","6","+"],["1","2","3","-"],["0",",","/","*"]],keyMapL=[["B","C","€","L"],["=","7","8","9"],["+","4","5","6"],["-","1","2","3"],["*","/",",","0"]];var keyMap=keyMapR;const defaultSettings={exchangeRate:1.95583,currencySymbol:"€",currencyLevSymbol:"лв.",soundEffectsEnabled:!1,showRateWarningEnabled:!0,calcBottomOffset:0,calcLeftOffset:0,calcRightOffset:0,initialDisplay:"lev",handMode:"right",tipsEnabled:!0,pwaInstallDeclined:!1,calculatorSkin:"Calculator0.png"};var EXCHANGE_RATE=defaultSettings.exchangeRate,CURRENCY_SYMBOL=defaultSettings.currencySymbol,CURRENCY_LEV_SYMBOL=defaultSettings.currencyLevSymbol,showRateWarningEnabled=defaultSettings.showRateWarningEnabled,soundEffectsEnabled=defaultSettings.soundEffectsEnabled,tutorialSkinSwitch=!1,originalOnloadHandler=null;function saveSettings(){settingsModal.style.opacity="1";for(const e in MainPointsO)if(MainPointsO.hasOwnProperty(e)){const t=MainPointsO[e];if("object"==typeof t&&null!==t)for(const n in t)if(t.hasOwnProperty(n)){const o=e.toLowerCase()+n.toUpperCase(),l=document.getElementById(o);if(l){const e=parseFloat(l.value);isNaN(e)||(t[n]=e)}}}localStorage.setItem("CXCalc_MainPointsO",JSON.stringify(MainPointsO));const e=JSON.parse(localStorage.getItem("CXCalc_appSettings"))||defaultSettings,t={exchangeRate:parseFloat(document.getElementById("exchangeRateInput").value)||defaultSettings.exchangeRate,currencySymbol:document.getElementById("currencySymbolInput").value.trim()||defaultSettings.currencySymbol,currencyLevSymbol:document.getElementById("currencyLevSymbolInput").value.trim()||defaultSettings.currencyLevSymbol,showRateWarningEnabled:document.getElementById("rateWarningCheckbox").checked,soundEffectsEnabled:document.getElementById("soundEffectsCheckbox").checked,calcBottomOffset:parseInt(document.getElementById("calcBottomOffset_hidden").value,10)||0,calcLeftOffset:parseInt(document.getElementById("calcLeftOffset_hidden").value,10)||0,calcRightOffset:parseInt(document.getElementById("calcRightOffset_hidden").value,10)||0,initialDisplay:document.getElementById("initialDisplayLev").checked?"lev":"eur",handMode:document.getElementById("handModeLeft").checked?"left":"right",pwaInstallDeclined:e.pwaInstallDeclined||defaultSettings.pwaInstallDeclined,calculatorSkin:e.calculatorSkin||defaultSettings.calculatorSkin,tipsEnabled:!1};localStorage.setItem("CXCalc_appSettings",JSON.stringify(t)),keyMap="left"===handMode?keyMapL:keyMapR,console.log("Настройките са запазени. Страницата ще бъде презаредена."),location.reload()}function populateLayoutSettings(){for(const e in MainPointsO)if(MainPointsO.hasOwnProperty(e)){const t=MainPointsO[e];if("object"==typeof t&&null!==t)for(const n in t)if(t.hasOwnProperty(n)){const o=e.toLowerCase()+n.toUpperCase(),l=document.getElementById(o);l?l.value=t[n]:console.warn(`Input element with ID '${o}' not found for MainPointsO.${e}.${n}`)}}const e=document.getElementById("exchangeRateInput");e&&(e.value=EXCHANGE_RATE);const t=document.getElementById("calcBottomOffset_hidden");if(t){const e=getComputedStyle(document.documentElement).getPropertyValue("--calc-bottom-offset").trim()||"0px";t.value=parseInt(e,10),document.getElementById("calcBottomOffset").value=t.value,t.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--calc-bottom-offset",`${t}px`),setTimeout(calcResize,200)})}const n=document.getElementById("calcLeftOffset_hidden");if(n){const e=getComputedStyle(document.documentElement).getPropertyValue("--calc-left-offset").trim()||"0px";n.value=parseInt(e,10),document.getElementById("calcLeftOffset").value=n.value,n.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--calc-left-offset",`${t}px`),setTimeout(calcResize,200)})}const o=document.getElementById("calcRightOffset_hidden");o&&(o.value=calcRight,document.getElementById("calcRightOffset").value=calcRight,o.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--calc-right-offset",`${t}px`),setTimeout(calcResize,200)}));const l=document.getElementById("currencySymbolInput");l&&(l.value=CURRENCY_SYMBOL);const s=document.getElementById("currencyLevSymbolInput");s&&(s.value=CURRENCY_LEV_SYMBOL);const i=document.getElementById("rateWarningCheckbox");i&&(i.checked=showRateWarningEnabled);const a=document.getElementById("soundEffectsCheckbox");a&&(a.checked=soundEffectsEnabled);const r=document.getElementById("initialDisplayEur"),c=document.getElementById("initialDisplayLev");r&&c&&(levMode?c.checked=!0:r.checked=!0);const u=document.getElementById("handModeRight"),d=document.getElementById("handModeLeft");u&&d&&("left"===handMode?d.checked=!0:u.checked=!0);const p=document.getElementById("help-footer-info"),y=localStorage.getItem("CXCalc_appVersion");if(p){const e=y||"N/A";p.innerHTML=`Версия ${e} &bull; Контакт: <a href="mailto:cx.sites.online@gmail.com" style="color: inherit; text-decoration: none;">cx.sites.online@gmail.com</a>`}}function loadSettings(){const e=JSON.parse(localStorage.getItem("CXCalc_appSettings")),t={...defaultSettings,...e};EXCHANGE_RATE=t.exchangeRate,CURRENCY_SYMBOL=t.currencySymbol,CURRENCY_LEV_SYMBOL=t.currencyLevSymbol,showRateWarningEnabled=t.showRateWarningEnabled,tipsEnabled=t.tipsEnabled,soundEffectsEnabled=t.soundEffectsEnabled,calcBottom=t.calcBottomOffset,calcLeft=t.calcLeftOffset,calcRight=t.calcRightOffset,levMode="lev"===t.initialDisplay,handMode=t.handMode,keyMap="left"===handMode?keyMapL:keyMapR;const n=JSON.parse(localStorage.getItem("CXCalc_CalcMem"));if(n&&Array.isArray(n)&&(Mem=n),calculator&&t.calculatorSkin){let e=t.calculatorSkin;"left"===handMode&&(e=e.replace(".png","L.png")),calculator.src=e}document.documentElement.style.setProperty("--calc-bottom-offset",`${calcBottom}px`),document.documentElement.style.setProperty("--calc-left-offset",`${calcLeft}px`),document.documentElement.style.setProperty("--calc-right-offset",`${calcRight}px`),EXCHANGE_RATE!==defaultSettings.exchangeRate&&(showWarning=!0);const o=localStorage.getItem("CXCalc_MainPointsO");if(o){const e=JSON.parse(o);for(const t in MainPointsO)e[t]&&Object.assign(MainPointsO[t],e[t]);console.log("Заредени и допълнени MainPointsO от loadSettings():")}}function getImageSize(){calculator?(imageWidthO=calculator.naturalWidth,imageHeightO=calculator.naturalHeight):console.log("Изображението не е намерено!")}function getImageVisualSize(){let e=document.body.clientWidth,t=document.body.clientHeight;if(!calculator)return void console.error("Грешка: Не е намерено изображението.");let n=calculator.naturalWidth/calculator.naturalHeight;"cover"===calculator.style.objectFit?(imageWidth=e,imageHeight=t):"contain"===calculator.style.objectFit?e/t>n?(imageHeight=t,imageWidth=Math.round(t*n),console.log("(contain) - Изображението е по-широко от контейнера, използваме височината на контейнера.")):(imageWidth=e,imageHeight=Math.round(e/n),console.log("(contain) - Изображението е по-високо от контейнера, използваме ширината на контейнера.")):(imageWidth=calculator.width,imageHeight=calculator.height),aspectRatioW=imageWidth/imageWidthO,aspectRatioH=imageHeight/imageHeightO,console.log("aspectRatioW = ",aspectRatioW,"   aspectRatioH = ",aspectRatioH)}function getKeyValue(e,t){return keyMap[e][t]}function formatNumber(e){return isNaN(e)?"":e.toFixed(2).replace(".",",")}function parseNumber(e){return e?(e=e.replace(/\s+/g,""),parseFloat(e.replace(",","."))):NaN}function convertFromLevToEur(e){let t=parseNumber(e);if(isNaN(t))return"";return formatNumber(t/EXCHANGE_RATE)}function convertFromEurToLev(e){let t=parseNumber(e);if(isNaN(t))return"";return formatNumber(t*EXCHANGE_RATE)}function groupByThree(e,t){if(null==e||""==e)return"";let n=e.replace(/\s+/g,"").split(","),o=n[0];""==o&&(o="0");let l=n.length>1?","+n[1]:"",s=[];for(let e=o.length;e>0;e-=3){let t=Math.max(e-3,0);s.unshift(o.slice(t,e))}return t&&(""===l||","===l?l=",00":2===l.length&&(l+="0")),s=s.join(" ")+l,s=s.replace(/^-\s(?=\d)/,"-"),s}function canAddCharacter(e,t){return!/(\d+,\d{2})(?![+\-*/])/.test(e)||!/\d/.test(t)}function updateDisplays(e,t,n){const o=/[+\-*/]/.test(e.slice(1))||e.includes("(")||e.includes(")"),[l,s]=levMode?[displaylv,display]:[display,displaylv],i=levMode?convertFromLevToEur:convertFromEurToLev;let a;if(l.classList.add("active-display"),s.classList.remove("active-display"),""===e)a="";else if(o)a=t;else{const t=e.includes(","),o=t?e.split(",")[1]:"",l=!t;a="B"===n?groupByThree(e,!!l):l||0===o.length||1===o.length?groupByThree(e,!0):groupByThree(e,!1)}if(l.textContent=a,o)s.textContent="";else{const t=i(e);s.textContent=groupByThree(t,!0)}adjustFontSize(l,s)}function toggleDisplayMode(){const e=(levMode=!levMode)?displaylv.textContent:display.textContent;(userInput=e.replace(/\s/g,"")).endsWith(",00")&&(userInput=userInput.slice(0,-3)),console.log("Променен режим - userInput:",userInput),updateDisplays(userInput,userInput.replace(/\*/g,"×").replace(/\//g,"÷"),"L")}function balanceBrackets(e){let t=0;for(const n of e)"("===n?t++:")"===n&&t--;return e+")".repeat(Math.max(0,t))}function addImplicitMultiplication(e){return e.replace(/(\d)(?=\()/g,"$1*").replace(/(?<=\))(\d)/g,"*$1").replace(/\)\( /g,")*(")}function appendNumber(value){var oldUserInput="";const display=document.getElementById("eurInput"),displaylv=document.getElementById("levInput");if("€"===value)return void historyOpen();if("L"===value)return void toggleDisplayMode();if("C"===value)display.textContent="",displaylv.textContent="",userInput="";else if("B"===value)userInput=userInput.slice(0,-1);else if("="===value){if(!/[+\-*/]$/.test(userInput)&&userInput.length>0)try{let formattedInput=userInput.replace(/,/g,".");oldUserInput=userInput.replace(/\*/g,"×").replace(/\//g,"÷").replace(/,/g,"."),formattedInput=addImplicitMultiplication(balanceBrackets(formattedInput));let result=eval(formattedInput);result=parseFloat(result).toFixed(2),userInput=result.toString().replace(/\./g,","),navigator.clipboard.writeText(userInput).then(()=>{console.log("Резултатът е копиран в клипборда! ✅")}).catch(e=>{console.error("Грешка при копиране в клипборда:",e)})}catch(e){console.error("Грешка в изчисленията",e)}}else{const lastOperatorIndex=Math.max(userInput.lastIndexOf("+"),userInput.lastIndexOf("-"),userInput.lastIndexOf("*"),userInput.lastIndexOf("/")),currentNumber=-1===lastOperatorIndex?userInput:userInput.slice(lastOperatorIndex+1);if(","===value&&currentNumber.includes(","))return;if((/\d/.test(value)||","===value)&&currentNumber.includes(",")){const e=currentNumber.split(",")[1]||"";if(e.length>=2)return}if(/[+\-*/]/.test(value)&&(0===userInput.length||/[+\-*/]$/.test(userInput)))return;let match=userInput.match(/([\d,]+[+\-*/])([\d,]+)/);if(match&&/[+\-*/]/.test(value))try{let formattedInput=userInput.replace(/,/g,".");oldUserInput=userInput.replace(/\*/g,"×").replace(/\//g,"÷").replace(/,/g,"."),formattedInput=addImplicitMultiplication(balanceBrackets(formattedInput)),console.log("2-Изчисляване на:",formattedInput);let result=eval(formattedInput);userInput=parseFloat(result).toFixed(2).replace(/\./g,",")+value;let levValue=parseNumber(displaylv.textContent),eurValue=parseNumber(display.textContent);addHistoryEntry(oldUserInput,result,"no")}catch(e){console.error("Грешка в изчисленията",e)}else"0"!==currentNumber||","===value||/[+\-*/]/.test(value)?canAddCharacter(userInput,value)&&(userInput+=value):userInput=userInput.slice(0,-1)+value}const formattedUserInput=userInput.replace(/\*/g,"×").replace(/\//g,"÷");if(updateDisplays(userInput,formattedUserInput,value),"="===value){let e=parseNumber(displaylv.textContent),t=parseNumber(display.textContent);""!==e&&""!==t&&addHistoryEntry(oldUserInput,e,t)}userInput.endsWith(",00")&&(userInput=userInput.slice(0,-3)),console.log("userInput = ",userInput)}function getKeyColumnIndex(e){const t=calculator.getBoundingClientRect(),n=MainPoints.KeySize.x+MainPoints.KbdGaps.x,o=(e.x-t.left-MainPoints.Keys.x)/n;return Math.round(o+1)}function controlActions(key){if("+"===key.value)fullscrFlag?exitFullscreen():goFullscreen(),fullscrFlag=!fullscrFlag;else if("*"===key.value)console.log("Before %: ",userInput),userInput=userInput.replace(",","."),userInput=eval(userInput),userInput=(parseFloat(userInput)/100).toFixed(2).replace(".",","),appendNumber("=");else if("-"===key.value){if(/[+\-*/]$/.test(userInput))return;if(userInput=userInput.startsWith("-")?userInput.slice(1):"-"+userInput,userInput=userInput.replace(",","."),/[+\-*/]$/.test(userInput))return;userInput=eval(userInput),userInput=parseFloat(userInput).toFixed(2).replace(".",","),appendNumber("=")}}async function initAudio(){if(soundEffectsEnabled)try{audioContext=new(window.AudioContext||window.webkitAudioContext);const e=await fetch("click.wav"),t=await e.arrayBuffer();clickBuffer=await audioContext.decodeAudioData(t),console.log("Аудио файлът е кеширан и готов за възпроизвеждане.")}catch(e){console.error("Web Audio API не се поддържа или възникна грешка при инициализация.",e),soundEffectsEnabled=!1}}function playClickSound(){if(!soundEffectsEnabled||!clickBuffer||!audioContext)return;"suspended"===audioContext.state&&audioContext.resume();const e=audioContext.createBufferSource();e.buffer=clickBuffer,e.connect(audioContext.destination),e.start(0)}function getKeyDimensions(){const e=calculator.getBoundingClientRect(),t=e.width/imageWidthO,n=e.height/imageHeightO;return{keyWidth:MainPointsO.KeySize.x*t,keyHeight:MainPointsO.KeySize.y*n}}function isWithinKeyBounds(e,t,n,o){return e.clientX>=t.x&&e.clientX<=t.x+n&&e.clientY>=t.y&&e.clientY<=t.y+o}function handleStatusZones(e,t){for(let n=1;n<=4;n++){const o=document.getElementById(`statusArea${n}`);if(!o)continue;if(getComputedStyle(o).opacity>0||4===n){const l=o.getBoundingClientRect();if(e.clientX>=l.left&&e.clientX<=l.right&&e.clientY>=l.top&&e.clientY<=l.bottom){if(4===n){if(t)memoryShow(4);else{const e=document.getElementById("helpModal");e&&(e.classList.remove("show-content"),e.style.display="flex",modalIsActive=!0,setTimeout(()=>{"flex"===e.style.display&&e.classList.add("show-content")},3e3))}return!0}return t?memoryShow(n):memoryRecall(n),!0}}}return!1}function sanitizeAndEvaluateInput(input,operationType){if(/[+\-*/]$/.test(input))return null;input=input.replace(",",".");let result=eval(input);return"percent"===operationType?result/=100:"negate"===operationType&&(result=input.startsWith("-")?input.slice(1):"-"+input,result=eval(result)),parseFloat(result).toFixed(2).replace(".",",")}function goFullscreen(){const e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}function exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}function toggleFullscreen(){fullscrFlag?exitFullscreen():goFullscreen(),fullscrFlag=!fullscrFlag}function clearAllMemory(){for(let e=1;e<4;e++)Mem[e]=0,clearStatus(e);localStorage.setItem("CXCalc_CalcMem",JSON.stringify(Mem))}async function pasteNumber(){try{const e=await navigator.clipboard.readText(),t=e.replace(/(?<=\d)\s+(?=\d)/g,"").match(/-?\d+[.,]?\d*/);if(t){let e=t[0].replace(",","."),n=parseFloat(e).toFixed(2).replace(".",",");const o=n.slice(-1),l=n.slice(0,-1);userInput=l,appendNumber(o)}else console.warn("Не е намерено валидно число в клипборда.")}catch(e){console.error("Грешка при достъп до клипборда:",e)}}function switchNumber(){appendNumber("="),appendNumber("C"),appendNumber("L"),pasteNumber()}function getCurrentDateTimeInfo(){const e=new Date;return`${["неделя","понеделник","вторник","сряда","четв.","петък","събота"][e.getDay()]}, 📆${`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`}, ${`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}⌚`}function allClear(){appendNumber("C"),userInput="",Mem=[0,0,0,0],localStorage.setItem("CXCalc_CalcMem",JSON.stringify(Mem)),document.getElementById("clearHistoryButton").click()}function resetCalc(){confirm("Сигурни ли сте, че искате да върнете първоначалните настройки?")&&("function"==typeof clearHistory&&(clearHistory(),console.log("Историята е изтрита.")),localStorage.removeItem("CXCalc_MainPointsO"),localStorage.removeItem("CXCalc_appSettings"),console.log("Всички запазени настройки (CXCalc_MainPointsO, CXCalc_appSettings) са изтрити."),location.reload())}function handleCalculatorInteraction(e,t={}){if(modalIsActive)return;let n=!1;const{keyWidth:o,keyHeight:l}=getKeyDimensions();if(keys.forEach(s=>{if(isWithinKeyBounds(e,s,o,l)){n=!0;const o=s.value;if((e.ctrlKey||t.allowWithoutCtrl)&&"€"===o)ovFlag&&(noOverlay(),ovFlag=!1),settingsModal.style.display="flex",modalIsActive=!0,populateLayoutSettings();else if((e.ctrlKey||t.allowWithoutCtrl)&&"B"===o)clearAllMemory();else if((e.ctrlKey||t.allowWithoutCtrl)&&"0"===o)appendNumber("(");else if((e.ctrlKey||t.allowWithoutCtrl)&&","===o)appendNumber(")");else if((e.ctrlKey||t.allowWithoutCtrl)&&"+"===o)pasteNumber();else if((e.ctrlKey||t.allowWithoutCtrl)&&"/"===o)toggleFullscreen();else if((e.ctrlKey||t.allowWithoutCtrl)&&"L"===o)switchNumber();else if((e.ctrlKey||t.allowWithoutCtrl)&&"C"===o)allClear();else if((e.ctrlKey||t.allowWithoutCtrl)&&"="===o){tempShow(getCurrentDateTimeInfo(),5)}else if((e.ctrlKey||t.allowWithoutCtrl)&&"*"===o){const e=sanitizeAndEvaluateInput(userInput,"percent");null!==e&&(userInput=e,appendNumber("="))}else if((e.ctrlKey||t.allowWithoutCtrl)&&"-"===o){const e=sanitizeAndEvaluateInput(userInput,"negate");null!==e&&(userInput=e,appendNumber("="))}else if((e.ctrlKey||t.allowWithoutCtrl)&&isMemoryKey(o)){executeMemoryAction(o,getKeyColumnIndex(s))}else appendNumber(o)}}),handleStatusZones(e,e.ctrlKey||t.allowWithoutCtrl)&&(n=!0),!n){const t=document.getElementById("levInput"),o=document.getElementById("eurInput"),l=t.getBoundingClientRect(),s=o.getBoundingClientRect(),i=e.clientX>=l.left&&e.clientX<=l.right&&e.clientY>=l.top&&e.clientY<=l.bottom,a=e.clientX>=s.left&&e.clientX<=s.right&&e.clientY>=s.top&&e.clientY<=s.bottom;(i||a)&&(toggleDisplayMode(),n=!0)}if(!n&&(e.ctrlKey||t.allowWithoutCtrl)){const t=document.getElementById("calculatorContainer").getBoundingClientRect();(e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom)&&resetCalc()}n&&playClickSound()}let pressTimer;const element=document.getElementById("ctoverlay"),longPressThreshold=500;let isLongPress=!1;var isFullyLoaded=!1;function calcResize(){getImageVisualSize(),scaleMainPoints(aspectRatioW,aspectRatioH);const e=calcNewCoordinates();keys=e.keys,displayCoords=e.displayCoords,adjustFontSize(levInput,eurInput)}function resetLayoutSettingsView(){document.getElementById("Settings1").style.display="grid",document.getElementById("Settings2").style.display="none",document.getElementById("Settings3").style.display="none",document.getElementById("ovBtnSettings").style.display="flex",document.getElementById("closeSettingsModalButton").style.display="flex",layoutSettingsVisible=!1,document.getElementById("mh1").style.display="flex",document.getElementById("mh2").style.display="flex",settingsModal.style.opacity="1.0"}function toggleLayoutSettingsView(){layoutSettingsVisible?(showOv(),setTimeout(()=>{resetLayoutSettingsView(),ovFlag=!0,showOv()},5e3)):(document.getElementById("Settings1").style.display="none",document.getElementById("Settings2").style.display="grid",document.getElementById("settingsModal").style.opacity="1.0",document.getElementById("closeSettingsModalButton").hidden=!1,layoutSettingsVisible=!0)}function showOv(){if(ovFlag)noOverlay(),ovFlag=!1;else{const e=calcNewCoordinates();displayCoords=e.displayCoords,placeKeys(keys,displayCoords),ovFlag=!0}settingsModal.style.display="none",setTimeout(()=>{modalIsActive=!1},0)}function closeHelpModal(e){helpModal.style.display="none",setTimeout(()=>{modalIsActive=!1},0),e.stopPropagation(),e.preventDefault()}let deferredPrompt;function setupDismissablePrompt(e,t,n,o,l=20){e.style.display="flex";let s,i,a=l;o&&(o.textContent=` (${a})`);const r=()=>{if(clearInterval(s),e.style.display="none",t.removeEventListener("click",c),n&&n.removeEventListener("click",u),"install-bar"===e.id){document.getElementById("install").removeEventListener("click",i)}},c=()=>{r()},u=()=>{localStorage.setItem("CXCalc_pwaInstallDeclined","true"),r()};if(i=()=>{deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(()=>{deferredPrompt=null})),r()},t.addEventListener("click",c,{once:!0}),n&&n.addEventListener("click",u,{once:!0}),"install-bar"===e.id){document.getElementById("install").addEventListener("click",i,{once:!0})}s=setInterval(()=>{a--,o&&(o.textContent=` (${String(a).padStart(2,"0")})`),a<=0&&r()},1e3)}function showNotification(e,t="info",n=3e3,o=!1){const l=document.querySelector(".custom-notification");l&&document.body.removeChild(l);const s=document.createElement("div");s.className="custom-notification",s.textContent=e;const i={info:"#0078d4",success:"#107c10",error:"#d13438"};s.style.background=i[t]||i.info,Object.assign(s.style,{position:"fixed",top:"10px",left:"50%",transform:"translateX(-50%)",color:"#fff",padding:"12px 20px",borderRadius:"6px",boxShadow:"0 2px 6px rgba(0,0,0,0.2)",zIndex:"9999",fontFamily:"sans-serif",opacity:"0",transition:"opacity 0.5s ease-in-out",width:"80%",maxWidth:"300px",textAlign:"center"}),document.body.appendChild(s),setTimeout(()=>{s.style.opacity="1"},10),setTimeout(()=>{s.style.opacity="0",setTimeout(()=>{o?window.location.reload():document.body.contains(s)&&document.body.removeChild(s)},500)},n)}async function getFileSizeFromServer(e){try{const t=await fetch(e,{method:"HEAD",cache:"no-store"});if(t.ok){const e=t.headers.get("Content-Length");return e?parseInt(e,10):null}}catch(t){console.error(`Error fetching size for ${e}:`,t)}return null}async function storeCurrentFileSizes(){const e=["index.html","mainAll.js","style.css"],t={};for(const n of e)try{const e=await fetch(n);if(e.ok){const o=await e.blob();t[n]=o.size}else console.warn(`Could not get size for ${n}: ${e.status}`),t[n]=null}catch(e){console.error(`Error getting current size for ${n}:`,e),t[n]=null}localStorage.setItem("CXCalc_fileSizes",JSON.stringify(t)),console.log("Stored current file sizes:",t)}function checkForUpdates(){const e=document.getElementById("checkVersionBtn");if(!navigator.onLine)return void showNotification("Няма връзка с интернет. Проверката е невъзможна.","error");if(!("serviceWorker"in navigator))return void showNotification("Service Worker не се поддържа.","error");const t=e.querySelector("span"),n=t?t.textContent:"Провери за версия";function o(){setTimeout(()=>{t&&(t.textContent=n),e.disabled=!1},3e3)}t&&(t.textContent="Проверява се..."),e.disabled=!0,navigator.serviceWorker.getRegistration().then(async e=>{if(!e)return showNotification("Service Worker не е регистриран.","error"),void o();const t=["index.html","mainAll.js","style.css"];let n=!1;const l=JSON.parse(localStorage.getItem("CXCalc_fileSizes"))||{},s={};for(const e of t){const t=await getFileSizeFromServer(e);if(s[e]=t,console.log(`File: ${e}, Stored Size: ${l[e]}, Server Size: ${t}`),null!==t&&l[e]!==t){console.log(`Размерът на ${e} се различава. Нужен е ъпдейт.`),n=!0;break}}n?(console.log("Налична е нова версия въз основа на разлики в размера на файловете."),e.update().then(()=>{e.installing?(console.log("SW: Намерен е нов service worker, инсталира се..."),showNotification("Инсталира се нова версия. Презареждане...","info",4e3,!0)):e.waiting?(console.log("SW: Намерен е чакащ service worker. Изпраща се команда за активиране..."),e.waiting.postMessage({type:"SKIP_WAITING"}),showNotification("Активира се нова версия. Презареждане...","info",4e3,!0)):(console.log("SW update triggered, but no new/waiting SW found immediately."),showNotification("Проверка за нова версия завърши.","info",4e3,!1),o()),localStorage.setItem("CXCalc_fileSizes",JSON.stringify(s))}).catch(e=>{console.error("Грешка при стартиране на SW update:",e),showNotification("Грешка при инсталиране на нова версия.","error"),o()})):(console.log("Вие използвате последната версия (размерите на файловете съвпадат)."),showNotification("Вие използвате последната версия.","success"),o())}).catch(e=>{console.error("Грешка при проверка за нова версия:",e),showNotification("Грешка при проверката за нова версия.","error"),o()})}function updateMemoryStatusDisplay(e,t){const n=document.getElementById(`statusArea${e}`);n&&(n.style.backgroundColor=t?"rgb(225, 250, 4)":"#565749")}function isMemoryKey(e){return/^[1-9]$/.test(e)||["*","/","-"].includes(e)}function memoryAdd(e,t="+"){const n=(levMode?displaylv:display).textContent.trim().replace(/\s/g,"").replace(",",".");let o=parseFloat(n);switch(isNaN(o)&&(o=0),void 0===Mem[e]&&(Mem[e]=0),t){case"+":Mem[e]+=o,console.log(`M+ в Mem[${e}] → +${o} = [${Mem}]`),updateMemoryStatusDisplay(e,!0),setTimeout(()=>{updateMemoryStatusDisplay(e,!1)},300);break;case"-":Mem[e]-=o,console.log(`M− в Mem[${e}] → −${o} = [${Mem}]`),updateMemoryStatusDisplay(e,!0),setTimeout(()=>{updateMemoryStatusDisplay(e,!1)},300);break;case"0":Mem[e]=0,console.log(`0 в Mem[${e}] → +${o} = [${Mem}]`);break;default:console.warn("❗ Непозната операция:",t)}localStorage.setItem("CXCalc_CalcMem",JSON.stringify(Mem));const l="number"==typeof e?`statusArea${e}`:e,s=document.getElementById(l);s&&(s.textContent="M"+e,s.style.opacity="1")}function executeMemoryAction(e,t){switch(t){case 1:switch(e){case"1":memoryAdd(1,"+");break;case"4":memoryAdd(1,"-");break;case"7":memoryAdd(1,"0"),clearStatus(t)}break;case 2:switch(e){case"2":memoryAdd(2,"+");break;case"5":memoryAdd(2,"-");break;case"8":memoryAdd(2,"0"),clearStatus(t)}break;case 3:switch(e){case"3":memoryAdd(3,"+");break;case"6":memoryAdd(3,"-");break;case"9":memoryAdd(3,"0"),clearStatus(t)}}}function tempShow(e,t=1){displaylv.textContent;const n=display.textContent,o=(displaylv.style.backgroundColor,display.style.backgroundColor);display.textContent=e,adjustFontSize(displaylv,display),display.style.backgroundColor="rgba(255, 223, 186, 0.5)",setTimeout(()=>{display.textContent=n,display.style.backgroundColor=o,adjustFontSize(displaylv,display)},1e3*t)}function memoryShow(e,t){if(4==e){const e=document.getElementById("calculator");let n="Calculator0.png",o="CalculatorA.png";"left"===handMode&&(n="Calculator0L.png",o="CalculatorAL.png");const l=e.src.includes(o)?n:o;originalOnloadHandler||(originalOnloadHandler=e.onload);const s=tipsEnabled;if(tipsEnabled=!1,e.onload=()=>{"function"==typeof originalOnloadHandler&&originalOnloadHandler(),tipsEnabled=s,"function"==typeof t&&t(),e.onload=originalOnloadHandler},e.src=l,!tutorialSkinSwitch){const e=JSON.parse(localStorage.getItem("CXCalc_appSettings"))||defaultSettings;e.calculatorSkin=l.endsWith("L.png")?l.replace("L.png",".png"):l,localStorage.setItem("CXCalc_appSettings",JSON.stringify(e))}return}if(void 0===Mem[e])return void console.warn(`Памет Mem[${e}] е недефинирана.`);tempShow(groupByThree(formatNumber(Mem[e])))}function memoryRecall(e){if(void 0===Mem[e]||0===Mem[e]||""!==userInput&&!/[+\-*/×÷]$/.test(userInput))return;const t=Mem[e].toString().replace(".",","),n=/[+\-*/×÷(]/.test(userInput+=t),o=levMode?displaylv:display,l=levMode?display:displaylv,s=levMode?convertFromLevToEur:convertFromEurToLev;n?(o.textContent=userInput.replace(/\*/g,"×").replace(/\//g,"÷"),l.textContent=""):(o.textContent=groupByThree(userInput,!0),l.textContent=groupByThree(s(userInput,!0))),console.log(`📟 MR от Mem[${e}] → "${t}" → нов userInput: "${userInput}"`),adjustFontSize(displaylv,display),updateMemoryStatusDisplay(e,!1)}function clearStatus(e){const t="number"==typeof e?`statusArea${e}`:e,n=document.getElementById(t);n&&(n.style.opacity="0")}function scaleMainPoints(e,t){if(MainPointsO)for(const n in MainPointsO){const o=MainPointsO[n];o&&"number"==typeof o.x&&"number"==typeof o.y&&(MainPoints[n]={x:o.x*e,y:o.y*t})}}function positionStatusArea(e,t=!1){const n=e-1,o=calculator.getBoundingClientRect(),l=MainPoints.Keys.x+n*(MainPoints.KeySize.x+MainPoints.KbdGaps.x)+MainPoints.KeySize.x/2,s=document.getElementById(`statusArea${e}`);if(s&&!t&&(s.style.left=o.left+MainPoints.Status.x+l-MainPoints.StatusSize.x/2+"px",s.style.top=`${o.top+MainPoints.Status.y}px`,s.style.width=`${MainPoints.StatusSize.x}px`,s.style.height=`${MainPoints.StatusSize.y}px`),t){const e=document.body,t=document.createElement("div");t.className="overlay-marker",t.style.position="fixed",t.style.left=o.left+MainPoints.Status.x+l-MainPoints.StatusSize.x/2+"px",t.style.top=`${o.top+MainPoints.Status.y}px`,t.style.width=`${2+MainPoints.StatusSize.x}px`,t.style.height=`${2+MainPoints.StatusSize.y}px`,t.style.pointerEvents="none",t.style.backgroundColor="transparent",t.style.border="5px solid yellow",t.style.pointerEvents="none",t.style.zIndex="9999",e.appendChild(t)}}function noOverlay(){document.querySelectorAll(".overlay-marker").forEach(e=>e.remove())}function placeKeys(e,t){const n=document.body;noOverlay(),e.forEach(e=>{const t=document.createElement("div");t.className="overlay-marker",t.style.position="fixed",t.style.left=`${e.x}px`,t.style.top=`${e.y}px`,t.style.width=`${MainPoints.KeySize.x}px`,t.style.height=`${MainPoints.KeySize.y}px`,t.style.backgroundColor="transparent",t.style.border="1px solid yellow",t.style.pointerEvents="none",t.style.zIndex="9999",n.appendChild(t)});for(let e=1;e<5;e++)positionStatusArea(e,!0)}function calcNewCoordinates(){if(!calculator)return console.error("Липсва изображението на калкулатора."),{keys:[],displayCoords:{}};const e=calculator.getBoundingClientRect(),t=document.getElementById("calculatorContainer").getBoundingClientRect(),n={lv:{x:e.left+MainPoints.Displaylv.x,y:e.top+MainPoints.Displaylv.y},eur:{x:e.left+MainPoints.Display.x,y:e.top+MainPoints.Display.y}},o=[];for(let t=0;t<rows;t++)for(let n=0;n<cols;n++)o.push({x:e.left+MainPoints.Keys.x+n*(MainPoints.KeySize.x+MainPoints.KbdGaps.x),y:e.top+MainPoints.Keys.y+t*(MainPoints.KeySize.y+MainPoints.KbdGaps.y),value:getKeyValue(t,n)});[{label:"Долен дисплей",id:"levInput",coords:n.lv},{label:"Горен дисплей",id:"eurInput",coords:n.eur},{label:"Валута",id:"currency",coords:{x:n.eur.x+MainPoints.CurrencyOffset.x,y:n.eur.y+MainPoints.CurrencyOffset.y}},{label:"Валута Лев",id:"currencyLev",coords:{x:n.lv.x+MainPoints.CurrencyLevOffset.x,y:n.lv.y+MainPoints.CurrencyLevOffset.y}}].forEach(({label:e,id:n,coords:o})=>{const l=parseFloat(o?.x),s=parseFloat(o?.y);if(isNaN(l)||isNaN(s))return void console.warn(`⚠️ ${e} получи невалидни координати:`,o);const i=document.getElementById(n);if(i){if(i.title=e,i.style.position="absolute",i.style.left=l-t.left+"px",i.style.top=s-t.top+"px","levInput"===n||"eurInput"===n){const e=i.classList.contains("active-display");i.className="calculator-display",e&&i.classList.add("active-display"),i.style.width=`${MainPoints.DisplaySize.x}px`,i.style.height=`${MainPoints.DisplaySize.y}px`}else if("currency"===n||"currencyLev"===n){const e=24;i.style.fontSize=e*aspectRatioH+"px"}}else console.warn(`⚠️ Елемент с id '${n}' не е намерен.`)});for(let e=1;e<5;e++)positionStatusArea(e);return{keys:o,displayCoords:n}}document.addEventListener("click",function(e){if(isLongPress)return e.preventDefault(),void e.stopPropagation();handleCalculatorInteraction(e)}),document.addEventListener("contextmenu",function(e){e.preventDefault(),isLongPress||(clearTimeout(pressTimer),handleCalculatorInteraction(e,{allowWithoutCtrl:!0}))}),element.addEventListener("touchstart",e=>{isLongPress=!1,pressTimer=setTimeout(()=>{isLongPress=!0;const t=e.touches[0]||e.changedTouches[0];handleCalculatorInteraction({clientX:t.clientX,clientY:t.clientY,ctrlKey:!0},{allowWithoutCtrl:!0}),console.log("Long press detected!")},longPressThreshold)}),element.addEventListener("touchend",e=>{clearTimeout(pressTimer),isLongPress&&e.preventDefault()}),element.addEventListener("touchmove",()=>{clearTimeout(pressTimer)}),document.getElementById("saveSettings").addEventListener("click",function(e){saveSettings(),settingsModal.style.display="none",setTimeout(()=>{modalIsActive=!1},0),e.stopPropagation(),e.preventDefault()}),document.getElementById("closeSettingsModalButton").addEventListener("click",function(e){settingsModal.style.display="none",resetLayoutSettingsView(),setTimeout(()=>{modalIsActive=!1},0),e.stopPropagation(),e.preventDefault()}),window.addEventListener("load",function(){document.body.style.overflow="auto",clearTimeout(loadingTimeout);try{calculator=document.querySelector(".calculator-img");const e=()=>{getImageSize(),getImageVisualSize(),scaleMainPoints(aspectRatioW,aspectRatioH);const e=calcNewCoordinates();keys=e.keys,displayCoords=e.displayCoords,adjustFontSize(displaylv,display)};if(calculator.onload=e,loadSettings(),calculator.complete&&e(),initAudio(),document.getElementById("currency").textContent=CURRENCY_SYMBOL,document.getElementById("currencyLev").textContent=CURRENCY_LEV_SYMBOL,showWarning&&showRateWarningEnabled){const e=document.getElementById("exchangeRateWarning"),t=t=>{t&&t.stopPropagation(),e.style.display="none",modalIsActive=!1};e.style.display="flex",modalIsActive=!0,document.getElementById("exchangeRateChangeBtn").onclick=function(e){e&&e.stopPropagation();const t=JSON.parse(localStorage.getItem("CXCalc_appSettings"))||defaultSettings;t.exchangeRate=defaultSettings.exchangeRate,localStorage.setItem("CXCalc_appSettings",JSON.stringify(t)),location.reload()},document.getElementById("exchangeRateConfirmBtn").onclick=function(e){t(e)}}"function"==typeof initTips&&"function"==typeof showTips&&(initTips(),tipsEnabled&&setTimeout(()=>{tutorialSkinSwitch=!0,memoryShow(4,showTips)},200));for(let e=1;e<=3;e++)void 0!==Mem[e]&&null!==Mem[e]&&0!==Mem[e]&&memoryAdd(e,"+")}catch(e){console.warn("⚠️ Грешка при инициализация:",e)}document.body.classList.add("ready"),appendNumber("C");const e=document.getElementById("loading-overlay");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500)),isFullyLoaded=!0,console.log("Calculator is fully loaded and ready for interaction."),storeCurrentFileSizes(),isStandalone=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone;const t=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,n="true"===localStorage.getItem("CXCalc_pwaInstallDeclined");if(t&&!isStandalone&&!n){const e=document.getElementById("ios-install-prompt"),t=document.getElementById("dismiss-ios-prompt"),n=document.getElementById("decline-ios-install"),o=document.getElementById("countdownSpan");e&&t&&n&&(installPromptWasShown=!0,setupDismissablePrompt(e,t,n,o))}appendNumber("C")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{e.target.classList.contains("modal")&&(e.stopPropagation(),"settingsModal"!==e.target.id&&(e.target.style.display="none"),"settingsModal"===e.target.id&&resetLayoutSettingsView(),modalIsActive=!1)}),document.addEventListener("keydown",e=>{const key=e.key;if("Escape"===key||"Esc"===key)return"none"!==settingsModal.style.display&&resetLayoutSettingsView(),historyModal.style.display="none",helpModal.style.display="none",settingsModal.style.display="none",void(modalIsActive=!1);if(modalIsActive)return;if(["Enter","/","*","(",")"].includes(key)&&e.preventDefault(),"%"===key){if(/[+\-*/]$/.test(userInput))return;return userInput=userInput.replace(",","."),userInput=eval(userInput),userInput=(parseFloat(userInput)/100).toFixed(2).replace(".",","),void appendNumber("=")}const keyMap={Enter:"=",Backspace:"B",Delete:"B",".":",",c:"C"};keyMap[key]?appendNumber(keyMap[key]):"0123456789+-*/".includes(key)&&appendNumber(key)});const checkVersionBtn=document.getElementById("checkVersionBtn");checkVersionBtn&&checkVersionBtn.addEventListener("click",checkForUpdates);const resetBtn=document.getElementById("resetBtn");resetBtn&&resetBtn.addEventListener("click",resetCalc);const fldSettingsBtn=document.getElementById("fldSettings");fldSettingsBtn&&fldSettingsBtn.addEventListener("click",e=>{e.preventDefault(),document.getElementById("Settings1").style.display="none",document.getElementById("Settings3").style.display="grid",document.getElementById("ovBtnSettings").style.display="none",document.getElementById("closeSettingsModalButton").style.display="none",document.getElementById("mh1").style.display="none",document.getElementById("mh2").style.display="none",document.getElementById("calcBottomOffset").click()});const resetTipsButton=document.getElementById("resetTipsButton");resetTipsButton&&resetTipsButton.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),settingsModal.style.display="none",modalIsActive=!1,resetLayoutSettingsView(),"function"==typeof showTips&&(tutorialSkinSwitch=!0,memoryShow(4,showTips))}),historyList.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault();const t=e.target.closest("li");if(!t||!t.dataset.lev)return;const n=levMode?t.dataset.lev:t.dataset.eur;n&&(updateDisplays(userInput=n.replace(/\s/g,""),userInput,"L"),historyModal.style.display="none",modalIsActive=!1)}),loadHistory(),adjustFontSize(levInput,eurInput)}),window.addEventListener("resize",function(){calcResize()}),closeHelpModalButton&&closeHelpModalButton.addEventListener("click",closeHelpModal),closeHelpModalButtonTop&&closeHelpModalButtonTop.addEventListener("click",closeHelpModal),"serviceWorker"in navigator&&navigator.serviceWorker.register("sww.js").then(e=>{console.log("Service Worker регистриран:",e),navigator.serviceWorker.addEventListener("message",e=>{if("NEW_VERSION_AVAILABLE"===e.data?.type){const t=localStorage.getItem("CXCalc_appVersion"),n=e.data.version;n&&n!==t&&(console.log("Налична е нова версия:",n),localStorage.setItem("CXCalc_appVersion",n),t&&showNotification("Налична е нова версия. Презареждане...","success",4e3,!0))}})}).catch(e=>{console.error("Грешка при регистрация на Service Worker:",e)}),"true"!==localStorage.getItem("CXCalc_pwaInstallDeclined")&&window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e;const t=document.getElementById("install-bar"),n=(document.getElementById("install"),document.getElementById("dismiss-install")),o=document.getElementById("decline-install"),l=document.getElementById("install-countdown");installPromptWasShown=!0,setupDismissablePrompt(t,n,o,l)});let history=[];function loadHistory(){const e=JSON.parse(localStorage.getItem("CXCalc_history"));history=e?e.filter(e=>e.operation&&e.result):[]}function saveHistoryToStorage(){localStorage.setItem("CXCalc_history",JSON.stringify(history))}function addHistoryEntry(e,t,n){const o=groupByThree(formatNumber(t)),l=groupByThree(formatNumber(n));let s=`${o} лв. = ${l}€`;""!=`${groupByThree(formatNumber(t))}`&&""!=`${groupByThree(formatNumber(n))}`||(""===o?s=`${l}`:""===l&&(s=`${o}`)),history.unshift({operation:e,result:s}),history.length>MAX_HISTORY_ITEMS&&(history=history.slice(0,MAX_HISTORY_ITEMS)),saveHistoryToStorage()}function formatExpression(e){return(e=e.replace(/\s+/g,"")).replace(/(\d+(?:[,.]\d+)?)([+\-*/×÷])(\d+(?:[,.]\d+)?)/,(e,t,n,o)=>`${groupByThree(t,!1)} ${n} ${groupByThree(o,!1)}`)}function updateHistoryList(){if(historyList.innerHTML="",0===history.length){const e=document.createElement("li");return e.textContent="Няма запазена история.",void historyList.appendChild(e)}history.forEach(e=>{const t=document.createElement("li");t.style.cursor="pointer";let n="";if(/[+\-*/×÷]/.test(e.operation))n=`${formatExpression(e.operation)} &rarr; ${e.result}`;else{const t=parseFloat(e.operation.replace(",",".")),o=e.result.split("=")[0].replace(/\s/g,"").replace("лв.","").replace(",","."),l=parseFloat(o);n=Math.abs(t-l)>.001&&!isNaN(t)?`${groupByThree(e.operation,!1)} &rarr; ${e.result}`:e.result}if(t.innerHTML=n,e.result.includes("лв")&&e.result.includes("€")){const n=e.result.split("=");t.dataset.lev=n[0].replace("лв.","").trim(),t.dataset.eur=n[1].replace("€","").trim()}else{const n=e.result.replace(/[лв€]/g,"").trim();t.dataset.lev=n,t.dataset.eur=n}historyList.appendChild(t)})}function handleClearHistory(){history=[],saveHistoryToStorage(),updateHistoryList(),closeHistoryModalButton.click()}function historyOpen(){noOverlay(),updateHistoryList(),historyModal.style.display="flex",modalIsActive=!0}function getTextWidth(e,t){const n=document.createElement("span");n.style.visibility="hidden",n.style.position="absolute",n.style.whiteSpace="pre",n.style.fontSize=getComputedStyle(t).fontSize,n.style.fontFamily=getComputedStyle(t).fontFamily,n.style.fontWeight=getComputedStyle(t).fontWeight,n.textContent=e,document.body.appendChild(n);const o=n.offsetWidth;return document.body.removeChild(n),o}function adjustFontSize(e,t){const n=void 0!==e.innerText?e.innerText:e.textContent||"0",o=void 0!==t.innerText?t.innerText:t.textContent||"0";console.log("text1: "+n),console.log("text2: "+o);const l=e.getBoundingClientRect(),s=t.getBoundingClientRect(),i=Math.min(l.width,s.width),a=Math.min(l.height,s.height),r=document.createElement("div");r.style.position="absolute",r.style.visibility="hidden",r.style.height="auto",r.style.width="auto",r.style.whiteSpace="nowrap";const c=getComputedStyle(e);r.style.fontFamily=c.fontFamily,r.style.fontWeight=c.fontWeight,r.style.letterSpacing=c.letterSpacing,r.style.padding="0",r.style.border="none",r.style.boxSizing="border-box",document.body.appendChild(r),r.style.fontSize="48px",r.textContent=n;const u=r.scrollWidth;r.textContent=o;const d=u>=r.scrollWidth?n:o;let p=48;for(;p>=14&&(r.style.fontSize=p+"px",r.textContent=d,!(r.scrollWidth<=i&&r.scrollHeight<=a));)p--;p<14&&(p=14),p--,e.style.fontSize=p+"px",t.style.fontSize=p+"px",document.body.removeChild(r)}function resizeFont(){const e=display.clientHeight;display.style.fontSize=displaylv.style.fontSize=.99*e+"px"}clearHistoryButton&&clearHistoryButton.addEventListener("click",handleClearHistory),closeHistoryModalButton&&closeHistoryModalButton.addEventListener("click",e=>{historyModal.style.display="none",setTimeout(()=>{modalIsActive=!1},0),e.stopPropagation(),e.preventDefault()});const allTips=[{id:"tip-help",text:"Показва подробна помощна информация за разширените функции на калкулатора. Задръжте го, за да се покажат помощни обозначения върху бутоните (на компютър: Ctrl+Клик).",target:"statusArea4"},{id:"tip-history-and-settings",text:"История. Задръжте бутона за отваряне на <b>Настройки</b> (на компютър: Ctrl+Клик).  От <b>Настройки</b> може да определите позицията и размера на калкулатора, така че да е максимално удобен за работа. Може да зададете и предпочитания за работа с дясна или лява ръка.",target:"€"},{id:"tip-display-switch",text:'Клик върху някой от дисплеите превключва активния дисплей (със същото действие е и бутонът <img src="Switch.png">).',target:"display"},{id:"tip-copy",text:"Извлича от съдържанието на клипборда първото число (ако има такова).",target:"+"},{id:"tip-paste",text:"Резултатът от пресмятанията се запомня автоматично в клипборда, така че може лесно да го поставите в други приложения.",target:"display"}];let tips=[];function getTargetCoordinates(e){const t=keys.find(t=>t.value===e);if(t){const e=getKeyDimensions();return{x:t.x,y:t.y,width:e.keyWidth,height:e.keyHeight}}let n=null;return n="display"===e?document.getElementById("levInput"):document.getElementById(e),n?n.getBoundingClientRect():(console.warn(`Could not find a valid target for tip: ${e}`),null)}function initTips(){tips=allTips,console.log("Tips system initialized.")}function createTipElement(e,t){const n=getTargetCoordinates(e.target);if(!n)return void(t&&t());const o=document.body,l=document.createElement("div");l.className="tip-popup",l.id=`popup-${e.id}`,l.innerHTML=`\n            <div class="tip-content">${e.text}</div>\n            <div class="tip-actions">\n                <button class="tip-action-btn tip-next-btn">Следващ</button>\n            </div>\n            <div class="tip-tail"></div>\n        `,o.appendChild(l);const s=e=>{l.contains(e.target)||e.target===l||i(e)};document.addEventListener("click",s),l.addEventListener("click",e=>{e.stopPropagation()});const i=e=>{e&&e.stopPropagation(),o.contains(l)&&o.removeChild(l),document.removeEventListener("click",s),t&&t()},a=n.x+n.width/2,r=l.getBoundingClientRect();let c=n.y-r.height-12,u=a-r.width/2;c<0&&(c=n.y+n.height+12,l.classList.add("tip-below")),u<0&&(u=5),u+r.width>window.innerWidth&&(u=window.innerWidth-r.width-5),l.style.top=`${c}px`,l.style.left=`${u}px`;const d=l.querySelector(".tip-tail");if(d){const e=a-u-20/2;d.style.left=`${e}px`}l.querySelector(".tip-next-btn").addEventListener("click",e=>{i(e)})}function showTips(){const e=document.getElementById("install-bar"),t=document.getElementById("ios-install-prompt");if(e&&"none"!==e.style.display||t&&"none"!==t.style.display)return console.log("Install prompt is visible, delaying tutorial start..."),void setTimeout(showTips,500);if(modalIsActive)return;document.querySelectorAll(".tip-popup").forEach(e=>e.remove());let n=0;const o=()=>{if(document.querySelectorAll(".tip-popup").forEach(e=>e.remove()),n<tips.length){const e=tips[n];n++,createTipElement(e,o)}else(()=>{document.querySelectorAll(".tip-popup").forEach(e=>e.remove()),showNotification("Приятна работа с CX-Calc!","success"),tutorialSkinSwitch&&(memoryShow(4),tutorialSkinSwitch=!1);const e=JSON.parse(localStorage.getItem("CXCalc_appSettings"))||defaultSettings;e.tipsEnabled=!1,localStorage.setItem("CXCalc_appSettings",JSON.stringify(e))})()};o()}document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".offset-input-wrapper"),t=document.getElementById("offsetWheelSpinner"),n=document.querySelector(".wheel-arrow-up"),o=document.querySelector(".wheel-arrow-down"),l=document.querySelector(".wheel-container");if(!t)return;let s=document.querySelector(".offset-input-wrapper.active-offset"),i=s?document.getElementById(s.dataset.inputId):null,a=i?document.getElementById(i.id+"_hidden"):null;function r(e){if(!t)return;t.innerHTML="";const n=document.createDocumentFragment(),o=Math.floor(3.5);for(let t=0;t<7;t++){const l=5*(t-o),s=5*Math.round(e/5)+l,i=document.createElement("div");i.className="wheel-number",i.textContent=s,t===o&&i.classList.add("active"),n.appendChild(i)}t.appendChild(n),t.style.transition="none",t.style.transform=`translateY(-${40*o}px)`,t.offsetHeight,t.style.transition="transform 0.2s ease-out"}function c(e){s&&s.classList.remove("active-offset"),s=e,s.classList.add("active-offset");const t=s.dataset.inputId;i=document.getElementById(t),a=document.getElementById(t+"_hidden");r(parseInt(a.value,10))}function u(e){if(!i||!a)return;let n=parseInt(a.value,10);let o=n+e;if(o<-500&&(o=-500),o>500&&(o=500),o!==n){const n=-40*Math.floor(3.5),l=e>0?-1:1;t.style.transform=`translateY(${n+40*l}px)`,setTimeout(()=>{r(o),i.value=o,a.value=o,a.dispatchEvent(new Event("input",{bubbles:!0}))},200)}}e.forEach(e=>{e.addEventListener("click",()=>c(e))}),n&&n.addEventListener("click",()=>u(5)),o&&o.addEventListener("click",()=>u(-5)),document.addEventListener("keydown",e=>{"none"!==settingsModal.style.display&&document.getElementById("offsetWheel")&&("ArrowUp"===e.key?(e.preventDefault(),u(5)):"ArrowDown"===e.key&&(e.preventDefault(),u(-5)))});let d=0,p=0;l&&(l.addEventListener("touchstart",e=>{d=e.touches[0].clientY},{passive:!0}),l.addEventListener("touchmove",e=>{p=e.touches[0].clientY-d},{passive:!0}),l.addEventListener("touchend",()=>{Math.abs(p)>20&&u(p>0?-5:5),p=0})),s&&c(s)});