<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#BFB8B4">
    <link rel="manifest" href="manifest.webmanifest">
    <title>CX-Calc</title>
   	<link rel="shortcut icon" type="image/png" href="CalcFav.png" />
	<link rel="stylesheet" href="style.css" />
</head>
<body>
    <div id="install-bar" style="
        position:fixed;
        top:0px;
        width:100%;
        z-index:1000;
        display: none;
        justify-content: center;
        gap: 20px;
        padding: 5px;
        background: transparent;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        font-family: sans-serif;
    ">
        <button id="install" style="width: 150px;">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ (20)</button>
        <button id="dismiss" style="width: 150px;">–û—Ç–∫–∞–∑</button>
    </div>

    <!--div id="install-bar" style="position:fixed; top:0px; width:100%; z-index:1000; display:none;">
        <button id="install" style="width: 30%;">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ (20)</button>
        <button id="dismiss" style="width: 30%;">–û—Ç–∫–∞–∑</button>
    </div-->

    <div id="statusArea1" class="statusArea"></div>
    <div id="statusArea2" class="statusArea"></div>
    <div id="statusArea3" class="statusArea"></div>

    <div class="calculator-container" id="calculatorContainer">     
        <img src="Calculator.png" ID="calculator" class="calculator-img" alt="–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä">
        <div id="currency" contenteditable="false" ></div>
        <div id="currencyLev" contenteditable="false" ></div>
        <div id="eurInput" class="calculator-display" contenteditable="false"></div>
        <div id="levInput" class="calculator-display" contenteditable="false"></div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-overlay"></div> <!-- –ó–∞—Å–µ–Ω—á–≤–∞—â–∏—è—Ç —Å–ª–æ–π -->
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
            </div>
            <ul id="historyList">
            </ul>
            <div class="modal-footer" style="margin-top: 15px; display: flex; gap: 10px;">
                <button id="clearHistoryButton" class="action-button secondary" style="flex-grow: 1;">–ò–∑—Ç—Ä–∏–π</button>
                <button id="closeHistoryModalButton" class="action-button" style="flex-grow: 1;">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-overlay"></div> <!-- –ó–∞—Å–µ–Ω—á–≤–∞—â–∏—è—Ç —Å–ª–æ–π -->
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            </div>
            <div class="modal-header">
                <h2>–ö—É—Ä—Å BGN/EUR: <span id="exchangeRateValue">1.95583</span></h2>
            </div>
            <div class="settings-grid">
                <!-- NEW SECTION FOR LAYOUT SETTINGS -->
                <div class="settings-section">
                    <div class="layout-settings-grid">
                        <label for="exchangeRateInput">–í–∞–ª—É—Ç–µ–Ω –∫—É—Ä—Å:</label>
                        <div style="grid-column: 2 / span 2; display: flex; align-items: center; gap: 10px;">
                            <input type="number" style="width: 100px; flex-shrink: 0;" step="0.00001" id="exchangeRateInput" value="1.95583">
                            <label for="rateWarningCheckbox" style="font-size: 0.8em; display: flex; align-items: center; gap: 4px; white-space: nowrap; font-weight: normal; color: var(--settings-label-color);">
                                <input type="checkbox" id="rateWarningCheckbox" checked>
                            </label>
                        </div>
                        <!-- Currency Symbols -->
                        <label>–í–∞–ª—É—Ç–∏:</label>
                        <div style="grid-column: 2 / -1; display: flex; gap: 10px;">
                            <input type="text" id="currencySymbolInput" style="width: 60px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                            <input type="text" id="currencyLevSymbolInput" style="width: 60px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>

                        <!-- New CurrencyOffset -->
                        <label>–û—Ç–º–µ—Å—Ç–≤–∞–Ω–µ –≥–æ—Ä–µ:</label>
                        <input type="number" id="currencyoffsetX" data-key="CurrencyOffset" data-prop="x">
                        <input type="number" id="currencyoffsetY" data-key="CurrencyOffset" data-prop="y">
                        <label>–û—Ç–º–µ—Å—Ç–≤–∞–Ω–µ –¥–æ–ª—É:</label>
                        <input type="number" id="currencylevoffsetX" data-key="CurrencyLevOffset" data-prop="x">
                        <input type="number" id="currencylevoffsetY" data-key="CurrencyLevOffset" data-prop="y">

                        <!-- Initial Display Mode -->
                        <label style="font-weight: bold;">–ê–∫—Ç–∏–≤–µ–Ω –¥–∏—Å–ø–ª–µ–π:</label>
                        <div style="grid-column: 2 / -1; display: flex; justify-content: flex-start; gap: 20px; align-items: center;">
                            <label for="initialDisplayEur" style="font-weight: normal; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="initialDisplay" id="initialDisplayEur" value="eur"> –ì–æ—Ä–µ–Ω
                            </label>
                            <label for="initialDisplayLev" style="font-weight: normal; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="initialDisplay" id="initialDisplayLev" value="lev" checked> –î–æ–ª–µ–Ω
                            </label>
                        </div>
                        <hr style="grid-column: 1 / -1; margin: 10px 0; border: none; border-top: 1px solid #ccc;">
                        <!-- Keys -->
                        <label>–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞:</label>
                        <input type="number" id="keysX" data-key="Keys" data-prop="x">
                        <input type="number" id="keysY" data-key="Keys" data-prop="y">

                        <!-- KeySize -->
                        <label>–†–∞–∑–º–µ—Ä –Ω–∞ –∫–ª–∞–≤–∏—à:</label>
                        <input type="number" id="keysizeX" data-key="KeySize" data-prop="x">
                        <input type="number" id="keysizeY" data-key="KeySize" data-prop="y">

                        <!-- KbdGaps -->
                        <label>–ú–µ–∂–¥—É –∫–ª–∞–≤–∏—à–∏—Ç–µ:</label>
                        <input type="number" id="kbdgapsX" data-key="KbdGaps" data-prop="x">
                        <input type="number" id="kbdgapsY" data-key="KbdGaps" data-prop="y">

                        <!-- DisplaySize -->
                        <label>–†–∞–∑–º–µ—Ä –¥–∏—Å–ø–ª–µ–∏:</label>
                        <input type="number" id="displaysizeX" data-key="DisplaySize" data-prop="x">
                        <input type="number" id="displaysizeY" data-key="DisplaySize" data-prop="y">

                        <!-- Display (EUR) -->
                        <label>–ì–æ—Ä–µ–Ω –¥–∏—Å–ø–ª–µ–π:</label>
                        <input type="number" id="displayX" data-key="Display" data-prop="x">
                        <input type="number" id="displayY" data-key="Display" data-prop="y">

                        <!-- Displaylv (BGN) -->
                        <label>–î–æ–ª–µ–Ω –¥–∏—Å–ø–ª–µ–π:</label>
                        <input type="number" id="displaylvX" data-key="Displaylv" data-prop="x">
                        <input type="number" id="displaylvY" data-key="Displaylv" data-prop="y">

                        <!-- Status -->
                        <label>–ú —Å—Ç–∞—Ç—É—Å–∏:</label>
                        <input type="number" id="statusX" data-key="Status" data-prop="x">
                        <input type="number" id="statusY" data-key="Status" data-prop="y">

                        <!-- StatusSize -->
                        <label>–†–∞–∑–º–µ—Ä –Ω–∞ —Å—Ç–∞—Ç—É—Å:</label>
                        <input type="number" id="statussizeX" data-key="StatusSize" data-prop="x">
                        <input type="number" id="statussizeY" data-key="StatusSize" data-prop="y">

                        <!-- New setting for calculator bottom offset -->
                        <label for="calcBottomOffset">–ü–æ–ª–µ –æ—Ç–¥–æ–ª—É/–ó–≤—É–∫:</label>
                        <div style="grid-column: 2 / -1; display: flex; align-items: center; gap: 15px;">
                            <input type="number" id="calcBottomOffset" min="0" max="500" value="0" style="width: 60px;">
                            <input type="checkbox" id="soundEffectsCheckbox" checked>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button id="ovBtnSettings" class="action-button"  style="margin-right: 20px;" 
                    onclick="showOv()">
                    –ó–æ–Ω–∏</button>
                <button id="closeSettingsModalButton" class="action-button secondary" style="margin-right: 20px;">–ó–∞—Ç–≤–æ—Ä–∏</button>
                <button id="saveSettings" class="action-button">–ó–∞–ø–∏—Å</button>
            </div>
        </div>
    </div>

    <div id="exchangeRateWarning" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:3000; align-items:center; justify-content:center;">
      <div style="background:#fff; color:#b00; padding:32px 24px; border-radius:12px; box-shadow:0 2px 16px #0003; max-width:90vw; text-align:center;">
        <div style="font-size:1.2em; margin-bottom:18px;">
          –í–ù–ò–ú–ê–ù–ò–ï! –í–∞–ª—É—Ç–Ω–∏—è—Ç –∫—É—Ä—Å –µ –ø—Ä–æ–º–µ–Ω–µ–Ω!<br>
          –ü–æ—Ç–≤—ä—Ä–¥–µ—Ç–µ –Ω–æ–≤–∏—è –∫—É—Ä—Å –∏–ª–∏ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ <b>[–§–∏–∫—Å–∏–Ω–≥]</b> –∑–∞ –≤—Ä—ä—â–∞–Ω–µ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—è –∫—É—Ä—Å BGN/EUR.<br>
          –ú–∞—Ö–Ω–µ—Ç–µ –æ—Ç–º–µ—Ç–∫–∞—Ç–∞ –¥–æ –ø–æ–ª–µ <b>–í–∞–ª—É—Ç–µ–Ω –∫—É—Ä—Å</b>, –∑–∞ –¥–∞ –Ω–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞ —Ç–æ–≤–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.
        </div>
        <div style="display:flex; gap:20px; justify-content:center;">
          <button id="exchangeRateConfirmBtn" class="action-button">–ü–æ—Ç–≤—ä—Ä–¥–∏</button>
          <button id="exchangeRateChangeBtn" class="action-button secondary">–§–∏–∫—Å–∏–Ω–≥</button>
        </div>
      </div>
    </div>    

<script src="status.js"></script>
<script src="calc.js"></script>
<script src="history.js"></script>
<script src="fontcalc.js"></script>
<script>
    const rows = 5;
    const cols = 4;
    const container = document.querySelector('.calculator-container');
    const displaylv = document.querySelector('#levInput');
    const display = document.querySelector('#eurInput');
    var calculator = null; // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –Ω–∞ –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞
    var calcBottom = 0;
    var EXCHANGE_RATE = 1.95583;
    var CURRENCY_SYMBOL = '‚Ç¨'; // –í–∞–ª—É—Ç–µ–Ω —Å–∏–º–≤–æ–ª –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
    var CURRENCY_LEV_SYMBOL = '–ª–≤'; // –í–∞–ª—É—Ç–µ–Ω —Å–∏–º–≤–æ–ª –∑–∞ –ª–µ–≤
    var showRateWarningEnabled = true; // –§–ª–∞–≥ –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ—Ç–æ
    var showWarning = false; // –§–ª–∞–≥ –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∑–∞ –∫—É—Ä—Å–∞
    var soundEffectsEnabled = true; // –§–ª–∞–≥ –∑–∞ –∑–≤—É–∫–æ–≤–∏ –µ—Ñ–µ–∫—Ç–∏
    // –ü—Ä–æ–º–µ–Ω–ª–∏–≤–∏ –∑–∞ Web Audio API –∑–∞ –ø–æ-–±—ä—Ä–∑ –∑–≤—É–∫
    let audioContext;
    let clickBuffer = null;

    var screenWidth = window.innerWidth;
    var imageWidth, imageHeight, aspectRatioW, aspectRatioH;
    var imageWidthO, imageHeightO;
    var userInput = "";
    var ovFlag = false, fullscrFlag = false; // –§–ª–∞–≥ –∑–∞ –æ–≤–µ—Ä–ª–µ–π –∏ –ø—ä–ª–µ–Ω –µ–∫—Ä–∞–Ω
    var keys = displayCoords = [];
    var Mem = [0, 0, 0, 0]; // –ú—è—Å—Ç–æ –∑–∞ —Å—ä—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –ø–∞–º–µ—Ç—Ç–∞
    var levMode = true, isStandalone = false; // –ù–∞—á–∞–ª–µ–Ω —Ä–µ–∂–∏–º - –ª–≤.
    var MainPoints = {};
    let modalIsActive = false;

    const MAX_HISTORY_ITEMS = 30;
    const historyButton = document.getElementById('historyButton');
    const recallButton = document.getElementById('recallButton');
    //const hModalOverlay = document.getElementById('hisModalOverlay');
    const settingsModal = document.getElementById('settingsModal');
    const historyList = document.getElementById('historyList');
    const closeHistoryModalButton = document.getElementById('closeHistoryModalButton');

    var MainPointsO = {
        Keys:       {x: 43, y: 235},
        KeySize:    {x: 84, y: 70},
        KbdGaps:    {x: 13, y: 13},
        Display:    {x: 102, y: 33},
        Displaylv:  {x: 102, y: 110},
        DisplaySize:{x: 312, y: 57},
        Status:     {x: -10, y: 185},
        StatusSize: {x: 45, y: 15},
        CurrencyOffset: {x: -40, y: 15},
        CurrencyLevOffset: {x: -40, y: 15}
    };

    // –û–±–µ–∫—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
    const defaultSettings = {
        exchangeRate: 1.95583,
        currencySymbol: '‚Ç¨',
        currencyLevSymbol: '–ª–≤',
        soundEffectsEnabled: true,
        showRateWarningEnabled: true,
        calcMem: [0, 0, 0, 0],
        calcBottomOffset: 0,
        initialDisplay: 'lev', // 'eur' –∏–ª–∏ 'lev'
        pwaInstallDeclined: false
    };

    function saveSettings() {
        // --- –ó–ê–ü–ò–° –ù–ê –ù–ê–°–¢–†–û–ô–ö–ò–¢–ï ---
        // 1. –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–º–µ MainPointsO —Å –Ω–æ–≤–∏—Ç–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª–µ—Ç–∞—Ç–∞
        for (const key in MainPointsO) {
            if (MainPointsO.hasOwnProperty(key)) {
                const obj = MainPointsO[key];
                if (typeof obj === 'object' && obj !== null) {
                    for (const prop in obj) {
                        if (obj.hasOwnProperty(prop)) {
                            const inputId = key.toLowerCase() + prop.toUpperCase();
                            const inputElement = document.getElementById(inputId);
                            if (inputElement) {
                                const newValue = parseFloat(inputElement.value);
                                if (!isNaN(newValue)) {
                                    obj[prop] = newValue;
                                }
                            }
                        }
                    }
                }
            }
        }
        localStorage.setItem('MainPointsO', JSON.stringify(MainPointsO));

        // 2. –°—ä–±–∏—Ä–∞–º–µ –∏ –∑–∞–ø–∏—Å–≤–∞–º–µ –æ—Å—Ç–∞–Ω–∞–ª–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ appSettings
        const currentSettings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;
        // –°—ä–±–∏—Ä–∞–º–µ –∏ –∑–∞–ø–∏—Å–≤–∞–º–µ –æ—Å—Ç–∞–Ω–∞–ª–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ appSettings
        const newAppSettings = {
            exchangeRate: parseFloat(document.getElementById('exchangeRateInput').value) || defaultSettings.exchangeRate,
            currencySymbol: document.getElementById('currencySymbolInput').value.trim() || defaultSettings.currencySymbol,
            currencyLevSymbol: document.getElementById('currencyLevSymbolInput').value.trim() || defaultSettings.currencyLevSymbol,
            showRateWarningEnabled: document.getElementById('rateWarningCheckbox').checked,
            soundEffectsEnabled: document.getElementById('soundEffectsCheckbox').checked,
            calcBottomOffset: parseInt(document.getElementById('calcBottomOffset').value, 10) || 0,
            initialDisplay: document.getElementById('initialDisplayLev').checked ? 'lev' : 'eur',
            calcMem: Mem,
            pwaInstallDeclined: currentSettings.pwaInstallDeclined || defaultSettings.pwaInstallDeclined
        };
        localStorage.setItem('appSettings', JSON.stringify(newAppSettings));

        // --- –ü–†–ò–õ–ê–ì–ê–ù–ï –ù–ê –ü–†–û–ú–ï–ù–ò–¢–ï ---
        // 3. –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–º–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞, –∑–∞ –¥–∞ —Å–µ –ø—Ä–∏–ª–æ–∂–∞—Ç –≤—Å–∏—á–∫–∏ –ø—Ä–æ–º–µ–Ω–∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ
        console.log("–ù–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏. –°—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ —â–µ –±—ä–¥–µ –ø—Ä–µ–∑–∞—Ä–µ–¥–µ–Ω–∞.");
        location.reload();
    }


    // New function to populate layout settings
    function populateLayoutSettings() {
      for (const key in MainPointsO) {
        if (MainPointsO.hasOwnProperty(key)) {
          const obj = MainPointsO[key];
          if (typeof obj === 'object' && obj !== null) {
            for (const prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    // Construct the ID based on the naming convention (e.g., keysX, displayY)
                    const inputId = key.toLowerCase() + prop.toUpperCase();
                    const inputElement = document.getElementById(inputId);
                    if (inputElement) {
                        inputElement.value = obj[prop];
                    } else {
                        console.warn(`Input element with ID '${inputId}' not found for MainPointsO.${key}.${prop}`);
                    }
                }
            }
          }
        }
      }
      // –ü–æ–ø—ä–ª–Ω–∏ exchangeRateInput
      const exchangeRateInput = document.getElementById('exchangeRateInput');
      if (exchangeRateInput) {
          exchangeRateInput.value = EXCHANGE_RATE;
      }
      // –ü–æ–∫–∞–∂–∏ –∏ –≤ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ
      //const exchangeRateValue = document.getElementById('exchangeRateValue');
      //if (exchangeRateValue) exchangeRateValue.textContent = EXCHANGE_RATE;

      const calcBottomOffsetInput = document.getElementById('calcBottomOffset');
      if (calcBottomOffsetInput) {
          // –í–∑–µ–º–∏ —Ç–µ–∫—É—â–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –æ—Ç CSS –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞—Ç–∞ –∏–ª–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ 100
          const val = getComputedStyle(document.documentElement).getPropertyValue('--calc-bottom-offset').trim() || "0px";
          calcBottomOffsetInput.value = parseInt(val, 10);
      }
      // –ü–æ–ø—ä–ª–Ω–∏ currencySymbolInput
      const currencySymbolInput = document.getElementById('currencySymbolInput');
      if (currencySymbolInput) {
          currencySymbolInput.value = CURRENCY_SYMBOL;
      }
      // –ü–æ–ø—ä–ª–Ω–∏ currencyLevSymbolInput
      const currencyLevSymbolInput = document.getElementById('currencyLevSymbolInput');
      if (currencyLevSymbolInput) {
          currencyLevSymbolInput.value = CURRENCY_LEV_SYMBOL;
      }
      // –ü–æ–ø—ä–ª–Ω–∏ rateWarningCheckbox
      const rateWarningCheckbox = document.getElementById('rateWarningCheckbox');
      if (rateWarningCheckbox) {
          rateWarningCheckbox.checked = showRateWarningEnabled;
      }
      // –ü–æ–ø—ä–ª–Ω–∏ soundEffectsCheckbox
      const soundCheckbox = document.getElementById('soundEffectsCheckbox');
      if (soundCheckbox) {
          soundCheckbox.checked = soundEffectsEnabled;
      }
    }

    function loadSettings() {
        const savedSettings = JSON.parse(localStorage.getItem('appSettings'));
        // –°–ª–∏–≤–∞ –∑–∞–ø–∞–∑–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Ç–µ–∑–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ, –∑–∞ –¥–∞ —Å–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞, —á–µ –≤—Å–∏—á–∫–∏ –∫–ª—é—á–æ–≤–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—Ç.
        // –ó–∞–ø–∞–∑–µ–Ω–∏—Ç–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ –∏–º–∞—Ç –ø—Ä–µ–¥–∏–º—Å—Ç–≤–æ.
        const settings = { ...defaultSettings, ...savedSettings };

        // –ü—Ä–∏–ª–∞–≥–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –∫—ä–º –≥–ª–æ–±–∞–ª–Ω–∏—Ç–µ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ
        EXCHANGE_RATE = settings.exchangeRate;
        CURRENCY_SYMBOL = settings.currencySymbol;
        CURRENCY_LEV_SYMBOL = settings.currencyLevSymbol;
        showRateWarningEnabled = settings.showRateWarningEnabled;
        soundEffectsEnabled = settings.soundEffectsEnabled;
        Mem = settings.calcMem;
        calcBottom = settings.calcBottomOffset;
        // –ó–∞–¥–∞–≤–∞–º–µ –∞–∫—Ç–∏–≤–Ω–∏—è –¥–∏—Å–ø–ª–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ —Å–ø–æ—Ä–µ–¥ –∑–∞–ø–∞–∑–µ–Ω–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç
        levMode = (settings.initialDisplay === 'lev');

        // –ü—Ä–∏–ª–∞–≥–∞ –≤–∏–∑—É–∞–ª–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∫–æ–∏—Ç–æ —Å–∞ –Ω—É–∂–Ω–∏ –≤–µ–¥–Ω–∞–≥–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        document.documentElement.style.setProperty('--calc-bottom-offset', `${calcBottom}px`);

        // –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ –¥–∞ –ø–æ–∫–∞–∂–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∑–∞ –∫—É—Ä—Å–∞, –∞–∫–æ –µ —Ä–∞–∑–ª–∏—á–µ–Ω –æ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—è
        if (EXCHANGE_RATE !== defaultSettings.exchangeRate) {
            showWarning = true;
        }

        // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ MainPointsO –æ—Ç localStorage
        const savedMainPointsO = localStorage.getItem('MainPointsO');
        if (savedMainPointsO) {
            const parsedSettings = JSON.parse(savedMainPointsO);
            // –î—ä–ª–±–æ–∫–æ —Å–ª–∏–≤–∞–Ω–µ –Ω–∞ –∑–∞–ø–∞–∑–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Ç–µ–∑–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ.
            // –¢–æ–≤–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞, —á–µ –Ω–æ–≤–∏ —Å–≤–æ–π—Å—Ç–≤–∞ (–∫–∞—Ç–æ CurrencyOffset) —Å–µ –¥–æ–±–∞–≤—è—Ç,
            // –¥–æ—Ä–∏ –∞–∫–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –∏–º–∞ —Å—Ç–∞—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage.
            for (const key in MainPointsO) {
                if (parsedSettings[key]) {
                    // –°–ª–∏–≤–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∏—Ç–µ x/y —Å—Ç–æ–π–Ω–æ—Å—Ç–∏, –∑–∞ –¥–∞ –Ω–µ —Å–µ –≥—É–±—è—Ç
                    Object.assign(MainPointsO[key], parsedSettings[key]);
                }
            }
            console.log("–ó–∞—Ä–µ–¥–µ–Ω–∏ –∏ –¥–æ–ø—ä–ª–Ω–µ–Ω–∏ MainPointsO –æ—Ç loadSettings():");
        }
    }

    function getImageSize() {
        if (calculator) {
            // console.log("–ò–∑–≤–ª–µ—á–µ–Ω –ø—ä—Ç:", calculator.src); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω–∑–æ–ª–∞—Ç–∞
            imageWidthO = calculator.naturalWidth;
            imageHeightO = calculator.naturalHeight;
            // console.log("–û—Ä–∏–≥–∏–Ω–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä (1:1) –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ: W:", imageWidthO, " x H:", imageHeightO);
        } else {
            console.log("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ!");
        }
    }

    function getImageVisualSize() {
        let containerWidth = document.body.clientWidth;
        let containerHeight = document.body.clientHeight;
        if (!calculator) {
            console.error("–ì—Ä–µ—à–∫–∞: –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ.");
            return;
        }
        let aspectRatio = calculator.naturalWidth / calculator.naturalHeight;
        if (calculator.style.objectFit === "cover") {
            imageWidth = containerWidth;
            imageHeight = containerHeight;
        } else if (calculator.style.objectFit === "contain") {
            if (containerWidth / containerHeight > aspectRatio) {
                imageHeight = containerHeight;
                imageWidth = Math.round(containerHeight * aspectRatio);
                console.log("(contain) - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –µ –ø–æ-—à–∏—Ä–æ–∫–æ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∏–∑–ø–æ–ª–∑–≤–∞–º–µ –≤–∏—Å–æ—á–∏–Ω–∞—Ç–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.");
            } else {
                imageWidth = containerWidth;
                imageHeight = Math.round(containerWidth / aspectRatio);
                console.log("(contain) - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –µ –ø–æ-–≤–∏—Å–æ–∫–æ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∏–∑–ø–æ–ª–∑–≤–∞–º–µ —à–∏—Ä–∏–Ω–∞—Ç–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.");
            }
        } else {
            imageWidth = calculator.width;
            imageHeight = calculator.height;
            // console.log("(no contain) - –ò–∑–ø–æ–ª–∑–≤–∞–º–µ –∑–∞–¥–∞–¥–µ–Ω–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ.");
        }
        // console.log("–í–∏–∑—É–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ: W:", imageWidth, " x H:", imageHeight);
        // –ó–∞–º–µ–Ω—è–º–µ window.innerWidth —Å containerWidth
        aspectRatioW = imageWidth / imageWidthO; // aspectRatioW –µ —Å—ä–æ—Ç–Ω–æ—à–µ–Ω–∏–µ—Ç–æ –Ω–∞ —à–∏—Ä–∏–Ω–∞—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –∫—ä–º –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∞—Ç–∞ —à–∏—Ä–∏–Ω–∞
        aspectRatioH = imageHeight / imageHeightO; // aspectRatioH –µ —Å—ä–æ—Ç–Ω–æ—à–µ–Ω–∏–µ—Ç–æ –Ω–∞ –≤–∏—Å–æ—á–∏–Ω–∞—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –∫—ä–º –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∞—Ç–∞ –≤–∏—Å–æ—á–∏–Ω–∞
        // padding –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –≤ canvas, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞ —Å–µ —Ä–∞–≤–µ–Ω –¥–≤—É—Å—Ç—Ä–∞–Ω–Ω–æ
        //StartingPoint.x = ConstX * aspectRatioW + (containerWidth - imageWidth) / 2;
        //StartingPoint.y = ConstY * aspectRatioH + (containerHeight - imageHeight); // (imageHeight / calculator.naturalHeight)
        //console.log("StartingPoint.x = ", StartingPoint.x, "  StartingPoint.y = ", StartingPoint.y);
        console.log("aspectRatioW = ", aspectRatioW, "   aspectRatioH = ", aspectRatioH);
    }

    function getKeyValue(row, col) {
        const keyMap = [
            ["L", "‚Ç¨", "C", "B"],
            ["7", "8", "9", "/"],
            ["4", "5", "6", "*"],
            ["1", "2", "3", "-"],
            ["0", ",", "=", "+"]
        ];
        return keyMap[row][col];
    }

    function formatNumber(num) {
        if (isNaN(num)) return '';
        // .toFixed(2) correctly rounds to 2 decimal places and ensures two decimal digits.
        // Example: 123 -> "123.00", 123.4 -> "123.40", 123.456 -> "123.46"
        return num.toFixed(2).replace('.', ',');
    }

    function parseNumber(str) {
        if (!str) return NaN;
        str = str.replace(/\s+/g, ''); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏—Ç–µ
        return parseFloat(str.replace(',', '.'));
    }

    function convertFromLevToEur(levStr) {
        //levStr = levStr.replace(/\s+/g, ''); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏—Ç–µ
        let levValue = parseNumber(levStr);
        if (isNaN(levValue)) {
            return ''; // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ —Ü–µ–ª–µ–≤–æ—Ç–æ –ø–æ–ª–µ, –∞–∫–æ –∏–∑—Ö–æ–¥–Ω–æ—Ç–æ –µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ
        } else {
            let eurValue = levValue / EXCHANGE_RATE;
            return formatNumber(eurValue);
        }
    }

    function convertFromEurToLev(eurStr) {
        //eurStr = eurStr.replace(/\s+/g, ''); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏—Ç–µ
        let eurValue = parseNumber(eurStr);
        if (isNaN(eurValue)) {
            return ''; // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ —Ü–µ–ª–µ–≤–æ—Ç–æ –ø–æ–ª–µ, –∞–∫–æ –∏–∑—Ö–æ–¥–Ω–æ—Ç–æ –µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ
        } else {
            let levValue = eurValue * EXCHANGE_RATE;
            return formatNumber(levValue);
        }
    }

    function groupByThree(str, dec) { // dec - –¥–∞–ª–∏ –¥–∞ —Å–µ –¥–æ–±–∞–≤–∏ –¥–µ—Å–µ—Ç–∏—á–Ω–∞ —á–∞—Å—Ç
        if (str == null || str == "") return ""; // –ê–∫–æ –≤—Ö–æ–¥—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω
        let cleanedStr = str.replace(/\s+/g, ""); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏—Ç–µ
        let parts = cleanedStr.split(","); // –†–∞–∑–¥–µ–ª—è–º–µ —Ü—è–ª–∞—Ç–∞ –∏ –¥–µ—Å–µ—Ç–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç
        let wholePart = parts[0]; // –¶—è–ª–∞—Ç–∞ —á–∞—Å—Ç –æ—Ç —á–∏—Å–ª–æ—Ç–æ
        if (wholePart == "") wholePart = "0"; // –ê–∫–æ –Ω—è–º–∞ —Ü—è–ª–∞ —á–∞—Å—Ç, –≤—Ä—ä—â–∞–º–µ –ø—Ä–∞–∑–µ–Ω –Ω–∏–∑
        let decimalPart = parts.length > 1 ? "," + parts[1] : ""; // –î–µ—Å–µ—Ç–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç (–∞–∫–æ —è –∏–º–∞)
        let result = [];
        for (let i = wholePart.length; i > 0; i -= 3) {
            let start = Math.max(i - 3, 0);
            result.unshift(wholePart.slice(start, i)); // –ó–∞–ø–∞–∑–≤–∞–º–µ –ø—Ä–∞–≤–∏–ª–Ω–∏—è —Ä–µ–¥
        }
        // Conditional formatting of decimal part based on 'dec' flag
        if (dec) {
            // If 'dec' is true, ensure two decimal places
            if (decimalPart === "" || decimalPart === ",") {
                decimalPart = ",00";
            } else if (decimalPart.length === 2) {
                // If there's only one digit after the comma, add a zero
                decimalPart += "0";
            }
        } else {
            // If 'dec' is false, preserve the decimal part as is
            // No changes needed to decimalPart here, it already contains what was in the input string
        }
        result = result.join(" ") + decimalPart; // –°–≤—ä—Ä–∑–≤–∞–º–µ –≥—Ä—É–ø–∏—Ç–µ –∏ –¥–æ–±–∞–≤—è–º–µ –¥–µ—Å–µ—Ç–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç
        result = result.replace(/^-\s(?=\d)/, "-"); // –∏–∑–±—è–≥–≤–∞–Ω–µ –Ω–∞ —Å—Ç—ä—Ä—á–∞—â –º–∏–Ω—É—Å: - 5 123,45
        return result;
    }

    function canAddCharacter(currentInput, nextChar) {
        const arithmeticSymbols = ['+', '-', '*', '/'];
        // –†–µ–≥—É–ª—è—Ä–Ω–∏—è—Ç –∏–∑—Ä–∞–∑ –æ—Ç–∫—Ä–∏–≤–∞ –ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ —á–∏—Å–ª–æ —Å 2 —Ü–∏—Ñ—Ä–∏ —Å–ª–µ–¥ –∑–∞–ø–µ—Ç–∞—è –±–µ–∑ –∞—Ä–∏—Ç–º–µ—Ç–∏—á–µ–Ω —Å–∏–º–≤–æ–ª —Å–ª–µ–¥ –Ω–µ–≥–æ
        const regex = /(\d+,\d{2})(?![+\-*/])/;
        // –ê–∫–æ –ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ —á–∏—Å–ª–æ –µ –≤—ä–≤ —Ñ–æ—Ä–º–∞—Ç xxxxx,dd –∏:
        if (regex.test(currentInput)) {
            if (/\d/.test(nextChar)) {
                // –ó–∞–±—Ä–∞–Ω—è–≤–∞–º–µ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤–∞ —Ü–∏—Ñ—Ä–∞ –≤–µ–¥–Ω–∞–≥–∞ —Å–ª–µ–¥ xxxxx,dd
                return false;
            }
        }
        // –í—Å–∏—á–∫–∏ –¥—Ä—É–≥–∏ —Å–ª—É—á–∞–∏ ‚Äî —Ä–∞–∑—Ä–µ—à–µ–Ω–∏
        return true;
    }

    function updateDisplays(userInput, formattedUserInput, keyPressed) {
        // –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –¥–∞–ª–∏ –Ω–∏–∑—ä—Ç —Å—ä–¥—ä—Ä–∂–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∏ –∏–ª–∏ —Å–∫–æ–±–∏.
        // slice(1) —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞, –∑–∞ –¥–∞ —Å–µ –ø–æ–∑–≤–æ–ª–∏ –≤—ä–≤–µ–∂–¥–∞–Ω–µ—Ç–æ –Ω–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª–Ω–æ —á–∏—Å–ª–æ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ.
        // –°–∫–æ–±–∏—Ç–µ —Å–µ –ø—Ä–æ–≤–µ—Ä—è–≤–∞—Ç –≤ —Ü–µ–ª–∏—è –Ω–∏–∑, –∑–∞—â–æ—Ç–æ —Ç–µ –≤–∏–Ω–∞–≥–∏ –æ–∑–Ω–∞—á–∞–≤–∞—Ç –∏–∑—Ä–∞–∑.
        const isOperation = /[+\-*/]/.test(userInput.slice(1)) || userInput.includes('(') || userInput.includes(')');
        const [activeDisplay, passiveDisplay] = levMode ? [displaylv, display] : [display, displaylv];
        const conversionFn = levMode ? convertFromLevToEur : convertFromEurToLev;
        // –û—Å–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ –∞–∫—Ç–∏–≤–Ω–∏—è –¥–∏—Å–ø–ª–µ–π
        activeDisplay.style.backgroundColor = "rgba(201, 255, 5, 0.3)";
        activeDisplay.style.borderBottom = "2px solid #fff";
        passiveDisplay.style.backgroundColor = "rgba(201, 255, 5, 0)";
        passiveDisplay.style.borderBottom = "none";
        let activeDisplayText;
        if (userInput === "") { // –î–æ–±–∞–≤–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –ø—Ä–∞–∑–µ–Ω userInput
            activeDisplayText = "";
        } else if (isOperation) {
            activeDisplayText = formattedUserInput;
        } else {
            const hasComma = userInput.includes(',');
            const decimalPart = hasComma ? userInput.split(',')[1] : '';
            const isWholeNumber = !hasComma;
            if (keyPressed === "B") { // –†–µ–∂–∏–º –Ω–∞ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ (Backspace)
                if (isWholeNumber) { // –ê–∫–æ —Å–ª–µ–¥ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ —á–∏—Å–ª–æ—Ç–æ –µ —Ü—è–ª–æ (–Ω–∞–ø—Ä. –æ—Ç "12," —Å—Ç–∞–≤–∞ "12")
                    activeDisplayText = groupByThree(userInput, true); // –§–æ—Ä–º–∞—Ç–∏—Ä–∞–º–µ –≥–æ –∫–∞—Ç–æ "12,00"
                } else { // –ê–∫–æ –≤—Å–µ –æ—â–µ –∏–º–∞ –¥–µ—Å–µ—Ç–∏—á–Ω–∞ —á–∞—Å—Ç (–Ω–∞–ø—Ä. "12,34" -> "12,3" –∏–ª–∏ "12,3" -> "12,")
                    activeDisplayText = groupByThree(userInput, false); // –ü–æ–∫–∞–∑–≤–∞–º–µ –≥–æ —Ç–æ—á–Ω–æ –∫–∞–∫—Ç–æ –µ
                }
            } else { // –†–µ–∂–∏–º –Ω–∞ –Ω–æ—Ä–º–∞–ª–Ω–æ –≤—ä–≤–µ–∂–¥–∞–Ω–µ (—Ü–∏—Ñ—Ä–∞ –∏–ª–∏ –∑–∞–ø–µ—Ç–∞—è)
                if (isWholeNumber) { // –ê–∫–æ –µ —Ü—è–ª–æ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä. "12")
                    activeDisplayText = groupByThree(userInput, true); // –§–æ—Ä–º–∞—Ç–∏—Ä–∞–º–µ –≥–æ –∫–∞—Ç–æ "12,00"
                } else if (decimalPart.length === 0) { // –ê–∫–æ –∏–º–∞ –∑–∞–ø–µ—Ç–∞—è, –Ω–æ –±–µ–∑ –¥–µ—Å–µ—Ç–∏—á–Ω–∏ —Ü–∏—Ñ—Ä–∏ (–Ω–∞–ø—Ä. "12,")
                    activeDisplayText = groupByThree(userInput, true); // –ü–æ–∫–∞–∑–≤–∞–º–µ –≥–æ –∫–∞—Ç–æ "12,"
                } else if (decimalPart.length === 1) { // –ê–∫–æ –∏–º–∞ –µ–¥–Ω–∞ –¥–µ—Å–µ—Ç–∏—á–Ω–∞ —Ü–∏—Ñ—Ä–∞ (–Ω–∞–ø—Ä. "12,3")
                    activeDisplayText = groupByThree(userInput, true); // –§–æ—Ä–º–∞—Ç–∏—Ä–∞–º–µ –≥–æ –∫–∞—Ç–æ "12,30"
                } else { // –ê–∫–æ –∏–º–∞ –¥–≤–µ –¥–µ—Å–µ—Ç–∏—á–Ω–∏ —Ü–∏—Ñ—Ä–∏ (–Ω–∞–ø—Ä. "12,34")
                    activeDisplayText = groupByThree(userInput, false); // –ü–æ–∫–∞–∑–≤–∞–º–µ –≥–æ –∫–∞—Ç–æ "12,34"
                }
            }
        }
        activeDisplay.textContent = activeDisplayText;
        // –ó–∞–¥–∞–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç –∑–∞ –ø–∞—Å–∏–≤–Ω–∏—è –¥–∏—Å–ø–ª–µ–π (–∏–ª–∏ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è)
        if (isOperation) {
            passiveDisplay.textContent = '';
        } else {
            const convertedValue = conversionFn(userInput);
            passiveDisplay.textContent = groupByThree(convertedValue, true); // –ü–∞—Å–∏–≤–Ω–∏—è—Ç –¥–∏—Å–ø–ª–µ–π –≤–∏–Ω–∞–≥–∏ –ø–æ–∫–∞–∑–≤–∞ –¥–≤–∞ –¥–µ—Å–µ—Ç–∏—á–Ω–∏ –∑–Ω–∞–∫–∞
        }
        // –ê–¥–∞–ø—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —à—Ä–∏—Ñ—Ç–∞
        adjustFontSize(activeDisplay, passiveDisplay);
    }

    function toggleDisplayMode() {
        levMode = !levMode;
        const newActiveValue = levMode
            ? displaylv.textContent
            : display.textContent;
        userInput = newActiveValue.replace(/\s/g, ''); // –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏
        // –ê–∫–æ —Å—Ç–æ–π–Ω–æ—Å—Ç—Ç–∞ –µ —Ü—è–ª–æ —á–∏—Å–ª–æ, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–æ —Å ",00", –ø—Ä–µ–º–∞—Ö–≤–∞–º–µ –¥–µ—Å–µ—Ç–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç.
        if (userInput.endsWith(',00')) {
            userInput = userInput.slice(0, -3);
        }
        console.log("–ü—Ä–æ–º–µ–Ω–µ–Ω —Ä–µ–∂–∏–º - userInput:", userInput);
        updateDisplays(userInput, userInput.replace(/\*/g, "√ó").replace(/\//g, "√∑"), 'L');
    }

    function balanceBrackets(str){
        let open = 0;
        for (const c of str) if (c === '(') open++; else if (c === ')') open--;
        return str + ')'.repeat(Math.max(0, open));
    }

    function addImplicitMultiplication(expression) {
        // 3( -> 3*( | )3 -> )*3 | )( -> )*(
        return expression
            .replace(/(\d)(?=\()/g, '$1*')   // Digit followed by (
            .replace(/(?<=\))(\d)/g, '*$1')   // Digit preceded by )
            .replace(/\)\(/g, ')*(');        // A ) followed by a (
    }

    function appendNumber(value) {
        var oldUserInput = "";
        const display = document.getElementById('eurInput');
        const displaylv = document.getElementById('levInput');
        if (value === "‚Ç¨") { 
            historyOpen();
            return;
        }
        if (value === "L") {
            toggleDisplayMode();
            return;
        }
        if (value === "C") {
            display.textContent = "";
            displaylv.textContent = "";
            userInput = "";
        } else if (value === "B") {
            userInput = userInput.slice(0, -1);
        } else if (value === "=") {
            if (!/[+\-*/]$/.test(userInput) && userInput.length > 0) {
                try {
                    let formattedInput = userInput.replace(/,/g, '.');
                    // console.log("–ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞:", formattedInput);
                    oldUserInput = userInput
                    .replace(/\*/g, "√ó")
                    .replace(/\//g, "√∑")
                    .replace(/,/g, '.');
                    formattedInput = addImplicitMultiplication(balanceBrackets(formattedInput));
                    // console.log("1-–ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞:", formattedInput);
                    let result = eval(formattedInput);
                    result = parseFloat(result).toFixed(2);
                    userInput = result.toString().replace(/\./g, ',');
                    navigator.clipboard.writeText(userInput)
                    .then(() => {
                        console.log("–†–µ–∑—É–ª—Ç–∞—Ç—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞! ‚úÖ"); })
                    .catch(err => { console.error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–∞–Ω–µ –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞:", err); });
                } catch (error) {
                    console.error("–ì—Ä–µ—à–∫–∞ –≤ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è—Ç–∞", error);
                }
            }
        } else {
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ –¥–≤–∞ –∑–Ω–∞–∫–∞ —Å–ª–µ–¥ –∑–∞–ø–µ—Ç–∞—è—Ç–∞ —Å–∞–º–æ –∑–∞ —Ç–µ–∫—É—â–æ—Ç–æ —á–∏—Å–ª–æ
            const lastOperatorIndex = Math.max(
                userInput.lastIndexOf('+'),
                userInput.lastIndexOf('-'),
                userInput.lastIndexOf('*'),
                userInput.lastIndexOf('/')
            );
            const currentNumber = lastOperatorIndex === -1 
                ? userInput 
                : userInput.slice(lastOperatorIndex + 1);
            // –ù–µ –¥–æ–ø—É—Å–∫–∞–º–µ –ø–æ–≤–µ—á–µ –æ—Ç –µ–¥–Ω–∞ –∑–∞–ø–µ—Ç–∞—è –≤ —Ç–µ–∫—É—â–æ—Ç–æ —á–∏—Å–ª–æ
            if (value === "," && currentNumber.includes(',')) return;
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞ –¥–≤–∞ –∑–Ω–∞–∫–∞ —Å–ª–µ–¥ –∑–∞–ø–µ—Ç–∞—è—Ç–∞ —Å–∞–º–æ –∑–∞ —Ç–µ–∫—É—â–æ—Ç–æ —á–∏—Å–ª–æ
            if ((/\d/.test(value) || value === ",") && currentNumber.includes(',')) {
                const decimalPart = currentNumber.split(',')[1] || "";
                if (decimalPart.length >= 2) return;
            }
            // –ù–µ –¥–æ–ø—É—Å–∫–∞–º–µ –∞—Ä–∏—Ç–º–µ—Ç–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ –∏–∑—Ä–∞–∑–∞ –∏–ª–∏ —Å–ª–µ–¥ –¥—Ä—É–≥ –æ–ø–µ—Ä–∞—Ç–æ—Ä
            if (/[+\-*/]/.test(value) && (userInput.length === 0 || /[+\-*/]$/.test(userInput))) return;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—Ç–æ—Ä–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä
            let match = userInput.match(/([\d,]+[+\-*/])([\d,]+)/);
            if (match && /[+\-*/]/.test(value)) {
                try {
                    //let formattedInput = match[0].replace(/,/g, '.');
                    let formattedInput = userInput.replace(/,/g, '.');
                    oldUserInput = userInput
                    .replace(/\*/g, "√ó")
                    .replace(/\//g, "√∑")
                    .replace(/,/g, '.');
                    formattedInput = addImplicitMultiplication(balanceBrackets(formattedInput));
                    console.log("2-–ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞:", formattedInput);
                    let result = eval(formattedInput);
                    userInput = parseFloat(result).toFixed(2).replace(/\./g, ',') + value;
                    let levValue = parseNumber(displaylv.textContent);
                    let eurValue = parseNumber(display.textContent);
                    addHistoryEntry(oldUserInput, result, "no"); // –∑–∞–ø–∏—Å–≤–∞ –º–µ–∂–¥–∏–Ω–µ–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç
                } catch (error) {
                    console.error("–ì—Ä–µ—à–∫–∞ –≤ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è—Ç–∞", error);
                }
            } else {
                if (canAddCharacter(userInput, value)) {
                    userInput += value;
                }
            }
        }
        const formattedUserInput = userInput
        .replace(/\*/g, "√ó")
        .replace(/\//g, "√∑");
        updateDisplays(userInput, formattedUserInput, value);
        if (value === "=") {
            let levValue = parseNumber(displaylv.textContent);
            let eurValue = parseNumber(display.textContent);
            if (levValue !== "" && eurValue !== "") addHistoryEntry(oldUserInput, levValue, eurValue);
        }
        if (userInput.endsWith(',00')) {
            userInput = userInput.slice(0, -3);
        }        
        console.log("userInput = ", userInput);
    }

    function getKeyColumnIndex(key) {
    const rect = calculator.getBoundingClientRect();
    // const scaleX = rect.width / imageWidthO;
    const colWidth = MainPoints.KeySize.x + MainPoints.KbdGaps.x;
    const relativeX = (key.x - rect.left - MainPoints.Keys.x) / colWidth;
    return Math.round(relativeX+1); // –í—Ä—ä—â–∞ 1, 2, 3 –∏–ª–∏ 4
    }

    function controlActions(key) {
        if (key.value === '+') {
            if (!fullscrFlag) goFullscreen()
            else exitFullscreen();
            fullscrFlag = !fullscrFlag;
        } else if (key.value === '*') {
            console.log("Before %: ", userInput);
            userInput = userInput.replace(',', '.');
            userInput = eval(userInput);
            userInput = (parseFloat(userInput) / 100)
                .toFixed(2)
                .replace('.', ',');
            appendNumber("=");
            // console.log("Ctrl+%: ", userInput);
        }  else if (key.value === '-') {
            if ((/[+\-*/]$/.test(userInput))) return;
            if (userInput.startsWith("-")) {
                userInput = userInput.slice(1); // –ø—Ä–µ–º–∞—Ö–≤–∞ –ø—ä—Ä–≤–∏—è —Å–∏–º–≤–æ–ª "-"
            } else {
                userInput = "-" + userInput;    // –¥–æ–±–∞–≤—è "-"
            }
            userInput = userInput.replace(',', '.');
            if ((/[+\-*/]$/.test(userInput))) return;
            userInput = eval(userInput);
            userInput = (parseFloat(userInput))
                .toFixed(2)
                .replace('.', ',');
            appendNumber("=");
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞ Web Audio API –∑–∞ –±—ä—Ä–∑–æ –≤—ä–∑–ø—Ä–æ–∏–∑–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –∑–≤—É—Ü–∏
    async function initAudio() {
        if (!soundEffectsEnabled) return;
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            // –ò–∑—Ç–µ–≥–ª—è–º–µ –∏ –¥–µ–∫–æ–¥–∏—Ä–∞–º–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª–Ω–æ
            const response = await fetch('click.wav');
            const arrayBuffer = await response.arrayBuffer();
            clickBuffer = await audioContext.decodeAudioData(arrayBuffer);
            console.log("–ê—É–¥–∏–æ —Ñ–∞–π–ª—ä—Ç –µ –∫–µ—à–∏—Ä–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∑–∞ –≤—ä–∑–ø—Ä–æ–∏–∑–≤–µ–∂–¥–∞–Ω–µ.");
        } catch (e) {
            console.error("Web Audio API –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞ –∏–ª–∏ –≤—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è.", e);
            soundEffectsEnabled = false; // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–∞–º–µ –∑–≤—É–∫–∞ –ø—Ä–∏ –≥—Ä–µ—à–∫–∞
        }
    }

    function playClickSound() {
        if (!soundEffectsEnabled || !clickBuffer || !audioContext) return;
        if (audioContext.state === 'suspended') audioContext.resume();
        const source = audioContext.createBufferSource();
        source.buffer = clickBuffer;
        source.connect(audioContext.destination);
        source.start(0);
    }

/*
    document.addEventListener("click", function(event) {
        if (modalIsActive) return; // ‚ùå –∑–∞ –¥–∞ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–≤–∞–Ω–µ –≤ –º–æ–¥–∞–ª–Ω–∏—è –µ–∫—Ä–∞–Ω
        const rect = calculator.getBoundingClientRect();
        const scaleX = rect.width / imageWidthO;
        const scaleY = rect.height / imageHeightO;
        const keyWidth = MainPointsO.KeySize.x * scaleX;
        const keyHeight = MainPointsO.KeySize.y * scaleY;
        keys.forEach(key => {
            const withinX = event.clientX >= key.x && event.clientX <= key.x + keyWidth;
            const withinY = event.clientY >= key.y && event.clientY <= key.y + keyHeight;
            if (withinX && withinY) {
                if (event.ctrlKey && key.value === '‚Ç¨') {
                    if (ovFlag) {noOverlay(); ovFlag = false;}
                    settingsModal.style.display = 'flex';
                    modalIsActive = true;
                    populateLayoutSettings();
                } else if (event.ctrlKey && key.value === 'B') {
                    for (let i = 1; i < 4; i++) {
                        Mem[i] = 0;
                        clearStatus (i);
                    }
                    localStorage.setItem('CalcMem', JSON.stringify(Mem));
                } else if (event.ctrlKey && key.value === '+') {
                    if (!fullscrFlag) goFullscreen()
                    else exitFullscreen();
                    fullscrFlag = !fullscrFlag;
                } else if (event.ctrlKey && key.value === '*') { */
                    // if ((/[+\-*/]$/.test(userInput))) return;
/*                    console.log("Before %: ", userInput);
                    userInput = userInput.replace(',', '.');
                    userInput = eval(userInput);
                    userInput = (parseFloat(userInput) / 100)
                      .toFixed(2)
                      .replace('.', ',');
                    appendNumber("=");
                    // console.log("Ctrl+%: ", userInput);
                }  else if (event.ctrlKey && key.value === '-') {*/
                    //if ((/[+\-*/]$/.test(userInput))) return;
/*                    if (userInput.startsWith("-")) {
                        userInput = userInput.slice(1); // –ø—Ä–µ–º–∞—Ö–≤–∞ –ø—ä—Ä–≤–∏—è —Å–∏–º–≤–æ–ª "-"
                    } else {
                        userInput = "-" + userInput;    // –¥–æ–±–∞–≤—è "-"
                    }
                    userInput = userInput.replace(',', '.');
                    userInput = eval(userInput);
                    userInput = (parseFloat(userInput))
                      .toFixed(2)
                      .replace('.', ',');
                    appendNumber("=");
                } else if (event.ctrlKey && isMemoryKey(key.value)) {
                    const col = getKeyColumnIndex(key);
                    executeMemoryAction(key.value, col);
                    console.log("–ù–∞—Ç–∏—Å–Ω–∞—Ç–æ:", key.value, "‚Üí –ö–æ–ª–æ–Ω–∞:", col);
                } else {
                    appendNumber(key.value);
                }
            }
        });
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–ª–∏–∫–æ–≤–µ –≤—ä—Ä—Ö—É —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∏—Ç–µ (—Å–∞–º–æ –∑–∞ —Å–ª–æ—Ç–æ–≤–µ 1, 2, 3)
        for (let i = 1; i <= 3; i++) {
            const statusEl = document.getElementById(`statusArea${i}`);
            if (statusEl && getComputedStyle(statusEl).opacity > 0) {
                const statusRect = statusEl.getBoundingClientRect();
                if (event.clientX >= statusRect.left && event.clientX <= statusRect.right &&
                    event.clientY >= statusRect.top && event.clientY <= statusRect.bottom)  {
                    if (event.ctrlKey) {
                    memoryShow(i);
                    console.log(`Ctrl+–ö–ª–∏–∫ –≤—ä—Ä—Ö—É —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∞ ${i} –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç.`);
                    } else {
                    memoryRecall(i);
                    console.log(`–ö–ª–∏–∫–Ω–∞—Ç–æ –≤—ä—Ä—Ö—É –≤–∏–¥–∏–º–∞ —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∞ ${i} –∑–∞ –∏–∑–≤–∏–∫–≤–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç.`);
                    }// –ò–∑–≤–∏–∫–≤–∞–º–µ –ø–∞–º–µ—Ç—Ç–∞ –∑–∞ —Å—ä–æ—Ç–≤–µ—Ç–Ω–∏—è —Å–ª–æ—Ç
                    break; // –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–º–µ —Ü–∏–∫—ä–ª–∞, –∞–∫–æ –µ –æ–±—Ä–∞–±–æ—Ç–µ–Ω –∫–ª–∏–∫
                }
            }
        }
    });

    // üß© –£–ª–∞–≤—è –¥–µ—Å–µ–Ω –∫–ª–∏–∫ –∏–ª–∏ –¥—ä–ª—ä–≥ —Ç–∞–ø (–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ –º–µ–Ω—é)
    document.addEventListener("contextmenu", function(event) {
        event.preventDefault(); // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞ –ø–æ—è–≤–∞—Ç–∞ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä –º–µ–Ω—é—Ç–æ
        const rect = calculator.getBoundingClientRect();
        const scaleX = rect.width / imageWidthO;
        const scaleY = rect.height / imageHeightO;
        const keyWidth = MainPointsO.KeySize.x * scaleX;
        const keyHeight = MainPointsO.KeySize.y * scaleY;
        keys.forEach(key => {
            if (event.clientX >= key.x && event.clientX <= key.x + keyWidth &&
                event.clientY >= key.y && event.clientY <= key.y + keyHeight) {
                // üëâ –î–æ–±–∞–≤—è–º–µ —É—Å–ª–æ–≤–∏–µ—Ç–æ –æ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∏—è —à–æ—Ä—Ç–∫—ä—Ç
                if (key.value === '+') {
                    if (!fullscrFlag) goFullscreen()
                    else exitFullscreen();
                    fullscrFlag = !fullscrFlag;
                } else if (event.ctrlKey && key.value === 'B') {
                    for (let i = 1; i < 4; i++) {
                        Mem[i] = 0;
                        clearStatus (i);
                    }
                    localStorage.setItem('CalcMem', JSON.stringify(Mem));
                } else if (key.value === '*') { */
                    //if ((/[+\-*/]$/.test(userInput))) return;
/*                    console.log("Before %: ", userInput);
                    userInput = userInput.replace(',', '.');
                    userInput = eval(userInput);
                    userInput = (parseFloat(userInput) / 100)
                      .toFixed(2)
                      .replace('.', ',');
                    appendNumber("=");
                    // console.log("Ctrl+%: ", userInput);
                }  else if (key.value === '-') { */
                    //if ((/[+\-*/]$/.test(userInput))) return;
/*                    if (userInput.startsWith("-")) {
                        userInput = userInput.slice(1); // –ø—Ä–µ–º–∞—Ö–≤–∞ –ø—ä—Ä–≤–∏—è —Å–∏–º–≤–æ–ª "-"
                    } else {
                        userInput = "-" + userInput;    // –¥–æ–±–∞–≤—è "-"
                    }
                    userInput = userInput.replace(',', '.'); */
                    // if ((/[+\-*/]$/.test(userInput))) return;
/*                    userInput = eval(userInput);
                    userInput = (parseFloat(userInput))
                      .toFixed(2)
                      .replace('.', ',');
                    appendNumber("=");
                } else if (key.value === '‚Ç¨') {
                    if (ovFlag) {noOverlay(); ovFlag = false;}
                    settingsModal.style.display = 'flex';
                    modalIsActive = true;
                    populateLayoutSettings();
                } else if (isMemoryKey(key.value)) {
                    const col = getKeyColumnIndex(key);
                    executeMemoryAction(key.value, col);
                }
            }
        });
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–ª–∏–∫–æ–≤–µ –≤—ä—Ä—Ö—É —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∏—Ç–µ (—Å–∞–º–æ –∑–∞ —Å–ª–æ—Ç–æ–≤–µ 1, 2, 3)
        for (let i = 1; i <= 3; i++) {
            const statusEl = document.getElementById(`statusArea${i}`);
            if (statusEl && getComputedStyle(statusEl).opacity > 0) {
                const statusRect = statusEl.getBoundingClientRect();
                if (event.clientX >= statusRect.left && event.clientX <= statusRect.right &&
                    event.clientY >= statusRect.top && event.clientY <= statusRect.bottom) {
                    memoryShow(i); // –ò–∑–≤–∏–∫–≤–∞–º–µ –ø–∞–º–µ—Ç—Ç–∞ –∑–∞ —Å—ä–æ—Ç–≤–µ—Ç–Ω–∏—è —Å–ª–æ—Ç
                    console.log(`–ó–∞–¥—ä—Ä–∂–∞–Ω–æ –≤—ä—Ä—Ö—É —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∞ ${i} –∑–∞ –∏–∑–≤–∏–∫–≤–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç.`);
                    break; // –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–º–µ —Ü–∏–∫—ä–ª–∞, –∞–∫–æ –µ –æ–±—Ä–∞–±–æ—Ç–µ–Ω –∫–ª–∏–∫
                }
            }
        }
    });
*/
/*
    function handleSpecialKey(keyValue, event) {
        if (event.ctrlKey && keyValue === '‚Ç¨') {
            if (ovFlag) { noOverlay(); ovFlag = false; }
            settingsModal.style.display = 'flex';
            modalIsActive = true;
            populateLayoutSettings();
        } else if (event.ctrlKey && keyValue === 'B') {
            clearAllMemory();
        } else if (event.ctrlKey && keyValue === '+') {
            toggleFullscreen();
        } else if (event.ctrlKey && keyValue === '*') {
            const result = sanitizeAndEvaluateInput(userInput, 'percent');
            if (result !== null) {
                userInput = result;
                appendNumber("=");
            }
        } else if (event.ctrlKey && keyValue === '-') {
            const result = sanitizeAndEvaluateInput(userInput, 'negate');
            if (result !== null) {
                userInput = result;
                appendNumber("=");
            }
        } else if (event.ctrlKey && isMemoryKey(keyValue)) {
            const col = getKeyColumnIndex(keyValue);
            executeMemoryAction(keyValue, col);
        } else {
            appendNumber(keyValue);
        }
    }
*/
/*
    document.addEventListener("click", function(event) {
        if (modalIsActive) return;
        const { keyWidth, keyHeight } = getKeyDimensions();
        keys.forEach(key => {
            if (isWithinKeyBounds(event, key, keyWidth, keyHeight)) {
                handleSpecialKey(key.value, event);
            }
        });
        handleStatusZones(event, event.ctrlKey);
    });

    document.addEventListener("contextmenu", function(event) {
        event.preventDefault();
        const { keyWidth, keyHeight } = getKeyDimensions();
        keys.forEach(key => {
            if (isWithinKeyBounds(event, key, keyWidth, keyHeight)) {
                handleSpecialKey(key.value, event);
            }
        });
        handleStatusZones(event, false);
    });
*/

    function getKeyDimensions() {
            const rect = calculator.getBoundingClientRect();
            const scaleX = rect.width / imageWidthO;
            const scaleY = rect.height / imageHeightO;
            return {
                keyWidth: MainPointsO.KeySize.x * scaleX,
                keyHeight: MainPointsO.KeySize.y * scaleY
            };
        }

    function isWithinKeyBounds(event, key, keyWidth, keyHeight) {
        return (
            event.clientX >= key.x &&
            event.clientX <= key.x + keyWidth &&
            event.clientY >= key.y &&
            event.clientY <= key.y + keyHeight
        );
    }

    function handleStatusZones(event, isCtrlRequired) {
        for (let i = 1; i <= 3; i++) {
            const statusEl = document.getElementById(`statusArea${i}`);
            if (statusEl && getComputedStyle(statusEl).opacity > 0) {
                const rect = statusEl.getBoundingClientRect();
                const withinBounds = (
                    event.clientX >= rect.left &&
                    event.clientX <= rect.right &&
                    event.clientY >= rect.top &&
                    event.clientY <= rect.bottom
                );
                if (withinBounds) {
                    isCtrlRequired ? memoryShow(i) : memoryRecall(i);
                    return true; // –í—Ä—ä—â–∞–º–µ true, –∑–∞ –¥–∞ –ø–æ–∫–∞–∂–µ–º, —á–µ –∫–ª–∏–∫—ä—Ç –µ –æ–±—Ä–∞–±–æ—Ç–µ–Ω
                }
            }
        }
        return false; // –í—Ä—ä—â–∞–º–µ false, –∞–∫–æ –∫–ª–∏–∫—ä—Ç –Ω–µ –µ –≤—ä—Ä—Ö—É –∞–∫—Ç–∏–≤–Ω–∞ –∑–æ–Ω–∞
    }

    function sanitizeAndEvaluateInput(input, operationType) {
        if ((/[+\-*/]$/.test(input))) return null;
        input = input.replace(',', '.');
        let result = eval(input);
        if (operationType === 'percent') {
            result = result / 100;
        } else if (operationType === 'negate') {
            result = input.startsWith('-') ? input.slice(1) : '-' + input;
            result = eval(result); // –æ—Ç–Ω–æ–≤–æ evaluate —Å–ª–µ–¥ –¥–æ–±–∞–≤—è–Ω–µ/–ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ
        }
        return parseFloat(result).toFixed(2).replace('.', ',');
    }

    function goFullscreen() {
      const el = document.documentElement;
      if (el.requestFullscreen) {
        el.requestFullscreen();
      } else if (el.webkitRequestFullscreen) {
        el.webkitRequestFullscreen();
      } else if (el.msRequestFullscreen) {
        el.msRequestFullscreen();
      }
    }

    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }

    function toggleFullscreen() {
        if (!fullscrFlag) goFullscreen();
        else exitFullscreen();
        fullscrFlag = !fullscrFlag;
    }

    function clearAllMemory() {
        for (let i = 1; i < 4; i++) {
            Mem[i] = 0;
            clearStatus(i);
        }
        localStorage.setItem('CalcMem', JSON.stringify(Mem));
    }

    function handleCalculatorInteraction(event, options = {}) {
        // –ê–∫–æ –µ –∞–∫—Ç–∏–≤–µ–Ω –º–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü, –ø—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–º–µ –≤—Å—è–∫–∞–∫–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞.
        // –¢–æ–≤–∞ –µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∏—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞, –∫–æ—è—Ç–æ —Ä–µ—à–∞–≤–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å "–ø—Ä–æ–ø–∞–¥–∞–Ω–µ—Ç–æ" –Ω–∞ –∫–ª–∏–∫–æ–≤–µ –∑–∞ –≤—Å–∏—á–∫–∏ –º–æ–¥–∞–ª–∏.
        if (modalIsActive) {
            return;
        }

        let interactionHandled = false;
        const { keyWidth, keyHeight } = getKeyDimensions();
        keys.forEach(key => {
            if (isWithinKeyBounds(event, key, keyWidth, keyHeight)) {
                interactionHandled = true;
                const keyValue = key.value;
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏ –∫–ª–∞–≤–∏—à–∏
                if ((event.ctrlKey || options.allowWithoutCtrl) && keyValue === '‚Ç¨') {
                    if (ovFlag) { noOverlay(); ovFlag = false; }
                    settingsModal.style.display = 'flex';
                    modalIsActive = true;
                    populateLayoutSettings();
                } else if ((event.ctrlKey || options.allowWithoutCtrl) && keyValue === 'B') {
                    clearAllMemory();
                } else if ((event.ctrlKey || options.allowWithoutCtrl) && keyValue === '0') {
                    appendNumber("(");
                } else if ((event.ctrlKey || options.allowWithoutCtrl) && keyValue === ',') {
                    appendNumber(")");
                } else if ((event.ctrlKey || options.allowWithoutCtrl) && keyValue === '+') {
                    toggleFullscreen();
                } else if ((event.ctrlKey || options.allowWithoutCtrl) && keyValue === '*') {
                    const result = sanitizeAndEvaluateInput(userInput, 'percent');
                    if (result !== null) {
                        userInput = result;
                        appendNumber("=");
                    }
                } else if ((event.ctrlKey || options.allowWithoutCtrl) && keyValue === '-') {
                    const result = sanitizeAndEvaluateInput(userInput, 'negate');
                    if (result !== null) {
                        userInput = result;
                        appendNumber("=");
                    }
                } else if ((event.ctrlKey || options.allowWithoutCtrl) && isMemoryKey(keyValue)) {
                    const col = getKeyColumnIndex(key);
                    executeMemoryAction(keyValue, col);
                } else {
                    appendNumber(keyValue);
                }
            }
        });
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∏
        if (handleStatusZones(event, event.ctrlKey || options.allowWithoutCtrl)) {
            interactionHandled = true;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∫–ª–∏–∫ –≤—ä—Ä—Ö—É –¥–∏—Å–ø–ª–µ–∏—Ç–µ
        if (!interactionHandled) {
            const levDisplayEl = document.getElementById('levInput');
            const eurDisplayEl = document.getElementById('eurInput');
            const levRect = levDisplayEl.getBoundingClientRect();
            const eurRect = eurDisplayEl.getBoundingClientRect();
            const isClickOnLev = event.clientX >= levRect.left && event.clientX <= levRect.right &&
                                 event.clientY >= levRect.top && event.clientY <= levRect.bottom;
            const isClickOnEur = event.clientX >= eurRect.left && event.clientX <= eurRect.right &&
                                 event.clientY >= eurRect.top && event.clientY <= eurRect.bottom;
            if ((isClickOnLev || isClickOnEur)) { //  && (event.ctrlKey || options.allowWithoutCtrl)
                toggleDisplayMode();
                interactionHandled = true;
            }
        }

        // –ê–∫–æ –∫–ª–∏–∫—ä—Ç –µ –∏–∑–≤—ä–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞ –∏ –µ Ctrl+Click –∏–ª–∏ –∑–∞–¥—ä—Ä–∂–∞–Ω–µ
        if (!interactionHandled && (event.ctrlKey || options.allowWithoutCtrl)) {
            const calculatorContainer = document.getElementById('calculatorContainer');
            const containerRect = calculatorContainer.getBoundingClientRect();
            const isOutsideContainer = event.clientX < containerRect.left ||
                                       event.clientX > containerRect.right ||
                                       event.clientY < containerRect.top ||
                                       event.clientY > containerRect.bottom;
            if (isOutsideContainer) {
                if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –≤—ä—Ä–Ω–µ—Ç–µ –ø—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?')) {
                    // –î–æ–±–∞–≤—è–º–µ –∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –ø—Ä–∏ –Ω—É–ª–∏—Ä–∞–Ω–µ
                    if (typeof clearHistory === 'function') {
                        clearHistory();
                        console.log('–ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞.');
                    }
                    localStorage.removeItem('MainPointsO');
                    localStorage.removeItem('appSettings');
                    console.log('–í—Å–∏—á–∫–∏ –∑–∞–ø–∞–∑–µ–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (MainPointsO, appSettings) —Å–∞ –∏–∑—Ç—Ä–∏—Ç–∏.');
                    location.reload();
                }
            }
        }

        // –ü—É—Å–∫–∞–º–µ –∑–≤—É–∫, –∞–∫–æ –µ –∏–º–∞–ª–æ –≤–∞–ª–∏–¥–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
        if (interactionHandled) {
            playClickSound();
        }
    }

    document.addEventListener("click", function(event) {
        handleCalculatorInteraction(event);
    });

    document.addEventListener("contextmenu", function(event) {
        event.preventDefault(); // –±–ª–æ–∫–∏—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ—Ç–æ –º–µ–Ω—é
        handleCalculatorInteraction(event, { allowWithoutCtrl: true });
    });


    document.getElementById('saveSettings').addEventListener('click', function(e) {
        saveSettings();
        settingsModal.style.display = 'none'; // Close modal after saving
        setTimeout(() => {
            modalIsActive = false;
        }, 0);
        e.stopPropagation();
        e.preventDefault();
    });

    document.getElementById('closeSettingsModalButton').addEventListener('click', function(e) {
        settingsModal.style.display = 'none'; // Close modal without saving
        setTimeout(() => {
            modalIsActive = false;
        }, 0);
        e.stopPropagation();
        e.preventDefault();
    });

    window.addEventListener("load", async function () {
        try {
            calculator = document.querySelector(".calculator-img");
            loadSettings(); // –ó–∞—Ä–µ–∂–¥–∞ –≤—Å–∏—á–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç appSettings
            initAudio();    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–º–µ –∞—É–¥–∏–æ—Ç–æ –∑–∞ –±—ä—Ä–∑–∞ —Ä–µ–∞–∫—Ü–∏—è
            // –ü—Ä–∏–ª–∞–≥–∞–º–µ —Å–∏–º–≤–æ–ª–∞ –∫—ä–º –µ–ª–µ–º–µ–Ω—Ç–∞
            document.getElementById('currency').textContent = CURRENCY_SYMBOL;
            document.getElementById('currencyLev').textContent = CURRENCY_LEV_SYMBOL;

            // –û—Å–Ω–æ–≤–Ω–∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è
            getImageSize();
            getImageVisualSize();
            scaleMainPoints(aspectRatioW, aspectRatioH);
            const layout = calcNewCoordinates();
            keys = layout.keys; // This needs to be updated after MainPointsO is potentially loaded
            displayCoords = layout.displayCoords;
            resizeFont();
            appendNumber("C");
            // --- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï –ó–ê –ö–£–†–°–ê ---
            if (showWarning && showRateWarningEnabled) {
                const warning = document.getElementById('exchangeRateWarning');
                warning.style.display = 'flex';
                modalIsActive = true; // –ë–ª–æ–∫–∏—Ä–∞–º–µ –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞

                document.getElementById('exchangeRateChangeBtn').onclick = function() {
                    // –í—Ä—ä—â–∞–º–µ –∫—É—Ä—Å–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ –∏ –∑–∞–ø–∞–∑–≤–∞–º–µ –≤ –Ω–æ–≤–∞—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
                    const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;
                    settings.exchangeRate = defaultSettings.exchangeRate;
                    localStorage.setItem('appSettings', JSON.stringify(settings));
                    modalIsActive = false; // –û—Å–≤–æ–±–æ–∂–¥–∞–≤–∞–º–µ –ø—Ä–µ–¥–∏ –ø—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ
                    location.reload(); // –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–º–µ, –∑–∞ –¥–∞ —Å–µ –ø—Ä–∏–ª–æ–∂–∏
                };
                document.getElementById('exchangeRateConfirmBtn').onclick = function() {
                    warning.style.display = 'none';
                    modalIsActive = false; // –û—Å–≤–æ–±–æ–∂–¥–∞–≤–∞–º–µ –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞
                };
            }
            // –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–∞–º–µ –∑–∞—Ä–µ–¥–µ–Ω–∞—Ç–∞ –ø–∞–º–µ—Ç
            for (let i = 1; i <= 3; i++) {
                if (Mem[i] !== undefined && Mem[i] !== null && Mem[i] !== 0) {
                    memoryAdd(i, "+"); // updateStatus ("M", i);
                }
            }
        } catch (err) {
            console.warn("‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:", err);
        }
        /*/ –í–∏–∑—É–∞–ª–µ–Ω –µ—Ñ–µ–∫—Ç
        const img = document.querySelector(".calculator-img");
        if (img) {
            img.classList.add("glow");
            img.addEventListener("animationend", () => {
                img.classList.remove("glow");
            }, { once: true });
            // Populate layout settings fields when the page loads (after MainPointsO is set)
            populateLayoutSettings();
            const settingsButton = document.getElementById('settingsButton'); // Assuming this button exists
            if (settingsButton) {
                settingsButton.addEventListener('click', populateLayoutSettings); // Populate when modal is opened
            }
        }*/
        // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        document.body.classList.add("ready");
    });

    document.addEventListener('DOMContentLoaded', () => {
        // –ó–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –º–æ–¥–∞–ª —Å ESC –∫–ª–∞–≤–∏—à
        document.addEventListener('keydown', (e) => {
            const key = e.key;

            // Escape –≤–∏–Ω–∞–≥–∏ —Ä–∞–±–æ—Ç–∏ –∑–∞ –∑–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –º–æ–¥–∞–ª–Ω–∏ –ø—Ä–æ–∑–æ—Ä—Ü–∏
            if (key === 'Escape' || key === 'Esc') {
                historyModal.style.display = 'none';
                settingsModal.style.display = 'none';
                modalIsActive = false;
                return;
            }

            // –ë–ª–æ–∫–∏—Ä–∞–º–µ –¥—Ä—É–≥–∏—Ç–µ –∫–ª–∞–≤–∏—à–∏, –∞–∫–æ –∏–º–∞ –æ—Ç–≤–æ—Ä–µ–Ω –º–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü
            if (modalIsActive) {
                return;
            }

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞–º–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∞–∫–æ –µ –Ω—É–∂–Ω–æ
            if (['Enter', '/', '*', '(', ')'].includes(key)) {
                e.preventDefault();
            }

            // –°–ø–µ—Ü–∏–∞–ª–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞ '%'
            if (key === '%') {
                if ((/[+\-*/]$/.test(userInput))) return;
                userInput = userInput.replace(',', '.');
                userInput = eval(userInput);
                userInput = (parseFloat(userInput) / 100).toFixed(2).replace('.', ',');
                appendNumber("=");
                return;
            }

            const keyMap = { 'Enter': '=', '=': '=', 'Backspace': 'B', 'Delete': 'B', ',': ',', '.': ',', 'c': 'C', 'C': 'C', '(': '(', ')': ')' };

            if (keyMap[key]) {
                appendNumber(keyMap[key]);
            } else if ("0123456789+-*/".includes(key)) {
                appendNumber(key);
            }
        });
        loadHistory();
        // Initial font size adjustment for both fields based on their (potentially empty) content
        adjustFontSize(levInput, eurInput);
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–æ PWA
        // const installBtn = document.getElementById('install');
        isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        //if (isStandalone) {
        //   installBtn.style.display = 'none';
        //}
    });

    // –°–ª–µ–¥–µ–Ω–µ –Ω–∞ –ø—Ä–µ–æ—Ä–∞–∑–º–µ—Ä—è–≤–∞–Ω–µ—Ç–æ –Ω–∞ –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞
    window.addEventListener("resize", function (e) {
        getImageVisualSize();
        scaleMainPoints(aspectRatioW, aspectRatioH);
        const layout = calcNewCoordinates(); //@@ calculator, imageWidthO, imageHeightO
        keys = layout.keys;
        displayCoords = layout.displayCoords;
        //const { keys, displayCoords } = calcNewCoordinates();
        adjustFontSize(levInput, eurInput)
        //resizeFont();
    })

    function showOv() {
        if (!ovFlag) {
            const layout = calcNewCoordinates();
            displayCoords = layout.displayCoords;
            placeKeys(keys, displayCoords); ovFlag = true;
        } else {
            noOverlay(); 
            ovFlag = false;
        } 
        settingsModal.style.display = 'none'; 
        setTimeout(() => {
            modalIsActive = false;
        }, 0);
        //e.stopPropagation();
        //e.preventDefault();
    }

    /* // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–æ –ø–æ –≤—Ä–µ–º–µ –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, –∑–∞ –¥–∞ —Å–µ –∑–∞—Ä–µ–∂–¥–∞ –≤–∏–Ω–∞–≥–∏ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    */

    let deferredPrompt;
    if (localStorage.getItem('pwaInstallDeclined') === 'true') {
        console.log('–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –≤–µ—á–µ –µ –æ—Ç–∫–∞–∑–∞–ª –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è—Ç–∞.');
    } else {
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const bar = document.getElementById('install-bar');
            const installBtn = document.getElementById('install');
            const dismissBtn = document.getElementById('dismiss');
            bar.style.display = 'flex';
            let countdown = 20;
            installBtn.textContent = `–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ (${countdown})`;
            const interval = setInterval(() => {
                countdown--;
                installBtn.textContent = `–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ (${String(countdown).padStart(2, '0')})`;
                // const padded = countdown < 10 ? '0' + countdown : countdown;
                // installBtn.textContent = `–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ (${padded})`;
                //installBtn.textContent = `–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ (${countdown})`;
                if (countdown <= 0) cleanup();
            }, 1000);
            const installHandler = () => {
                deferredPrompt.prompt();
                deferredPrompt = null;
                cleanup();
            };
            const dismissHandler = () => {
                localStorage.setItem('pwaInstallDeclined', 'true');
                deferredPrompt = null;
                cleanup();
            };
            function cleanup() {
                clearInterval(interval);
                bar.style.display = 'none';
                installBtn.removeEventListener('click', installHandler);
                dismissBtn.removeEventListener('click', dismissHandler);
            }
            installBtn.addEventListener('click', installHandler);
            dismissBtn.addEventListener('click', dismissHandler);
        });
    }

</script>

</body>
</html>
