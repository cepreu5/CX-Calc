<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#BFB8B4">
    <link rel="manifest" href="manifest.webmanifest">
    <title>CX-Calc</title>
   	<link rel="shortcut icon" type="image/png" href="CalcFav.png" />
	  <link rel="stylesheet" href="style.css" />

    <style>
        /* button {
          font-size: 1.2em;
          padding: 1em 2em;
          margin-top: 1em;
        } */
    </style>
</head>
<body>
    <button id="install" style="position:fixed; top:10px; left:10px; z-index:1000; display:inline-block;">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π</button>

    <div id="statusArea1" class="statusArea"></div>
    <div id="statusArea2" class="statusArea"></div>
    <div id="statusArea3" class="statusArea"></div>

    <div class="calculator-container" id="calculatorContainer">     
        <img src="CalculatorM.png" ID="calculator" class="calculator-img" alt="–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä">
        <div id="levInput" class="calculator-display-lv" contenteditable="false"></div>
        <div id="eurInput" class="calculator-display" contenteditable="false"></div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è—Ç–∞</h2>
            </div>
            <ul id="historyList">
            </ul>
            <div class="modal-footer" style="margin-top: 15px; display: flex; gap: 10px;">
                <button id="clearHistoryButton" class="action-button secondary" style="flex-grow: 1;">–ò–∑—á–∏—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</button>
                <button id="closeHistoryModalButton" class="action-button" style="flex-grow: 1;">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            </div>
            <div class="modal-header">
                <h2>–ö—É—Ä—Å BGN/EUR: 1.95583</h2>
            </div>
            <div class="settings-grid">
                <div class="settings-section">
                    <div class="layout-settings-grid">
                        <!-- Keys -->
                        <label>–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞:</label>
                        <input type="number" id="keysX" data-key="Keys" data-prop="x">
                        <input type="number" id="keysY" data-key="Keys" data-prop="y">

                        <!-- KeySize -->
                        <label>–†–∞–∑–º–µ—Ä –Ω–∞ –∫–ª–∞–≤–∏—à:</label>
                        <input type="number" id="keysizeX" data-key="KeySize" data-prop="x">
                        <input type="number" id="keysizeY" data-key="KeySize" data-prop="y">

                        <!-- KbdGaps -->
                        <label>–ú–µ–∂–¥—É –∫–ª–∞–≤–∏—à–∏—Ç–µ:</label>
                        <input type="number" id="kbdgapsX" data-key="KbdGaps" data-prop="x">
                        <input type="number" id="kbdgapsY" data-key="KbdGaps" data-prop="y">

                        <!-- Display (EUR) -->
                        <label>–î–∏—Å–ø–ª–µ–π: –ï–≤—Ä–æ</label>
                        <input type="number" id="displayX" data-key="Display" data-prop="x">
                        <input type="number" id="displayY" data-key="Display" data-prop="y">

                        <!-- Displaylv (BGN) -->
                        <label>–î–∏—Å–ø–ª–µ–π: –õ–µ–≤</label>
                        <input type="number" id="displaylvX" data-key="Displaylv" data-prop="x">
                        <input type="number" id="displaylvY" data-key="Displaylv" data-prop="y">

                        <!-- DisplaySize -->
                        <label>–†–∞–∑–º–µ—Ä –Ω–∞ –¥–∏—Å–ø–ª–µ–π:</label>
                        <input type="number" id="displaysizeX" data-key="DisplaySize" data-prop="x">
                        <input type="number" id="displaysizeY" data-key="DisplaySize" data-prop="y">

                        <!-- Status -->
                        <label>–ú —Å—Ç–∞—Ç—É—Å–∏:</label>
                        <input type="number" id="statusX" data-key="Status" data-prop="x">
                        <input type="number" id="statusY" data-key="Status" data-prop="y">

                        <!-- StatusSize -->
                        <label>–†–∞–∑–º–µ—Ä –Ω–∞ —Å—Ç–∞—Ç—É—Å:</label>
                        <input type="number" id="statussizeX" data-key="StatusSize" data-prop="x">
                        <input type="number" id="statussizeY" data-key="StatusSize" data-prop="y">
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button id="saveSettings" class="action-button" style="margin-right: 20px;">–ó–∞–ø–∏—Å</button>
                <button id="ovBtnSettings" class="action-button" style="margin-right: 20px;" 
                    onclick="if (!ovFlag) {placeKeys(keys, displayCoords); ovFlag = true;} else {noOverlay(); ovFlag = false;} settingsModal.style.display = 'none';">
                    –û–≤–µ—Ä–ª–µ–π</button>
                <button id="closeSettingsModalButton" class="action-button secondary">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>

    <!--h1>–¢–æ–≤–∞ –µ –ø—Ä–æ—Å—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è</h1>
  <button id="fullscreen-btn" onclick="goFullscreen()">–ù–∞ —Ü—è–ª –µ–∫—Ä–∞–Ω</button>
  <button id="exit-fullscreen-btn" onclick="exitFullscreen()" style="display:none;">–ù–æ—Ä–º–∞–ª–µ–Ω –µ–∫—Ä–∞–Ω</button-->

<script src="status-2.js"></script>
<script src="calc.js"></script>
<script src="history.js"></script>
<script src="fontcalc.js"></script>
<script>
    const rows = 5;
    const cols = 4;
    const container = document.querySelector('.calculator-container');
    const display = document.querySelector('.calculator-display');
    const displaylv = document.querySelector('.calculator-display-lv');
    var calculator = null; // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –Ω–∞ –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞
    const EXCHANGE_RATE = 1.95583;

    var screenWidth = window.innerWidth;
    var imageWidth, imageHeight, aspectRatioW, aspectRatioH;
    var imageWidthO, imageHeightO;
    var userInput = "";
    var ovFlag = false, fullscrFlag = false; // –§–ª–∞–≥ –∑–∞ –æ–≤–µ—Ä–ª–µ–π –∏ –ø—ä–ª–µ–Ω –µ–∫—Ä–∞–Ω
    var keys = [];
    var Mem = []; // –ú—è—Å—Ç–æ –∑–∞ —Å—ä—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –ø–∞–º–µ—Ç—Ç–∞
    var levMode = true; // –ù–∞—á–∞–ª–µ–Ω —Ä–µ–∂–∏–º - –ª–≤.
    var MainPoints = {};

    const MAX_HISTORY_ITEMS = 30;
    const historyButton = document.getElementById('historyButton');
    const recallButton = document.getElementById('recallButton');
    //const hModalOverlay = document.getElementById('hisModalOverlay');
    const settingsModal = document.getElementById('settingsModal');
    const historyList = document.getElementById('historyList');
    const clearHistoryButton = document.getElementById('clearHistoryButton');
    const closeHistoryModalButton = document.getElementById('closeHistoryModalButton');

    var MainPointsO = {
        Keys:   { x: 43, y: 235 },
        KeySize:{ x: 84, y: 70 },
        KbdGaps:{ x: 13, y: 13 },
        Display:{ x: 102, y: 47 },
        Displaylv:{ x: 102, y: 127 },
        DisplaySize:{ x: 310, y: 57 },
        Status: { x: -10, y: 185 },
        StatusSize: { x: 45, y: 15 }
    };

    let recallIndex = -1; // -1 means no recall started, 0 is the last item

    // New function to populate layout settings
    function populateLayoutSettings() {
      for (const key in MainPointsO) {
        if (MainPointsO.hasOwnProperty(key)) {
          const obj = MainPointsO[key];
          if (typeof obj === 'object' && obj !== null) {
            for (const prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    // Construct the ID based on the naming convention (e.g., keysX, displayY)
                    const inputId = key.toLowerCase() + prop.toUpperCase();
                    const inputElement = document.getElementById(inputId);
                    if (inputElement) {
                        inputElement.value = obj[prop];
                    } else {
                        console.warn(`Input element with ID '${inputId}' not found for MainPointsO.${key}.${prop}`);
                    }
                }
            }
          }
        }
      }
    }

    // New function to save layout settings
    function saveLayoutSettings() {
        for (const key in MainPointsO) {
            if (MainPointsO.hasOwnProperty(key)) {
                const obj = MainPointsO[key];
                if (typeof obj === 'object' && obj !== null) {
                    for (const prop in obj) {
                        if (obj.hasOwnProperty(prop)) {
                            const inputId = key.toLowerCase() + prop.toUpperCase();
                            const inputElement = document.getElementById(inputId);
                            if (inputElement && !isNaN(parseFloat(inputElement.value))) {
                                obj[prop] = parseFloat(inputElement.value);
                            }
                        }
                    }
                }
            }
        }
        localStorage.setItem('MainPointsO', JSON.stringify(MainPointsO)); // Save to localStorage
        console.log("MainPointsO updated and saved:", MainPointsO);
        // Re-calculate and position elements
        const layout = calcNewCoordinates();
        keys = layout.keys;
        displayCoords = layout.displayCoords;
        resizeFont();
    }

    function getImageSize() {
        if (calculator) {
            //console.log("–ò–∑–≤–ª–µ—á–µ–Ω –ø—ä—Ç:", calculator.src); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω–∑–æ–ª–∞—Ç–∞
            imageWidthO = calculator.naturalWidth;
            imageHeightO = calculator.naturalHeight;
            console.log("–û—Ä–∏–≥–∏–Ω–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä (1:1) –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ: W:", imageWidthO, " x H:", imageHeightO);
        } else {
            console.log("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ!");
        }
    }

    function getImageVisualSize() {
        let containerWidth = document.body.clientWidth;
        let containerHeight = document.body.clientHeight;
        if (!calculator) {
            console.error("–ì—Ä–µ—à–∫–∞: –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ.");
            return;
        }
        let aspectRatio = calculator.naturalWidth / calculator.naturalHeight;
        if (calculator.style.objectFit === "cover") {
            imageWidth = containerWidth;
            imageHeight = containerHeight;
        } else if (calculator.style.objectFit === "contain") {
            if (containerWidth / containerHeight > aspectRatio) {
                imageHeight = containerHeight;
                imageWidth = Math.round(containerHeight * aspectRatio);
                console.log("(contain) - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –µ –ø–æ-—à–∏—Ä–æ–∫–æ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∏–∑–ø–æ–ª–∑–≤–∞–º–µ –≤–∏—Å–æ—á–∏–Ω–∞—Ç–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.");
            } else {
                imageWidth = containerWidth;
                imageHeight = Math.round(containerWidth / aspectRatio);
                console.log("(contain) - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –µ –ø–æ-–≤–∏—Å–æ–∫–æ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∏–∑–ø–æ–ª–∑–≤–∞–º–µ —à–∏—Ä–∏–Ω–∞—Ç–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.");
            }
        } else {
            imageWidth = calculator.width;
            imageHeight = calculator.height;
            console.log("(no contain) - –ò–∑–ø–æ–ª–∑–≤–∞–º–µ –∑–∞–¥–∞–¥–µ–Ω–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ.");
        }
        console.log("–í–∏–∑—É–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ: W:", imageWidth, " x H:", imageHeight);
        // –ó–∞–º–µ–Ω—è–º–µ window.innerWidth —Å containerWidth
        aspectRatioW = imageWidth / imageWidthO; // aspectRatioW –µ —Å—ä–æ—Ç–Ω–æ—à–µ–Ω–∏–µ—Ç–æ –Ω–∞ —à–∏—Ä–∏–Ω–∞—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –∫—ä–º –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∞—Ç–∞ —à–∏—Ä–∏–Ω–∞
        aspectRatioH = imageHeight / imageHeightO; // aspectRatioH –µ —Å—ä–æ—Ç–Ω–æ—à–µ–Ω–∏–µ—Ç–æ –Ω–∞ –≤–∏—Å–æ—á–∏–Ω–∞—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –∫—ä–º –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∞—Ç–∞ –≤–∏—Å–æ—á–∏–Ω–∞
        // padding –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –≤ canvas, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞ —Å–µ —Ä–∞–≤–µ–Ω –¥–≤—É—Å—Ç—Ä–∞–Ω–Ω–æ
        //StartingPoint.x = ConstX * aspectRatioW + (containerWidth - imageWidth) / 2;
        //StartingPoint.y = ConstY * aspectRatioH + (containerHeight - imageHeight); // (imageHeight / calculator.naturalHeight)
        //console.log("StartingPoint.x = ", StartingPoint.x, "  StartingPoint.y = ", StartingPoint.y);
        console.log("aspectRatioW = ", aspectRatioW, "   aspectRatioH = ", aspectRatioH);
    }

    function getKeyValue(row, col) {
        const keyMap = [
            ["C", "‚Ç¨", "L", "B"],
            ["7", "8", "9", "*"],
            ["4", "5", "6", "/"],
            ["1", "2", "3", "-"],
            ["0", ",", "=", "+"]
        ];
        return keyMap[row][col];
    }

    function formatNumber(num) {
        if (isNaN(num)) return '';
        // .toFixed(2) correctly rounds to 2 decimal places and ensures two decimal digits.
        // Example: 123 -> "123.00", 123.4 -> "123.40", 123.456 -> "123.46"
        return num.toFixed(2).replace('.', ',');
    }

    function parseNumber(str) {
        if (!str) return NaN;
        return parseFloat(str.replace(',', '.'));
    }

    function convertFromLevToEur(levStr) {
        levStr = levStr.replace(/\s+/g, ''); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏—Ç–µ
        let levValue = parseNumber(levStr);
        if (isNaN(levValue)) {
            return ''; // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ —Ü–µ–ª–µ–≤–æ—Ç–æ –ø–æ–ª–µ, –∞–∫–æ –∏–∑—Ö–æ–¥–Ω–æ—Ç–æ –µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ
        } else {
            let eurValue = levValue / EXCHANGE_RATE;
            addHistoryEntry(levValue, eurValue);
            recallIndex = -1; // Reset recall index on new calculation
            adjustFontSize(levInput); // –ê–¥–∞–ø—Ç–∏—Ä–∞–º–µ —à—Ä–∏—Ñ—Ç–∞ –Ω–∞ –∏–∑—Ö–æ–¥–Ω–æ—Ç–æ –ø–æ–ª–µ
            adjustFontSize(eurInput); // –ê–¥–∞–ø—Ç–∏—Ä–∞–º–µ —à—Ä–∏—Ñ—Ç–∞ –Ω–∞ —Ü–µ–ª–µ–≤–æ—Ç–æ –ø–æ–ª–µ
            return formatNumber(eurValue);
        }
    }

    function convertFromEurToLev(eurStr) {
        eurStr = eurStr.replace(/\s+/g, ''); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏—Ç–µ
        let eurValue = parseNumber(eurStr);
        if (isNaN(eurValue)) {
            return ''; // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ —Ü–µ–ª–µ–≤–æ—Ç–æ –ø–æ–ª–µ, –∞–∫–æ –∏–∑—Ö–æ–¥–Ω–æ—Ç–æ –µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ
        } else {
            let levValue = eurValue * EXCHANGE_RATE;
            addHistoryEntry(levValue, eurValue);
            recallIndex = -1; // Reset recall index on new calculation
            adjustFontSize(levInput); // –ê–¥–∞–ø—Ç–∏—Ä–∞–º–µ —à—Ä–∏—Ñ—Ç–∞ –Ω–∞ –∏–∑—Ö–æ–¥–Ω–æ—Ç–æ –ø–æ–ª–µ
            adjustFontSize(eurInput); // –ê–¥–∞–ø—Ç–∏—Ä–∞–º–µ —à—Ä–∏—Ñ—Ç–∞ –Ω–∞ —Ü–µ–ª–µ–≤–æ—Ç–æ –ø–æ–ª–µ
            return formatNumber(levValue);
        }
    }

    function groupByThree(str, dec) { // dec - –¥–∞–ª–∏ –¥–∞ —Å–µ –¥–æ–±–∞–≤–∏ –¥–µ—Å–µ—Ç–∏—á–Ω–∞ —á–∞—Å—Ç
        if (str == null || str == "") return ""; // –ê–∫–æ –≤—Ö–æ–¥—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω
        str = formatNumber(parseNumber(str)); // –§–æ—Ä–º–∞—Ç–∏—Ä–∞–º–µ —á–∏—Å–ª–æ—Ç–æ
        let cleanedStr = str.replace(/\s+/g, ""); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏—Ç–µ
        let parts = cleanedStr.split(","); // –†–∞–∑–¥–µ–ª—è–º–µ —Ü—è–ª–∞—Ç–∞ –∏ –¥–µ—Å–µ—Ç–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç
        let wholePart = parts[0]; // –¶—è–ª–∞—Ç–∞ —á–∞—Å—Ç –æ—Ç —á–∏—Å–ª–æ—Ç–æ
        if (wholePart == "") wholePart = "0"; // –ê–∫–æ –Ω—è–º–∞ —Ü—è–ª–∞ —á–∞—Å—Ç, –≤—Ä—ä—â–∞–º–µ –ø—Ä–∞–∑–µ–Ω –Ω–∏–∑
        let decimalPart = parts.length > 1 ? "," + parts[1] : ""; // –î–µ—Å–µ—Ç–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç (–∞–∫–æ —è –∏–º–∞)
        let result = [];
        for (let i = wholePart.length; i > 0; i -= 3) {
            let start = Math.max(i - 3, 0);
            result.unshift(wholePart.slice(start, i)); // –ó–∞–ø–∞–∑–≤–∞–º–µ –ø—Ä–∞–≤–∏–ª–Ω–∏—è —Ä–µ–¥
        }
        if (dec) if (decimalPart == "" || decimalPart == ",") decimalPart = ",00"
        else if (decimalPart.length == 2) decimalPart += "0"; // –ê–∫–æ –∏–º–∞ —Å–∞–º–æ –µ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞ —Å–ª–µ–¥ –∑–∞–ø–µ—Ç–∞—è—Ç–∞, –¥–æ–±–∞–≤—è–º–µ –Ω—É–ª–∞
        return result.join(" ") + decimalPart; // –°–≤—ä—Ä–∑–≤–∞–º–µ –≥—Ä—É–ø–∏—Ç–µ –∏ –¥–æ–±–∞–≤—è–º–µ –¥–µ—Å–µ—Ç–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç
    }

    function appendNumber(value) {
        const display = document.getElementById('eurInput'); // –¢–æ–≤–∞ –≤–µ—á–µ –µ div
        const displaylv = document.getElementById('levInput');
        if (value === "‚Ç¨") { 
            historyOpen();
            return;
        }
        if (value === "L") {
            value = "";
            clearCurrentSessionHistory();
            inputSessionId = Date.now(); // –Ω–æ–≤–∞ —Å–µ—Å–∏—è
            levMode = !levMode;
            const newActiveValue = levMode
                ? displaylv.textContent
                : display.textContent; // –ü—Ä–æ–º–µ–Ω–µ–Ω–æ –∑–∞ div
            userInput = newActiveValue
                .replace(/\s/g, '') // –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏
                .replace(/,/g, '.'); // –Ω–æ—Ä–º–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ –¥–µ—Å–µ—Ç–∏—á–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª
            console.log("–ü—Ä–æ–º–µ–Ω–µ–Ω —Ä–µ–∂–∏–º - userInput:", userInput);
            // return; // –ø–æ –∂–µ–ª–∞–Ω–∏–µ: —Å–ø–∏—Ä–∞–π —Ç—É–∫, –∞–∫–æ –Ω–µ –∏—Å–∫–∞—à –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–µ–¥ –ø—Ä–µ–≤–∫–ª—é—á–≤–∞–Ω–µ
        }
        if (value === "C") {
            display.textContent = ""; // –ü—Ä–æ–º–µ–Ω–µ–Ω–æ –∑–∞ div
            displaylv.textContent = "";
            userInput = "";
        } else if (value === "B") {
            userInput = userInput.slice(0, -1);
        } else if (value === "=") {
            clearCurrentSessionHistory();
            inputSessionId = Date.now(); // –Ω–æ–≤–∞ —Å–µ—Å–∏—è        
            if (!/[+\-*/]$/.test(userInput) && userInput.length > 0) {
                try {
                    let formattedInput = userInput.replace(/,/g, '.');
                    let result = eval(formattedInput);
                    result = parseFloat(result).toFixed(2);
                    userInput = result.toString().replace(/\./g, ',');
                } catch (error) {
                    console.error("–ì—Ä–µ—à–∫–∞ –≤ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è—Ç–∞", error);
                }
            }
        } else {
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ –¥–≤–∞ –∑–Ω–∞–∫–∞ —Å–ª–µ–¥ –∑–∞–ø–µ—Ç–∞—è—Ç–∞ —Å–∞–º–æ –∑–∞ —Ç–µ–∫—É—â–æ—Ç–æ —á–∏—Å–ª–æ
            const lastOperatorIndex = Math.max(
                userInput.lastIndexOf('+'),
                userInput.lastIndexOf('-'),
                userInput.lastIndexOf('*'),
                userInput.lastIndexOf('/')
            );
            const currentNumber = lastOperatorIndex === -1 
                ? userInput 
                : userInput.slice(lastOperatorIndex + 1);
            // –ù–µ –¥–æ–ø—É—Å–∫–∞–º–µ –ø–æ–≤–µ—á–µ –æ—Ç –µ–¥–Ω–∞ –∑–∞–ø–µ—Ç–∞—è –≤ —Ç–µ–∫—É—â–æ—Ç–æ —á–∏—Å–ª–æ
            if (value === "," && currentNumber.includes(',')) return;
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞ –¥–≤–∞ –∑–Ω–∞–∫–∞ —Å–ª–µ–¥ –∑–∞–ø–µ—Ç–∞—è—Ç–∞ —Å–∞–º–æ –∑–∞ —Ç–µ–∫—É—â–æ—Ç–æ —á–∏—Å–ª–æ
            if ((/\d/.test(value) || value === ",") && currentNumber.includes(',')) {
                const decimalPart = currentNumber.split(',')[1] || "";
                if (decimalPart.length >= 2) return;
            }
            // –ù–µ –¥–æ–ø—É—Å–∫–∞–º–µ –∞—Ä–∏—Ç–º–µ—Ç–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ –∏–∑—Ä–∞–∑–∞ –∏–ª–∏ —Å–ª–µ–¥ –¥—Ä—É–≥ –æ–ø–µ—Ä–∞—Ç–æ—Ä
            if (/[+\-*/]/.test(value) && (userInput.length === 0 || /[+\-*/]$/.test(userInput))) return;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—Ç–æ—Ä–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä
            let match = userInput.match(/([\d,]+[+\-*/])([\d,]+)/);
            if (match && /[+\-*/]/.test(value)) {
                try {
                    let formattedInput = match[0].replace(/,/g, '.');
                    let result = eval(formattedInput);
                    userInput = parseFloat(result).toFixed(2).replace(/\./g, ',') + value;
                } catch (error) {
                    console.error("–ì—Ä–µ—à–∫–∞ –≤ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è—Ç–∞", error);
                }
            } else {
                userInput += value;
            }
        }
        const formattedUserInput = userInput
        .replace(/\*/g, "√ó")
        .replace(/\//g, "√∑");

        if (levMode) {
            displaylv.style.backgroundColor = "rgba(201, 255, 5, 0.3)";
            display.style.backgroundColor = "rgba(201, 255, 5, 0)";
            displaylv.textContent = /[+\-*/]/.test(userInput) // levInput –æ—Å—Ç–∞–≤–∞ input
                ? formattedUserInput
                : groupByThree(userInput, false);
            display.textContent = /[+\-*/]/.test(userInput) // –ü—Ä–æ–º–µ–Ω–µ–Ω–æ –∑–∞ div
                ? convertFromLevToEur(userInput, true)
                : groupByThree(convertFromLevToEur(userInput, true));
        } else {
            display.style.backgroundColor = "rgba(201, 255, 5, 0.3)";
            displaylv.style.backgroundColor = "rgba(201, 255, 5, 0)";
            display.textContent = /[+\-*/]/.test(userInput) // –ü—Ä–æ–º–µ–Ω–µ–Ω–æ –∑–∞ div
                ? formattedUserInput
                : groupByThree(userInput, false);
            displaylv.textContent = /[+\-*/]/.test(userInput)
                ? convertFromEurToLev(userInput, true)
                : groupByThree(convertFromEurToLev(userInput, true));
        }
       console.log("userInput = ", userInput);
    }

    function getKeyColumnIndex(key) {
    const rect = calculator.getBoundingClientRect();
    // const scaleX = rect.width / imageWidthO;
    const colWidth = MainPoints.KeySize.x + MainPoints.KbdGaps.x;
    const relativeX = (key.x - rect.left - MainPoints.Keys.x) / colWidth;
    return Math.round(relativeX+1); // –í—Ä—ä—â–∞ 1, 2, 3 –∏–ª–∏ 4
    }

    document.addEventListener("click", function(event) {
        const rect = calculator.getBoundingClientRect();
        const scaleX = rect.width / imageWidthO;
        const scaleY = rect.height / imageHeightO;
        const keyWidth = MainPointsO.KeySize.x * scaleX;
        const keyHeight = MainPointsO.KeySize.y * scaleY;
        keys.forEach(key => {
            const withinX = event.clientX >= key.x && event.clientX <= key.x + keyWidth;
            const withinY = event.clientY >= key.y && event.clientY <= key.y + keyHeight;
            if (withinX && withinY) {
                if (event.ctrlKey && key.value === '‚Ç¨') {
                    if (ovFlag) {noOverlay(); ovFlag = false;}
                    settingsModal.style.display = 'flex';
                    populateLayoutSettings();
                } else if (event.ctrlKey && isMemoryKey(key.value)) {
                    const col = getKeyColumnIndex(key);
                    executeMemoryAction(key.value, col);
                    console.log("–ù–∞—Ç–∏—Å–Ω–∞—Ç–æ:", key.value, "‚Üí –ö–æ–ª–æ–Ω–∞:", col);
                } else {
                    appendNumber(key.value);
                }
            }
        });
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–ª–∏–∫–æ–≤–µ –≤—ä—Ä—Ö—É —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∏—Ç–µ (—Å–∞–º–æ –∑–∞ —Å–ª–æ—Ç–æ–≤–µ 1, 2, 3)
        for (let i = 1; i <= 3; i++) {
            const statusEl = document.getElementById(`statusArea${i}`);
            if (statusEl && getComputedStyle(statusEl).opacity > 0) {
                const statusRect = statusEl.getBoundingClientRect();
                if (event.clientX >= statusRect.left && event.clientX <= statusRect.right &&
                    event.clientY >= statusRect.top && event.clientY <= statusRect.bottom)  {
                    if (event.ctrlKey) {
                    memoryShow(i);
                    console.log(`Ctrl+–ö–ª–∏–∫ –≤—ä—Ä—Ö—É —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∞ ${i} –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç.`);
                    } else {
                    memoryRecall(i);
                    console.log(`–ö–ª–∏–∫–Ω–∞—Ç–æ –≤—ä—Ä—Ö—É –≤–∏–¥–∏–º–∞ —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∞ ${i} –∑–∞ –∏–∑–≤–∏–∫–≤–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç.`);
                    }// –ò–∑–≤–∏–∫–≤–∞–º–µ –ø–∞–º–µ—Ç—Ç–∞ –∑–∞ —Å—ä–æ—Ç–≤–µ—Ç–Ω–∏—è —Å–ª–æ—Ç
                    break; // –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–º–µ —Ü–∏–∫—ä–ª–∞, –∞–∫–æ –µ –æ–±—Ä–∞–±–æ—Ç–µ–Ω –∫–ª–∏–∫
                }
            }
        }
    });

    // üß© –£–ª–∞–≤—è –¥–µ—Å–µ–Ω –∫–ª–∏–∫ –∏–ª–∏ –¥—ä–ª—ä–≥ —Ç–∞–ø (–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ –º–µ–Ω—é)
    document.addEventListener("contextmenu", function(event) {
        event.preventDefault(); // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞ –ø–æ—è–≤–∞—Ç–∞ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä –º–µ–Ω—é—Ç–æ
        const rect = calculator.getBoundingClientRect();
        const scaleX = rect.width / imageWidthO;
        const scaleY = rect.height / imageHeightO;
        const keyWidth = MainPointsO.KeySize.x * scaleX;
        const keyHeight = MainPointsO.KeySize.y * scaleY;
        keys.forEach(key => {
            if (event.clientX >= key.x && event.clientX <= key.x + keyWidth &&
                event.clientY >= key.y && event.clientY <= key.y + keyHeight) {
                // üëâ –î–æ–±–∞–≤—è–º–µ —É—Å–ª–æ–≤–∏–µ—Ç–æ –æ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∏—è —à–æ—Ä—Ç–∫—ä—Ç
                if (key.value === '+') {
                    if (!fullscrFlag) goFullscreen()
                    else exitFullscreen();
                    fullscrFlag = !fullscrFlag; //@@
                } else if (key.value === '‚Ç¨') {
                    if (ovFlag) {noOverlay(); ovFlag = false;}
                    settingsModal.style.display = 'flex';
                    populateLayoutSettings();
                } else if (isMemoryKey(key.value)) {
                    const col = getKeyColumnIndex(key);
                    executeMemoryAction(key.value, col);
                }
            }
        });
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–ª–∏–∫–æ–≤–µ –≤—ä—Ä—Ö—É —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∏—Ç–µ (—Å–∞–º–æ –∑–∞ —Å–ª–æ—Ç–æ–≤–µ 1, 2, 3)
        for (let i = 1; i <= 3; i++) {
            const statusEl = document.getElementById(`statusArea${i}`);
            if (statusEl && getComputedStyle(statusEl).opacity > 0) {
                const statusRect = statusEl.getBoundingClientRect();
                if (event.clientX >= statusRect.left && event.clientX <= statusRect.right &&
                    event.clientY >= statusRect.top && event.clientY <= statusRect.bottom) {
                    memoryShow(i); // –ò–∑–≤–∏–∫–≤–∞–º–µ –ø–∞–º–µ—Ç—Ç–∞ –∑–∞ —Å—ä–æ—Ç–≤–µ—Ç–Ω–∏—è —Å–ª–æ—Ç
                    console.log(`–ó–∞–¥—ä—Ä–∂–∞–Ω–æ –≤—ä—Ä—Ö—É —Å—Ç–∞—Ç—É—Å –∑–æ–Ω–∞ ${i} –∑–∞ –∏–∑–≤–∏–∫–≤–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç.`);
                    break; // –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–º–µ —Ü–∏–∫—ä–ª–∞, –∞–∫–æ –µ –æ–±—Ä–∞–±–æ—Ç–µ–Ω –∫–ª–∏–∫
                }
            }
        }
    });

    document.getElementById('saveSettings').addEventListener('click', function() {
        saveLayoutSettings();
        settingsModal.style.display = 'none'; // Close modal after saving
    });

    document.getElementById('closeSettingsModalButton').addEventListener('click', function() {
        settingsModal.style.display = 'none'; // Close modal without saving
    });

    window.addEventListener("load", async function () {
        try {
            calculator = document.querySelector(".calculator-img");
            // Load saved MainPointsO from localStorage
            const savedMainPointsO = localStorage.getItem('MainPointsO');
            if (savedMainPointsO) {
                MainPointsO = JSON.parse(savedMainPointsO);
                console.log("Loaded MainPointsO from localStorage:", MainPointsO);
            } else {
                console.log("No saved MainPointsO found in localStorage.");
            }

            // –û—Å–Ω–æ–≤–Ω–∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è
            getImageSize();
            getImageVisualSize();
            scaleMainPoints(aspectRatioW, aspectRatioH);
            const layout = calcNewCoordinates(); //@@ calculator, imageWidthO, imageHeightO
            keys = layout.keys; // This needs to be updated after MainPointsO is potentially loaded
            displayCoords = layout.displayCoords;
            displayCoords = layout.displayCoords;
            resizeFont();
            appendNumber("C");
        } catch (err) {
            console.warn("‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:", err);
        }
        // –í–∏–∑—É–∞–ª–µ–Ω –µ—Ñ–µ–∫—Ç
        const img = document.querySelector(".calculator-img");
        if (img) {
            img.classList.add("glow");
            img.addEventListener("animationend", () => {
                img.classList.remove("glow");
            }, { once: true });
            // Populate layout settings fields when the page loads (after MainPointsO is set)
            populateLayoutSettings();
            const settingsButton = document.getElementById('settingsButton'); // Assuming this button exists
            if (settingsButton) {
                settingsButton.addEventListener('click', populateLayoutSettings); // Populate when modal is opened
            }
        }
        // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        document.body.classList.add("ready");
    });

    // –°–ª–µ–¥–µ–Ω–µ –Ω–∞ –ø—Ä–µ–æ—Ä–∞–∑–º–µ—Ä—è–≤–∞–Ω–µ—Ç–æ –Ω–∞ –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞
    window.addEventListener("resize", function (e) {
        getImageVisualSize();
        scaleMainPoints(aspectRatioW, aspectRatioH);
        // imageWidth = document.body.clientWidth;
        // imageHeight = document.body.clientHeight;
        // keys = getKeyCoordinates(imageWidth, imageHeight);
        const layout = calcNewCoordinates(); //@@ calculator, imageWidthO, imageHeightO
        keys = layout.keys;
        displayCoords = layout.displayCoords;
        resizeFont();
    })

    document.addEventListener('DOMContentLoaded', () => {
        // –ó–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –º–æ–¥–∞–ª —Å ESC –∫–ª–∞–≤–∏—à
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.key === 'Esc') {
                historyModal.style.display = 'none';
                settingsModal.style.display = 'none';
            }
        });
        loadHistory();
        // Initial font size adjustment for both fields based on their (potentially empty) content
        adjustFontSize(levInput);
        adjustFontSize(eurInput);
    });

    function goFullscreen() {
      const el = document.documentElement;
      if (el.requestFullscreen) {
        el.requestFullscreen();
      } else if (el.webkitRequestFullscreen) {
        el.webkitRequestFullscreen();
      } else if (el.msRequestFullscreen) {
        el.msRequestFullscreen();
      }
    }

    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }

    // –ü–æ–∫–∞–∑–≤–∞–Ω–µ/—Å–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –±—É—Ç–æ–Ω–∏—Ç–µ —Å–ø–æ—Ä–µ–¥ —Ä–µ–∂–∏–º–∞
    //document.addEventListener('fullscreenchange', toggleFullscreenButtons);
    //document.addEventListener('webkitfullscreenchange', toggleFullscreenButtons);
    //document.addEventListener('msfullscreenchange', toggleFullscreenButtons);

    /* function toggleFullscreenButtons() {
      const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
      document.getElementById('fullscreen-btn').style.display = isFullscreen ? 'none' : 'inline-block';
      document.getElementById('exit-fullscreen-btn').style.display = isFullscreen ? 'inline-block' : 'none';
    } */

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      //e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('install');
      btn.style.display = 'block';
      btn.addEventListener('click', () => {
        deferredPrompt.prompt();
      });
    });
  </script>

</body>
</html>
