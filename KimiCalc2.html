<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<title>EUR ‚Üî BGN Calculator</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#1e293b"/>
<link rel="manifest" href="data:application/manifest+json,{
  \"name\":\"EUR‚ÜîBGN Calculator\",\"short_name\":\"EUR‚ÜîBGN\",
  \"icons\":[{\"src\":\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%231e293b'/%3E%3Ctext x='256' y='256' font-size='240' fill='white' text-anchor='middle' dominant-baseline='middle'%3E‚Ç¨%3C/text%3E%3C/svg%3E\",\"sizes\":\"512x512\",\"type\":\"image/svg+xml\"}],
  \"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#ffffff\"
}">
<style>
:root{
  --bg:#ffffff;--page:#e5e7eb;--calc:#ffffff;--text:#111827;
  --btn:#e2e8f0;--btn-op:#cbd5e1;--btn-c:#ef4444;--btn-del:#f97316;
  --accent:#3b82f6;--font:1.5rem;--dec:2;--rate:1.95583;
}
[data-theme=dark]{
  --bg:#111827;--page:#0f172a;--calc:#1e293b;--text:#f9fafb;
  --btn:#374151;--btn-op:#4b5563;--btn-c:#dc2626;--btn-del:#ea580c;
}
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
body{margin:0;background:var(--page);display:flex;justify-content:center;align-items:center;min-height:100vh}
#calcWrap{
  background:var(--calc);border:6px solid var(--accent);border-radius:12px;
  padding:1rem;box-shadow:0 0 20px rgba(0,0,0,.15);
}
#calc{width:100%;max-width:380px}
#expr,#result{height:3rem;font-size:var(--font);text-align:right;padding:.5rem;border-radius:.5rem;background:var(--bg);margin-bottom:.25rem;overflow:hidden}
#result{font-weight:bold;font-size:calc(var(--font)*1.3)}
button{padding:.75rem;border:none;border-radius:.5rem;font-size:calc(var(--font)*.9);
  background:var(--btn);color:var(--text);cursor:pointer;
  box-shadow:0 4px #0003;transform:translateY(-2px);transition:.1s}
button:active{transform:translateY(1px);box-shadow:0 2px #0002}
button.op{background:var(--btn-op)}
button.c{background:var(--btn-c)}
button.del{background:var(--btn-del)}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-top:.5rem}
.fullBtn{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin:.5rem 0}
#settings,#history{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--calc);padding:1rem;z-index:9;display:none;flex-direction:column;gap:.5rem;overflow-y:auto}
#settings h2,#history h2{margin:.2rem 0 .5rem}
#historyList button{display:block;width:100%;text-align:left;margin-bottom:.25rem;padding:.4rem}
label{display:flex;justify-content:space-between;align-items:center}
input[type=range]{width:50%}
input[type=color]{width:30px;height:30px;border:none;border-radius:4px}
#themeToggle{cursor:pointer;font-size:1.5rem}
</style>
</head>
<body>
<div id="calcWrap">
  <div id="calc">
    <div id="expr"></div>
    <div id="result">0</div>
    <div class="fullBtn">
      <button onclick="convert('EUR')">‚Ç¨ ‚Üí –ª–≤</button>
      <button onclick="convert('BGN')">–ª–≤ ‚Üí ‚Ç¨</button>
    </div>
    <div class="grid">
      <button onclick="act('(')">(</button><button onclick="act(')')">)</button>
      <button onclick="act('C')" class="c">C</button><button onclick="act('‚å´')" class="del">‚å´</button>
      <button onclick="act('7')">7</button><button onclick="act('8')">8</button><button onclick="act('9')">9</button><button onclick="act('/')" class="op">/</button>
      <button onclick="act('4')">4</button><button onclick="act('5')">5</button><button onclick="act('6')">6</button><button onclick="act('*')" class="op">√ó</button>
      <button onclick="act('1')">1</button><button onclick="act('2')">2</button><button onclick="act('3')">3</button><button onclick="act('-')" class="op">-</button>
      <button onclick="act('0')">0</button><button onclick="act(',')">,</button><button onclick="act('¬±')">¬±</button><button onclick="act('+')" class="op">+</button>
      <button onclick="act('%')">%</button><button onclick="toggleHistory()">üìú</button><button onclick="toggleSettings()">‚öôÔ∏è</button><button onclick="act('=')" class="op">=</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settings">
  <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span id="themeToggle" onclick="toggleTheme()">üåû</span></h2>
  <label>–ö—É—Ä—Å ‚Ç¨‚Üí–ª–≤
    <input type="number" step="0.00001" id="rateInput">
  </label>
  <label>–î–µ—Å–µ—Ç–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ <span id="decVal">2</span>
    <input type="range" min="0" max="5" value="2" id="decRange">
  </label>
  <label>–¶–≤—è—Ç –Ω–∞ —Ñ–æ–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
    <input type="color" id="bgColor">
  </label>
  <label>–¶–≤—è—Ç –Ω–∞ –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞
    <input type="color" id="calcColor">
  </label>
  <label>–¶–≤—è—Ç –Ω–∞ –±—É—Ç–æ–Ω–∏—Ç–µ
    <input type="color" id="btnColor">
  </label>
  <label>–¶–≤—è—Ç –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏—Ç–µ –±—É—Ç–æ–Ω–∏
    <input type="color" id="opColor">
  </label>
  <button onclick="toggleSettings()">–ó–∞—Ç–≤–æ—Ä–∏</button>
</div>

<!-- History Modal -->
<div id="history">
  <h2>–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏ 30)</h2>
  <div id="historyList"></div>
  <button onclick="toggleHistory()">–ó–∞—Ç–≤–æ—Ä–∏</button>
</div>

<script>
/* ---------- CONFIG ---------- */
let RATE = 1.95583;
const MAX_HIST = 30;
let expr = '', dec = 2, memory = 0;

/* ---------- DB ---------- */
const dbName='calcDB',store='history';
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(dbName,1);
    req.onupgradeneeded=()=>req.result.createObjectStore(store,{keyPath:'id',autoIncrement:true});
    req.onerror=()=>reject(req.error);
    req.onsuccess=()=>resolve(req.result);
  });
}
async function addHist(item){
  const db=await openDB();
  const tx=db.transaction(store,'readwrite');
  tx.objectStore(store).add(item);
  tx.objectStore(store).openCursor(null,'prev').onsuccess=e=>{
    let c=e.target.result,advance=c.value.id-MAX_HIST;
    if(advance>0) tx.objectStore(store).delete(advance);
  };
}
async function getHistory(){
  const db=await openDB();
  return new Promise(res=>{
    const arr=[];
    db.transaction(store).objectStore(store).openCursor(null,'prev').onsuccess=e=>{
      const c=e.target.result;
      if(c){arr.push(c.value);c.continue();}else res(arr);
    };
  });
}

/* ---------- ACTIONS ---------- */
function act(k){
  if(k==='C'){expr='';upd();return;}
  if(k==='‚å´'){expr=expr.slice(0,-1);upd();return;}
  if(k==='¬±'){expr=expr.startsWith('-')?expr.slice(1):'-'+expr;upd();return;}
  if(k===','){expr+=',';upd();return;}
  if(k==='='){calc();return;}
  if(k==='%'){
    try{expr=String(parseFloat(expr.replace(',','.'))/100);}catch{expr='Error';}
    upd();return;
  }
  expr+=k;upd();
}
function calc(){
  try{
    const res=Function('"use strict";return ('+expr.replace(/,/g,'.')+')')();
    const txt=expr.replace(',','.')+' = '+format(res);
    addHist({expr:txt,res});
    expr=String(res).replace('.',',');upd();
  }catch{result.textContent='Error';}
}
function upd(){
  exprDisp.textContent=expr||'0';
  result.textContent=format(parseFloat(expr.replace(',','.')||0));
}
function format(n){
  return n.toLocaleString('bg-BG',{minimumFractionDigits:0,maximumFractionDigits:dec});
}

/* ---------- CONVERT ---------- */
function convert(dir){
  if(!expr) return;
  const val=parseFloat(expr.replace(',','.'));
  if(isNaN(val)) return;
  let res;
  if(dir==='EUR') res=val*RATE;
  else res=val/RATE;
  expr=String(res).replace('.',',');upd();
}

/* ---------- MEMORY ---------- */
function mem(op){
  const val=parseFloat(expr.replace(',','.'))||0;
  if(op==='+')memory+=val;
  if(op==='-')memory-=val;
  if(op==='R'){expr=String(memory).replace('.',',');upd();}
}
window.addEventListener('keydown',e=>{
  if(e.ctrlKey){
    if(e.key==='1'||e.key==='4'||e.key==='7') mem('+');
    if(e.key==='2'||e.key==='5'||e.key==='8') mem('-');
    if(e.key==='3'||e.key==='6'||e.key==='9') mem('R');
    if(e.key==='Backspace'){memory=0;e.preventDefault();}
  }
});
document.querySelectorAll('.grid button').forEach(btn=>{
  let timer;
  btn.addEventListener('pointerdown',e=>{
    const k=e.target.textContent;
    timer=setTimeout(()=>{
      if(k==='7'||k==='4'||k==='1') mem('+');
      if(k==='8'||k==='5'||k==='2') mem('-');
      if(k==='9'||k==='6'||k==='3') mem('R');
      if(k==='‚å´') memory=0;
    },500);
  });
  btn.addEventListener('pointerup',()=>clearTimeout(timer));
  btn.addEventListener('pointerleave',()=>clearTimeout(timer));
});

/* ---------- UI ---------- */
const exprDisp=document.getElementById('expr');
const result=document.getElementById('result');
function toggleSettings(){toggle('settings');loadSettings();}
function toggleHistory(){toggle('history');loadHistory();}
function toggle(id){
  const el=document.getElementById(id);
  el.style.display=el.style.display==='flex'?'none':'flex';
}
function loadSettings(){
  document.getElementById('rateInput').value=RATE;
  document.getElementById('decRange').value=dec;
  document.getElementById('decVal').textContent=dec;
  document.getElementById('bgColor').value=getComputedStyle(document.documentElement).getPropertyValue('--page').trim();
  document.getElementById('calcColor').value=getComputedStyle(document.documentElement).getPropertyValue('--calc').trim();
  document.getElementById('btnColor').value=getComputedStyle(document.documentElement).getPropertyValue('--btn').trim();
  document.getElementById('opColor').value=getComputedStyle(document.documentElement).getPropertyValue('--btn-op').trim();
}
document.getElementById('rateInput').addEventListener('change',e=>{
  RATE=parseFloat(e.target.value);localStorage.setItem('rate',RATE);
});
document.getElementById('decRange').addEventListener('input',e=>{
  dec=+e.target.value;localStorage.setItem('dec',dec);
  document.getElementById('decVal').textContent=dec;upd();
});
document.getElementById('bgColor').addEventListener('input',e=>{
  document.documentElement.style.setProperty('--page',e.target.value);
  localStorage.setItem('bgColor',e.target.value);
});
document.getElementById('calcColor').addEventListener('input',e=>{
  document.documentElement.style.setProperty('--calc',e.target.value);
  localStorage.setItem('calcColor',e.target.value);
});
document.getElementById('btnColor').addEventListener('input',e=>{
  document.documentElement.style.setProperty('--btn',e.target.value);
  localStorage.setItem('btnColor',e.target.value);
});
document.getElementById('opColor').addEventListener('input',e=>{
  document.documentElement.style.setProperty('--btn-op',e.target.value);
  localStorage.setItem('opColor',e.target.value);
});
function toggleTheme(){
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const newTheme=isDark?'light':'dark';
  document.documentElement.setAttribute('data-theme',newTheme);
  localStorage.setItem('theme',newTheme);
  document.getElementById('themeToggle').textContent=isDark?'üåû':'üåô';
}
function loadHistory(){
  getHistory().then(list=>{
    historyList.innerHTML='';
    list.forEach(h=>{
      const btn=document.createElement('button');
      btn.textContent=h.expr;
      btn.onclick=()=>{expr=String(h.res).replace('.',',');upd();toggleHistory();};
      historyList.appendChild(btn);
    });
  });
}

/* ---------- INIT ---------- */
window.addEventListener('load',()=>{
  if(localStorage.theme){
    document.documentElement.setAttribute('data-theme',localStorage.theme);
    document.getElementById('themeToggle').textContent=localStorage.theme==='dark'?'üåô':'üåû';
  }
  if(localStorage.dec) dec=+localStorage.dec;
  if(localStorage.rate) RATE=parseFloat(localStorage.rate);
  if(localStorage.bgColor) document.documentElement.style.setProperty('--page',localStorage.bgColor);
  if(localStorage.calcColor) document.documentElement.style.setProperty('--calc',localStorage.calcColor);
  if(localStorage.btnColor) document.documentElement.style.setProperty('--btn',localStorage.btnColor);
  if(localStorage.opColor) document.documentElement.style.setProperty('--btn-op',localStorage.opColor);
  upd();
});
document.addEventListener('keydown',e=>{
  const k=e.key;
  if(/[0-9+\-*/(),]/.test(k)) act(k==='.'?',':k);
  if(k==='Enter') act('=');
  if(k==='Backspace'&&!e.ctrlKey) act('‚å´');
  if(k==='Delete') act('C');
});
</script>
</body>
</html>